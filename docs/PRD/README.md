# Open436 论坛系统 - PRD 模块划分

## 文档说明

本文档从**后端架构视角**对 Open436 计算机交流社区项目进行模块划分，旨在为后端开发提供清晰的系统架构指导。每个模块对应独立的业务领域和数据模型，具备明确的职责边界和接口定义。

---

## 模块总览

基于业务功能和数据模型的内聚性，系统划分为以下 **7 个核心后端模块**：

| 模块编号 | 模块名称       | 核心职责                             | 主要数据实体                |
| -------- | -------------- | ------------------------------------ | --------------------------- |
| **M1**   | 认证与授权模块 | 用户身份认证、权限控制、会话管理     | User, Role, Permission      |
| **M2**   | 用户管理模块   | 用户信息管理、个人资料、用户统计数据 | UserProfile, UserStatistics |
| **M3**   | 内容管理模块   | 帖子的创建、编辑、删除、状态管理     | Post, PostVersion           |
| **M4**   | 评论与互动模块 | 回复、点赞、收藏等社交互动功能       | Reply, Like, Favorite       |
| **M5**   | 板块管理模块   | 论坛板块的组织与管理                 | Section                     |
| **M6**   | 搜索与索引模块 | 全文搜索、内容检索                   | SearchLog                   |
| **M7**   | 文件存储模块   | 图片上传、文件管理、资源访问         | FileUpload                  |

> 📝 **说明**：管理后台由前端页面实现，通过调用各模块的管理员接口完成管理功能，无需独立的后端模块。

---

## 模块详细说明

### M1 - 认证与授权模块 (Authentication & Authorization)

**核心职责：**

- 用户身份认证（用户名/密码验证）
- JWT Token 生成与验证
- 基于角色的权限控制（RBAC）
- 会话管理与安全防护（防暴力破解、记住登录）
- **仅负责认证凭据与权限数据，不涉及用户业务信息**

**主要功能点：**

- 用户登录/登出
- Token 刷新机制
- 权限验证中间件
- 登录失败次数限制
- 密码加密存储（BCrypt）
- 角色与权限分配

**数据实体：**

- `users_auth` - 用户认证表（用户名、密码哈希、状态）
- `roles` - 角色表
- `permissions` - 权限表
- `role_permissions` - 角色权限关联表
- `user_roles` - 用户角色关联表

> 💡 **MVP 简化**：暂不实现会话管理表和登录尝试记录表，采用纯 JWT 无状态认证。后期可根据需要扩展。

**对外接口：**

- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `POST /api/auth/refresh` - 刷新 Token
- `GET /api/auth/verify` - 验证 Token 有效性
- `GET /api/auth/permissions` - 获取当前用户权限

**设计原则：**

> ⚠️ **职责边界**：本模块仅处理认证凭据（用户名、密码）、角色权限、会话管理等安全相关数据，不涉及用户的昵称、头像、简介等业务信息。这些业务信息由 M2 用户管理模块负责，避免认证逻辑与业务逻辑耦合。

---

### M2 - 用户管理模块 (User Management)

**核心职责：**

- 用户业务信息的 CRUD 操作
- 个人资料管理（昵称、头像、简介）
- 用户行为记录（发帖、回复历史）
- 用户数据聚合与展示
- **仅负责用户业务数据，不涉及认证凭据与权限**

**主要功能点：**

- 创建用户资料（配合 M1 创建认证账号）
- 编辑用户资料（昵称、头像、简介）
- 用户个人主页数据聚合
- 用户活动历史查询
- 用户统计数据（发帖数、回复数等）

**数据实体：**

- `users_profile` - 用户资料表（昵称、头像、简介等）
- `user_statistics` - 用户统计数据表（发帖数、回复数、获赞数等）

> 💡 **MVP 简化**：暂不实现用户活动记录表和个性化设置表。用户历史可直接查询 posts/replies 表，个性化设置使用系统默认值。

**对外接口：**

- `GET /api/users/:id` - 获取用户完整信息（资料 + 统计数据）
- `PUT /api/users/:id/profile` - 更新用户资料
- `POST /api/users` - 创建用户（管理员，需调用 M1 创建认证账号）
- `GET /api/users/:id/posts` - 获取用户发帖历史（分页）
- `GET /api/users/:id/replies` - 获取用户回复历史（分页）

> 📝 **接口说明**：
>
> - `GET /api/users/:id` 返回完整用户信息，包含 profile 和 statistics，减少前端请求次数
> - 用户启用/禁用功能由 M1 的 `PUT /api/auth/users/:id/status` 接口负责

**与 M1 的协作：**

> 🔗 **模块协作**：
>
> - 创建用户时：M1 创建认证账号（users_auth） → M2 创建用户资料（users_profile）
> - 修改密码：由 M1 负责，M2 不涉及
> - 启用/禁用账号：由 M1 修改 users_auth.status，M2 根据状态控制业务访问
> - 用户信息展示：M2 通过 user_id 关联 M1 的认证数据（如用户名）

**设计原则：**

> ⚠️ **职责边界**：本模块不存储和处理任何认证相关的敏感信息（密码、Token、权限），仅管理用户的业务属性和行为数据。这样可以确保修改用户资料时不会影响认证逻辑，降低安全风险。

---

### M3 - 内容管理模块 (Content Management)

**核心职责：**

- 帖子的完整生命周期管理
- 帖子状态控制（草稿、发布、置顶、删除）
- 帖子版本管理（编辑历史）
- 内容审核与管理

**主要功能点：**

- 发布帖子（Markdown 支持）
- 编辑帖子
- 删除帖子（软删除）
- 置顶/取消置顶
- 帖子列表查询（分页、排序、筛选）
- 帖子详情获取
- 浏览量统计

**数据实体：**

- `posts` - 帖子主表
- `post_versions` - 帖子版本历史表
- `post_views` - 浏览记录表

**对外接口：**

- `POST /api/posts` - 创建帖子
- `GET /api/posts` - 获取帖子列表
- `GET /api/posts/:id` - 获取帖子详情
- `PUT /api/posts/:id` - 编辑帖子
- `DELETE /api/posts/:id` - 删除帖子
- `PUT /api/posts/:id/pin` - 置顶帖子（管理员）
- `PUT /api/posts/:id/unpin` - 取消置顶（管理员）
- `POST /api/posts/:id/view` - 记录浏览

---

### M4 - 评论与互动模块 (Comment & Interaction)

**核心职责：**

- 帖子回复管理
- 点赞功能
- 收藏功能
- 互动数据统计

**主要功能点：**

- 发布回复
- 编辑回复（5 分钟内）
- 删除回复
- 点赞/取消点赞
- 收藏/取消收藏
- 获取用户收藏列表
- 互动数据聚合

**数据实体：**

- `replies` - 回复表
- `post_likes` - 点赞表
- `post_favorites` - 收藏表

**对外接口：**

- `POST /api/posts/:id/replies` - 发布回复
- `PUT /api/replies/:id` - 编辑回复
- `DELETE /api/replies/:id` - 删除回复
- `POST /api/posts/:id/like` - 点赞
- `DELETE /api/posts/:id/like` - 取消点赞
- `POST /api/posts/:id/favorite` - 收藏
- `DELETE /api/posts/:id/favorite` - 取消收藏
- `GET /api/users/:id/favorites` - 获取用户收藏列表

---

### M5 - 板块管理模块 (Section Management)

**核心职责：**

- 论坛板块的组织结构管理
- 板块配置与属性设置
- 板块与帖子的关联管理

**主要功能点：**

- 创建板块
- 编辑板块信息
- 删除板块
- 板块排序
- 板块启用/禁用
- 板块统计数据

**数据实体：**

- `sections` - 板块表
- `section_configs` - 板块配置表

**对外接口：**

- `GET /api/sections` - 获取板块列表
- `GET /api/sections/:id` - 获取板块详情
- `POST /api/sections` - 创建板块（管理员）
- `PUT /api/sections/:id` - 编辑板块（管理员）
- `DELETE /api/sections/:id` - 删除板块（管理员）
- `PUT /api/sections/:id/sort` - 调整板块排序（管理员）
- `GET /api/sections/:id/posts` - 获取板块下的帖子

---

### M6 - 搜索与索引模块 (Search & Indexing)

**核心职责：**

- 全文搜索引擎集成
- 搜索索引的构建与维护
- 搜索结果排序与优化
- 搜索行为分析

**主要功能点：**

- 帖子全文搜索（标题+内容）
- 按作者筛选
- 搜索结果分页
- 搜索历史记录
- 热门搜索统计
- 索引自动更新

**数据实体：**

- `search_indices` - 搜索索引表
- `search_logs` - 搜索日志表

**对外接口：**

- `GET /api/search` - 全文搜索
- `GET /api/search/suggestions` - 搜索建议
- `GET /api/search/hot` - 热门搜索词

**技术方案：**

- 可选方案：Elasticsearch / 数据库全文索引 / 第三方搜索服务

---

### M7 - 文件存储模块 (File Storage)

**核心职责：**

- 图片上传与存储
- 文件元数据管理
- 文件访问权限控制
- 存储空间管理

**主要功能点：**

- 图片上传（支持 jpg/png/gif）
- 文件大小限制（5MB）
- 文件格式验证
- 文件 URL 生成
- 文件删除与清理
- 存储统计

**数据实体：**

- `file_uploads` - 文件上传记录表
- `file_metadata` - 文件元数据表

**对外接口：**

- `POST /api/files/upload` - 上传文件
- `GET /api/files/:id` - 获取文件信息
- `DELETE /api/files/:id` - 删除文件
- `GET /api/files/:id/url` - 获取文件访问 URL

**技术方案：**

- 可选方案：本地文件系统 / MinIO / 云存储（OSS/S3）

---

## 模块依赖关系

```
┌─────────────────────────────────────────────────────────────┐
│                    API Gateway / 路由层                      │
└─────────────────────────────────────────────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                │                           │
        ┌───────▼────────┐         ┌───────▼────────┐
        │  M1 认证授权    │         │   前端管理后台   │
        │  (中间件层)     │         │  (调用各模块)    │
        └───────┬────────┘         └────────────────┘
                │
    ┌───────────┼───────────┬───────────┬───────────┐
    │           │           │           │           │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│ M2    │  │ M3    │  │ M4    │  │ M5    │  │ M6    │
│ 用户  │  │ 内容  │  │ 互动  │  │ 板块  │  │ 搜索  │
│ 管理  │  │ 管理  │  │ 评论  │  │ 管理  │  │ 检索  │
└───┬───┘  └───┬───┘  └───┬───┘  └───────┘  └───────┘
    │          │          │
    └──────────┼──────────┘
               │
          ┌────▼────┐
          │   M7    │
          │  文件   │
          │  存储   │
          └─────────┘
```

**依赖说明：**

- **M1 认证授权模块**：作为基础设施层，被所有需要权限控制的模块依赖
- **M2 用户管理模块**：被 M3、M4 依赖（获取用户信息）
- **M3 内容管理模块**：被 M4、M6 依赖（获取帖子信息）
- **M7 文件存储模块**：被 M2、M3、M4、M5 依赖（图片上传）
- **前端管理后台**：调用各模块的管理员接口，无独立后端服务

---

## 技术架构建议

### 后端技术栈

- **开发语言**：Node.js / Java / Python
- **Web 框架**：Express / Spring Boot / FastAPI
- **数据库**：MySQL / PostgreSQL
- **缓存**：Redis（会话、热点数据）
- **搜索引擎**：Elasticsearch（可选）
- **对象存储**：MinIO / 本地文件系统
- **消息队列**：RabbitMQ / Redis（异步任务，可选）

### 架构模式

- **分层架构**：Controller → Service → Repository
- **RESTful API** 设计规范
- **JWT** 无状态认证
- **RBAC** 权限控制模型

### 数据库设计原则

- 每个模块对应独立的数据表集合
- **认证数据与业务数据分离**：`users_auth`（M1）与 `users_profile`（M2）解耦
- 使用外键约束保证数据一致性（通过 user_id 关联）
- 合理使用索引优化查询性能
- 软删除机制（deleted_at 字段）
- 统一的时间戳字段（created_at, updated_at）

---

## 开发优先级建议

### 第一阶段：核心基础（MVP）

1. **M1 认证与授权模块** - 用户登录、权限控制
2. **M2 用户管理模块** - 基础用户信息管理
3. **M3 内容管理模块** - 帖子发布、浏览、编辑
4. **M7 文件存储模块** - 图片上传

### 第二阶段：社交互动

5. **M4 评论与互动模块** - 回复、点赞、收藏
6. **M5 板块管理模块** - 板块组织

### 第三阶段：增强功能

7. **M6 搜索与索引模块** - 全文搜索
8. **前端管理后台** - 统一管理界面（调用各模块接口）

---

## 接口设计规范

### 统一响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1697788800000
}
```

### 统一错误码

- `200` - 成功
- `400` - 请求参数错误
- `401` - 未认证
- `403` - 无权限
- `404` - 资源不存在
- `500` - 服务器内部错误

### 分页参数

- `page` - 页码（从 1 开始）
- `pageSize` - 每页数量（默认 20）

### 排序参数

- `sortBy` - 排序字段
- `order` - 排序方向（asc/desc）

---

## 架构设计亮点

### 1. 认证与业务数据分离

**M1 与 M2 的解耦设计**是本架构的核心优势：

| 维度         | M1 认证与授权模块      | M2 用户管理模块    |
| ------------ | ---------------------- | ------------------ |
| **数据表**   | `users_auth`           | `users_profile`    |
| **存储内容** | 用户名、密码哈希、状态 | 昵称、头像、简介   |
| **职责**     | 身份验证、权限控制     | 业务信息管理       |
| **修改频率** | 低（仅登录、改密码）   | 高（频繁更新资料） |
| **安全级别** | 极高（敏感数据）       | 一般（展示数据）   |

**优势：**

- ✅ 修改用户资料不影响认证逻辑
- ✅ 降低安全风险（业务代码不接触密码）
- ✅ 便于后期扩展（如第三方登录）
- ✅ 数据库优化更灵活（不同缓存策略）

---

## 下一步工作

本 README 提供了模块划分的宏观视图。各模块的详细 PRD 文档：

1. ✅ **M1-认证与授权模块.md** - 用户登录、权限控制、密码管理
2. ✅ **M2-用户管理模块.md** - 用户资料管理、统计数据、个人主页
3. ✅ **M3-内容管理模块.md** - 帖子发布、编辑、删除、置顶、浏览
4. ✅ **M4-评论与互动模块.md** - 回复、点赞、收藏功能
5. ✅ **M5-板块管理模块.md** - 板块创建、编辑、排序管理
6. ✅ **M6-搜索与索引模块.md** - 全文搜索、高级搜索、搜索建议
7. ✅ **M7-文件存储模块.md** - 文件上传、存储、自动清理（后端服务）

> 📌 **管理后台说明**：管理后台由前端实现，通过调用各模块提供的管理员接口完成管理功能，无需独立的后端服务模块。

---

**文档版本：** v2.0  
**创建日期：** 2025-10-23  
**最后更新：** 2025-10-27  
**维护者：** 产品与后端开发团队
