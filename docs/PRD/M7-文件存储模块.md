# M7 - 文件存储模块 PRD

## 模块概述

**模块名称**：文件存储模块  
**模块编号**：M7  
**优先级**：P1（高优先级）  
**目标用户**：内部服务（后端模块调用）

### 业务目标

本模块旨在解决以下核心业务问题：

1. **统一存储**：为所有模块提供统一的文件存储服务
2. **文件管理**：管理文件的上传、访问、删除等生命周期
3. **空间优化**：自动清理未使用的文件，优化存储空间
4. **访问控制**：提供文件访问地址，确保文件可访问性

### 模块边界

> ⚠️ **职责范围**：本模块是纯粹的后端基础服务，仅提供文件存储相关的接口，不涉及任何用户界面和交互逻辑。用户的文件上传体验由调用本模块的业务模块（M2、M3、M4、M5）负责。

**与其他模块的关系**：

- **依赖 M1**：验证调用者身份
- **被 M2 依赖**：存储用户头像
- **被 M3 依赖**：存储帖子图片
- **被 M4 依赖**：存储回复图片
- **被 M5 依赖**：存储板块图标

---

## 功能需求

### 1. 接收文件上传

#### 1.1 业务场景

**使用场景**：其他模块需要存储文件（图片）时，调用本模块的上传接口。

**调用场景**：

- M2 用户管理模块：上传用户头像
- M3 内容管理模块：上传帖子中的图片
- M4 互动评论模块：上传回复中的图片
- M5 板块管理模块：上传板块图标

#### 1.2 功能说明

接收其他模块发送的文件上传请求，保存文件并返回访问地址。

**输入信息**：

- 文件数据（二进制流）
- 文件类型标识（avatar/post/reply/section-icon）
- 上传者用户 ID

**输出结果**：

- 上传成功：返回文件 ID 和访问 URL
- 上传失败：返回错误信息

#### 1.3 业务规则

**文件格式验证**：

- 支持格式：JPG、PNG、GIF、SVG
- 验证文件真实类型（不仅依赖扩展名）
- 拒绝非图片文件

**文件大小限制**：

根据文件类型设置不同的大小限制：

- 用户头像（avatar）：最大 2MB
- 帖子图片（post）：最大 5MB
- 回复图片（reply）：最大 5MB
- 板块图标（section-icon）：最大 500KB

**文件命名**：

- 生成唯一的文件名（避免冲突）
- 保留原文件扩展名
- 文件名不包含特殊字符

**文件记录**：

- 记录文件上传者 ID
- 记录文件类型
- 记录上传时间
- 初始状态为"未使用"

---

### 2. 返回文件访问地址

#### 2.1 业务场景

**使用场景**：其他模块需要获取文件的访问 URL，用于前端展示。

**调用场景**：

- M2 获取用户头像 URL
- M3 获取帖子图片 URL
- M4 获取回复图片 URL
- M5 获取板块图标 URL

#### 2.2 功能说明

根据文件 ID 返回该文件的访问地址。

**输入信息**：

- 文件 ID

**输出结果**：

- 成功：返回文件访问 URL
- 失败：返回错误信息（文件不存在）

#### 2.3 业务规则

**URL 格式**：

- 完整的 HTTPS 地址
- 可以直接在浏览器访问
- 地址永久有效（除非文件被删除）

**访问控制**：

- 所有文件公开可访问（无需认证）
- 通过 URL 直接访问

---

### 3. 标记文件为已使用

#### 3.1 业务场景

**使用场景**：当文件被实际使用时（如帖子发布成功），调用模块通知文件已被使用。

**调用场景**：

- M2 设置头像成功后，标记头像文件已使用
- M3 发布帖子成功后，标记帖子中的图片已使用
- M4 发布回复成功后，标记回复中的图片已使用
- M5 设置板块图标后，标记图标文件已使用

#### 3.2 功能说明

将文件状态从"未使用"更新为"已使用"，并记录使用位置。

**输入信息**：

- 文件 ID
- 使用位置类型（post/reply/avatar/section-icon）
- 使用位置 ID（帖子 ID/回复 ID/用户 ID/板块 ID）

**输出结果**：

- 成功：文件状态更新为已使用
- 失败：返回错误信息

#### 3.3 业务规则

**标记时机**：

- 内容发布成功后立即标记
- 一个文件可以被多处使用（记录所有使用位置）

**使用记录**：

- 记录使用位置类型
- 记录使用位置 ID
- 记录使用时间

**状态更新**：

- 从"未使用"变为"已使用"
- 已使用的文件不会被自动清理

---

### 4. 标记文件为未使用

#### 4.1 业务场景

**使用场景**：当文件不再被使用时（如帖子被删除），调用模块通知文件已取消使用。

**调用场景**：

- M2 更换头像后，原头像标记为未使用
- M3 删除帖子后，帖子中的图片标记为未使用
- M4 删除回复后，回复中的图片标记为未使用
- M5 更换板块图标后，原图标标记为未使用

#### 4.2 功能说明

移除文件的使用记录，如果文件没有其他使用位置，状态更新为"未使用"。

**输入信息**：

- 文件 ID
- 使用位置类型
- 使用位置 ID

**输出结果**：

- 成功：移除使用记录
- 失败：返回错误信息

#### 4.3 业务规则

**取消标记时机**：

- 内容被删除时立即取消标记
- 内容被编辑且移除图片时取消标记

**状态判断**：

- 如果文件还有其他使用位置，保持"已使用"状态
- 如果文件没有任何使用位置，变为"未使用"状态

**未使用文件处理**：

- 变为未使用后，纳入自动清理检测范围

---

### 5. 删除文件

#### 5.1 业务场景

**使用场景**：

- 管理员删除违规图片
- 系统自动清理未使用的文件

**调用场景**：

- M8 系统管理模块：管理员删除违规文件
- 本模块：自动清理未使用文件

#### 5.2 功能说明

删除指定的文件。

**输入信息**：

- 文件 ID
- 删除原因（管理员删除时必填）
- 操作者 ID

**输出结果**：

- 成功：文件被删除
- 失败：返回错误信息

#### 5.3 业务规则

**删除权限**：

- 仅管理员可以手动删除
- 系统可以自动删除

**删除影响**：

- 文件从存储中永久删除
- 文件记录标记为已删除
- 访问 URL 失效

**删除限制**：

- 删除后无法恢复

---

### 6. 自动清理未使用文件

#### 6.1 业务场景

**使用场景**：系统定期清理长期未使用的文件，释放存储空间。

#### 6.2 功能说明

系统自动检测并清理符合条件的未使用文件。

**清理条件**：

- 文件状态为"未使用"
- 上传时间超过 30 天

**清理流程**：

- 定期检测（每天一次）
- 自动删除符合条件的文件
- 记录清理日志

#### 6.3 业务规则

**检测时机**：

- 每天凌晨 2:00 执行检测

**清理规则**：

- 仅清理"未使用"状态的文件
- 已使用的文件永不清理
- 上传超过 30 天自动清理

**清理记录**：

- 记录清理时间
- 记录清理文件数量
- 记录释放空间大小
- 记录被清理的文件列表

---

### 7. 批量获取文件信息

#### 7.1 业务场景

**使用场景**：其他模块需要批量获取多个文件的信息。

**调用场景**：

- M3 获取帖子列表时，批量获取图片信息
- M2 获取用户列表时，批量获取头像信息

#### 7.2 功能说明

根据文件 ID 列表，批量返回文件信息。

**输入信息**：

- 文件 ID 列表

**输出结果**：

- 成功：返回文件信息列表
- 失败：返回错误信息

#### 7.3 业务规则

**批量限制**：

- 单次最多查询 100 个文件

**返回信息**：

- 文件 ID
- 文件 URL
- 文件大小
- 文件格式
- 上传时间

---

### 8. 获取存储统计

#### 8.1 业务场景

**使用场景**：M8 系统管理模块需要获取存储空间统计数据。

#### 8.2 功能说明

返回存储空间的统计信息。

**统计维度**：

- 全站统计：
  - 总文件数量
  - 总存储空间占用
  - 已使用文件数量
  - 未使用文件数量
- 按用户统计：

  - 指定用户的文件数量
  - 指定用户的存储占用

- 按类型统计：
  - 各类型文件的数量
  - 各类型文件的占用空间

#### 8.3 业务规则

**查询权限**：

- 仅 M8 系统管理模块可以调用

**统计范围**：

- 包含已删除文件（标记为已删除，但未物理删除）
- 区分已使用和未使用

---

## 服务接口清单

### 对外提供的接口

| 接口功能     | 说明                             | 调用方           |
| ------------ | -------------------------------- | ---------------- |
| 上传文件     | 接收文件上传，返回文件 ID 和 URL | M2、M3、M4、M5   |
| 获取文件 URL | 根据文件 ID 返回访问地址         | M2、M3、M4、M5   |
| 标记已使用   | 标记文件被使用，记录使用位置     | M2、M3、M4、M5   |
| 标记未使用   | 取消文件使用标记                 | M2、M3、M4、M5   |
| 删除文件     | 删除指定文件                     | M8（管理员操作） |
| 批量获取信息 | 批量查询文件信息                 | M2、M3           |
| 获取存储统计 | 返回存储空间统计数据             | M8               |

---

## 文件生命周期

### 文件状态流转

```
上传 → 未使用 → 被引用 → 已使用 → 永久保留
       ↓
       30天未使用 → 自动删除
```

### 状态说明

**未使用**：

- 文件已上传，但未被任何内容引用
- 纳入自动清理检测范围

**已使用**：

- 文件被帖子、回复、头像或板块图标使用
- 不会被自动清理
- 永久保留

**已删除**：

- 文件被管理员删除或自动清理
- 访问 URL 失效
- 物理文件被删除

---

## 业务规则

### 文件验证规则

**格式验证**：

- 验证文件 MIME 类型
- 验证文件魔数（文件头）
- 拒绝伪装的文件

**大小验证**：

- 根据文件类型验证大小
- 超过限制拒绝上传

### 文件存储规则

**文件命名**：

- 使用 UUID 或时间戳生成唯一文件名
- 保留原文件扩展名
- 按日期分目录存储（如 2025/10/27/）

**文件组织**：

- 按上传日期分目录
- 按文件类型分类（可选）

### 文件删除规则

**删除条件**：

- 管理员手动删除（任何文件）
- 系统自动清理（仅未使用文件）

**删除影响**：

- 物理文件被删除
- 文件记录标记为已删除
- URL 访问返回 404

---

## 测试场景

### 1. 文件上传测试场景

| 场景编号 | 测试场景     | 操作步骤                              | 预期结果                     |
| -------- | ------------ | ------------------------------------- | ---------------------------- |
| TC-001   | 正常上传     | M3 调用上传接口，上传 3MB 的 JPG 图片 | 上传成功，返回文件 ID 和 URL |
| TC-002   | 文件过大     | M2 上传 3MB 的头像（限制 2MB）        | 返回错误"文件超过大小限制"   |
| TC-003   | 格式错误     | 上传 PDF 文件                         | 返回错误"不支持的文件格式"   |
| TC-004   | 验证文件类型 | 上传伪装成 JPG 的 EXE 文件            | 返回错误"文件类型验证失败"   |
| TC-005   | 并发上传     | 同时上传 10 个文件                    | 所有文件成功上传             |

### 2. 文件访问测试场景

| 场景编号 | 测试场景   | 操作步骤             | 预期结果             |
| -------- | ---------- | -------------------- | -------------------- |
| TC-101   | 获取 URL   | 根据文件 ID 获取 URL | 返回有效的访问地址   |
| TC-102   | 访问文件   | 通过 URL 访问文件    | 显示图片内容         |
| TC-103   | 文件不存在 | 获取不存在的文件 ID  | 返回错误"文件不存在" |
| TC-104   | 已删除文件 | 访问已删除文件的 URL | 返回 404             |

### 3. 文件使用标记测试场景

| 场景编号 | 测试场景   | 操作步骤                      | 预期结果                       |
| -------- | ---------- | ----------------------------- | ------------------------------ |
| TC-201   | 标记已使用 | M3 发布帖子后标记图片已使用   | 文件状态更新为已使用           |
| TC-202   | 取消使用   | M3 删除帖子后取消图片使用标记 | 如无其他使用，状态变为未使用   |
| TC-203   | 多处使用   | 同一图片被多个帖子使用        | 记录所有使用位置               |
| TC-204   | 部分取消   | 删除一个使用位置              | 文件仍为已使用（还有其他位置） |

### 4. 自动清理测试场景

| 场景编号 | 测试场景       | 操作步骤             | 预期结果       |
| -------- | -------------- | -------------------- | -------------- |
| TC-301   | 检测未使用文件 | 上传 30 天后仍未使用 | 被纳入清理列表 |
| TC-302   | 自动清理       | 30 天后自动检测      | 文件被自动删除 |
| TC-303   | 已使用文件     | 上传 30 天但已被使用 | 不被清理       |
| TC-304   | 清理记录       | 自动清理完成         | 记录清理日志   |

### 5. 文件删除测试场景

| 场景编号 | 测试场景       | 操作步骤             | 预期结果                           |
| -------- | -------------- | -------------------- | ---------------------------------- |
| TC-401   | 管理员删除     | M8 调用删除接口      | 文件被删除                         |
| TC-402   | 删除已使用文件 | 删除被帖子使用的图片 | 删除成功，帖子图片失效             |
| TC-403   | 删除记录       | 管理员删除文件       | 记录删除日志（时间、操作者、原因） |

### 6. 统计查询测试场景

| 场景编号 | 测试场景 | 操作步骤              | 预期结果                     |
| -------- | -------- | --------------------- | ---------------------------- |
| TC-501   | 全站统计 | M8 查询全站存储统计   | 返回总文件数、总占用空间     |
| TC-502   | 用户统计 | M8 查询指定用户统计   | 返回该用户的文件数和占用空间 |
| TC-503   | 类型统计 | M8 查询各类型文件统计 | 返回各类型的数量和占用       |

---

## 功能清单

### 核心服务功能

- [x] 接收文件上传
- [x] 返回文件访问地址
- [x] 标记文件为已使用
- [x] 标记文件为未使用
- [x] 删除文件
- [x] 批量获取文件信息
- [x] 获取存储统计

### 自动化功能

- [x] 自动检测未使用文件
- [x] 自动清理过期文件（30 天未使用）
- [x] 记录清理日志

---

**文档版本：** v1.0（纯需求版）  
**创建日期：** 2025-10-27  
**最后更新：** 2025-10-27  
**文档类型：** 产品需求文档（PRD）
