# M1 - 认证与授权模块 PRD

## 模块概述

**模块名称**：认证与授权模块  
**模块编号**：M1  
**优先级**：P0（最高优先级，核心基础模块）  
**目标用户**：全体系统用户（普通用户 + 管理员）

### 业务目标

本模块旨在解决以下核心业务问题：

1. **身份识别**：确认"你是谁"——验证用户身份的真实性
2. **访问控制**：确认"你能做什么"——控制用户可以执行的操作
3. **安全保障**：保护系统和用户数据的安全性
4. **权限管理**：为不同角色的用户提供差异化的功能权限

### 模块边界

> ⚠️ **职责范围**：本模块仅负责"身份认证"和"权限控制"，不涉及用户的个人资料、发帖记录等业务数据。这些业务数据由 M2 用户管理模块负责。

---

## 功能需求

### 1. 用户登录

#### 1.1 业务场景

**使用场景**：用户打开论坛网站，需要登录后才能发帖、回复等操作。

**用户故事**：
- 作为一个论坛用户，我希望能够使用用户名和密码登录系统，以便访问我的账号和发布内容。
- 作为一个经常访问的用户，我希望能够选择"记住我"功能，避免每次都重新登录。

#### 1.2 功能说明

用户在登录页面输入用户名和密码，系统验证身份后允许用户访问系统功能。

**输入信息**：
- 用户名（必填）
- 密码（必填）
- 记住我（可选，勾选后延长登录有效期）

**输出结果**：
- 登录成功：返回登录凭证，用户可以访问需要登录的功能
- 登录失败：提示错误原因（用户名不存在、密码错误、账号被禁用等）

#### 1.3 业务规则

**输入验证规则**：
- 用户名长度：3-20 个字符
- 密码长度：6-32 个字符
- 用户名和密码不能为空

**登录验证规则**：
- 用户名必须在系统中存在
- 密码必须与该用户名对应的密码匹配
- 账号状态必须为"正常"（未被禁用）

**登录凭证有效期**：
- 默认登录：凭证有效期 2 小时
- 记住我登录：凭证有效期 7 天

**失败场景处理**：
- 用户名不存在：提示"用户名或密码错误"（不明确指出是用户名错误，避免泄露信息）
- 密码错误：提示"用户名或密码错误"
- 账号被禁用：提示"账号已被禁用，请联系管理员"

#### 1.4 交互流程

1. 用户在登录页面输入用户名和密码
2. 用户可选择勾选"记住我"
3. 用户点击"登录"按钮
4. 系统验证用户名和密码
5. 验证成功：
   - 系统生成登录凭证
   - 跳转到首页或用户登录前访问的页面
   - 显示登录成功提示
6. 验证失败：
   - 在登录页面显示错误提示
   - 用户可以重新输入

---

### 2. 用户登出

#### 2.1 业务场景

**使用场景**：用户使用完论坛后，希望退出登录以保护账号安全。

**用户故事**：
- 作为一个论坛用户，我希望能够安全地退出登录，防止他人使用我的账号。

#### 2.2 功能说明

用户点击"退出登录"按钮后，系统清除用户的登录状态，用户需要重新登录才能访问需要认证的功能。

**输入信息**：无（用户已登录状态）

**输出结果**：
- 清除用户登录状态
- 跳转到登录页面或首页
- 提示"已成功退出登录"

#### 2.3 业务规则

- 登出后，用户之前的登录凭证失效
- 用户需要重新登录才能访问需要认证的功能
- 登出操作不影响用户的数据（发帖、收藏等）

#### 2.4 交互流程

1. 用户点击页面右上角的"退出登录"按钮
2. 系统清除登录状态
3. 跳转到登录页面或首页
4. 显示"已成功退出登录"提示

---

### 3. 保持登录状态（凭证自动续期）

#### 3.1 业务场景

**使用场景**：用户正在浏览论坛或编写帖子时，登录凭证即将过期，系统自动续期避免用户重新登录。

**用户故事**：
- 作为一个正在使用论坛的用户，我希望系统能够自动续期我的登录状态，避免在编辑内容时突然被要求重新登录。

#### 3.2 功能说明

当用户的登录凭证即将过期时（例如还剩 10 分钟），系统自动为用户续期，延长登录有效期，用户无需重新输入密码。

**触发条件**：
- 用户处于登录状态
- 登录凭证即将过期（剩余时间少于 10 分钟）
- 用户在活跃使用系统（非长时间无操作）

**输出结果**：
- 自动延长登录有效期
- 用户无感知，继续使用系统

#### 3.3 业务规则

- 仅在用户活跃使用时自动续期
- 续期后的有效期为 2 小时
- 如果用户长时间无操作（超过凭证有效期），需要重新登录

---

### 4. 查看我的权限

#### 4.1 业务场景

**使用场景**：用户想了解自己在论坛中拥有哪些权限，可以执行哪些操作。

**用户故事**：
- 作为一个论坛用户，我希望能够查看我的角色和权限，了解我能做什么操作。

#### 4.2 功能说明

用户可以查看自己的角色（普通用户/管理员）和具体的权限列表。

**输出信息**：
- 用户角色：普通用户 或 管理员
- 权限列表：
  - 发帖权限
  - 编辑/删除自己帖子的权限
  - 回复权限
  - 点赞/收藏权限
  - （管理员）管理他人内容的权限
  - （管理员）用户管理权限
  - （管理员）板块管理权限

#### 4.3 业务规则

- 普通用户只能看到自己的权限
- 管理员可以看到所有权限
- 权限列表根据用户角色动态显示

---

### 5. 修改密码

#### 5.1 业务场景

**使用场景**：用户为了账号安全，定期更换密码或怀疑密码泄露时修改密码。

**用户故事**：
- 作为一个论坛用户，我希望能够修改自己的登录密码，以保护账号安全。

#### 5.2 功能说明

用户在个人设置页面可以修改自己的登录密码，需要输入原密码进行验证。

**输入信息**：
- 原密码（必填）
- 新密码（必填）
- 确认新密码（必填）

**输出结果**：
- 修改成功：提示"密码修改成功，请重新登录"，跳转到登录页
- 修改失败：提示错误原因

#### 5.3 业务规则

**输入验证规则**：
- 原密码必须正确
- 新密码长度：6-32 个字符
- 新密码不能与原密码相同
- 两次输入的新密码必须一致

**安全规则**：
- 修改密码后，用户需要重新登录
- 修改密码后，之前的所有登录凭证失效

**失败场景处理**：
- 原密码错误：提示"原密码错误"
- 新密码格式不符：提示"密码长度必须为 6-32 个字符"
- 两次密码不一致：提示"两次输入的密码不一致"

#### 5.4 交互流程

1. 用户进入"个人设置"页面
2. 点击"修改密码"
3. 输入原密码、新密码、确认新密码
4. 点击"确认修改"
5. 系统验证原密码是否正确
6. 验证新密码格式和一致性
7. 修改成功：
   - 更新密码
   - 清除所有登录状态
   - 跳转到登录页
   - 提示"密码修改成功，请重新登录"

---

### 6. 重置用户密码（管理员功能）

#### 6.1 业务场景

**使用场景**：用户忘记密码或账号被盗，管理员帮助用户重置密码。

**用户故事**：
- 作为管理员，我希望能够为忘记密码的用户重置密码，帮助他们恢复账号访问。

#### 6.2 功能说明

管理员在用户管理页面可以为指定用户重置密码，设置新密码后通知用户。

**输入信息**：
- 目标用户（选择要重置密码的用户）
- 新密码（必填）

**输出结果**：
- 重置成功：提示"密码重置成功"
- 重置失败：提示错误原因

#### 6.3 业务规则

- 仅管理员可以执行此操作
- 新密码长度：6-32 个字符
- 重置后，目标用户的所有登录状态失效
- 建议通知用户密码已被重置

#### 6.4 交互流程

1. 管理员进入"用户管理"页面
2. 找到需要重置密码的用户
3. 点击"重置密码"按钮
4. 输入新密码
5. 点击"确认"
6. 系统更新用户密码
7. 清除该用户的所有登录状态
8. 提示"密码重置成功"

---

### 7. 启用/禁用用户（管理员功能）

#### 7.1 业务场景

**使用场景**：管理员需要临时禁用违规用户的账号，或恢复被禁用用户的访问权限。

**用户故事**：
- 作为管理员，我希望能够禁用违规用户的账号，防止其继续发布不当内容。
- 作为管理员，我希望能够恢复被误禁用户的账号，让其重新访问论坛。

#### 7.2 功能说明

管理员可以将用户账号设置为"正常"或"禁用"状态。

**操作选项**：
- 启用账号：将禁用的账号恢复为正常状态
- 禁用账号：将正常账号设置为禁用状态

**输出结果**：
- 操作成功：提示"用户状态已更新"
- 操作失败：提示错误原因

#### 7.3 业务规则

- 仅管理员可以执行此操作
- 禁用后的账号无法登录
- 已登录的被禁用用户，其登录状态立即失效
- 禁用账号不会删除用户数据（帖子、回复等仍然保留）
- 启用账号后，用户可以正常登录

**禁用账号的影响**：
- 用户无法登录
- 已登录的用户立即被登出
- 用户的帖子和回复仍然可见（不自动删除）

#### 7.4 交互流程

**禁用账号**：
1. 管理员进入"用户管理"页面
2. 找到需要禁用的用户
3. 点击"禁用账号"按钮
4. 确认操作
5. 系统更新用户状态为"禁用"
6. 清除该用户的所有登录状态
7. 提示"用户已被禁用"

**启用账号**：
1. 管理员进入"用户管理"页面
2. 找到被禁用的用户
3. 点击"启用账号"按钮
4. 确认操作
5. 系统更新用户状态为"正常"
6. 提示"用户已启用"

---

### 8. 创建用户账号（管理员功能）

#### 8.1 业务场景

**使用场景**：管理员为新成员创建论坛账号。

**用户故事**：
- 作为管理员，我希望能够为新成员创建账号，让他们可以访问论坛。

#### 8.2 功能说明

管理员在用户管理页面创建新用户账号，设置用户名、初始密码和角色。

**输入信息**：
- 用户名（必填，唯一）
- 初始密码（必填）
- 用户角色（必填，普通用户/管理员）

**输出结果**：
- 创建成功：返回新用户的账号信息
- 创建失败：提示错误原因（如用户名已存在）

#### 8.3 业务规则

- 仅管理员可以创建用户
- 用户名必须唯一，不能与现有用户重复
- 用户名长度：3-20 个字符
- 初始密码长度：6-32 个字符
- 新创建的账号状态为"正常"
- 创建账号后，需要通知用户其用户名和初始密码

#### 8.4 交互流程

1. 管理员进入"用户管理"页面
2. 点击"创建用户"按钮
3. 填写用户名、初始密码
4. 选择用户角色（普通用户/管理员）
5. 点击"确认创建"
6. 系统验证用户名是否已存在
7. 创建成功：
   - 生成新用户账号
   - 显示用户信息
   - 提示"用户创建成功"
8. 管理员将用户名和密码告知新用户

---

## 权限控制（RBAC）

### 角色定义

| 角色 ID | 角色名称 | 角色标识 | 说明                       |
| ------- | -------- | -------- | -------------------------- |
| 1       | 普通用户 | user     | 可以发帖、回复、点赞、收藏 |
| 2       | 管理员   | admin    | 拥有全站管理权限           |

### 权限详细说明

#### 内容权限

| 权限名称       | 说明                   | 普通用户 | 管理员 |
| -------------- | ---------------------- | -------- | ------ |
| 创建帖子       | 发布新帖子             | ✅        | ✅      |
| 编辑自己的帖子 | 编辑自己发布的帖子     | ✅        | ✅      |
| 删除自己的帖子 | 删除自己发布的帖子     | ✅        | ✅      |
| 编辑任意帖子   | 编辑任何人发布的帖子   | ❌        | ✅      |
| 删除任意帖子   | 删除任何人发布的帖子   | ❌        | ✅      |
| 置顶帖子       | 将帖子置顶到列表最前面 | ❌        | ✅      |

#### 回复权限

| 权限名称       | 说明                 | 普通用户 | 管理员 |
| -------------- | -------------------- | -------- | ------ |
| 创建回复       | 回复帖子             | ✅        | ✅      |
| 编辑自己的回复 | 编辑自己发布的回复   | ✅        | ✅      |
| 删除自己的回复 | 删除自己发布的回复   | ✅        | ✅      |
| 删除任意回复   | 删除任何人发布的回复 | ❌        | ✅      |

#### 互动权限

| 权限名称 | 说明         | 普通用户 | 管理员 |
| -------- | ------------ | -------- | ------ |
| 点赞帖子 | 给帖子点赞   | ✅        | ✅      |
| 收藏帖子 | 收藏喜欢的帖子 | ✅        | ✅      |

#### 管理权限

| 权限名称     | 说明                       | 普通用户 | 管理员 |
| ------------ | -------------------------- | -------- | ------ |
| 创建用户     | 创建新用户账号             | ❌        | ✅      |
| 编辑用户     | 编辑用户信息               | ❌        | ✅      |
| 删除用户     | 删除用户账号               | ❌        | ✅      |
| 管理用户角色 | 分配或修改用户角色         | ❌        | ✅      |
| 管理板块     | 创建、编辑、删除论坛板块   | ❌        | ✅      |
| 系统配置     | 修改系统设置               | ❌        | ✅      |

### 权限控制规则

**普通用户可以做什么**：
- ✅ 发布、编辑、删除自己的帖子
- ✅ 回复帖子，编辑、删除自己的回复
- ✅ 点赞和收藏帖子
- ✅ 查看所有公开内容
- ❌ 不能管理他人的内容
- ❌ 不能管理用户和系统设置

**管理员可以做什么**：
- ✅ 拥有普通用户的所有权限
- ✅ 编辑和删除任何人的帖子和回复
- ✅ 置顶重要帖子
- ✅ 创建、编辑、删除用户账号
- ✅ 分配用户角色
- ✅ 管理论坛板块
- ✅ 修改系统配置

---

## 安全需求

### 1. 密码安全要求

**密码强度规则**：
- 最小长度：6 个字符
- 最大长度：32 个字符
- 建议包含大小写字母和数字（提高安全性）

**密码存储要求**：
- 系统不得存储明文密码
- 必须使用加密算法对密码进行不可逆加密
- 即使数据库泄露，也无法还原用户的原始密码

**密码修改要求**：
- 修改密码时必须验证原密码
- 新密码不能与原密码相同
- 修改密码后，所有登录状态失效，用户需重新登录

### 2. 登录凭证安全要求

**凭证有效期**：
- 默认登录：2 小时后自动过期
- 记住我登录：7 天后自动过期
- 过期后用户需重新登录

**凭证传输要求**：
- 登录凭证仅通过 HTTPS 加密传输
- 不允许在 URL 中传递登录凭证
- 登录凭证应存储在安全的位置（不暴露给第三方）

**凭证失效规则**：
- 用户主动登出时，凭证立即失效
- 用户修改密码后，所有凭证失效
- 管理员禁用账号后，该用户的所有凭证失效

### 3. 防护要求

**防暴力破解**：
- 同一 IP 短时间内登录失败次数过多（如 5 次），应临时限制登录
- 限制时间建议为 30 分钟
- 错误提示不应明确指出是用户名错误还是密码错误

**防恶意请求**：
- 登录接口应限制请求频率（如每 IP 每分钟最多 10 次）
- 其他接口也应有合理的频率限制

**数据安全**：
- 用户输入的数据必须经过验证和过滤
- 防止恶意代码注入
- 敏感信息（如密码）不得出现在日志中

### 4. 权限验证要求

**访问控制**：
- 所有需要登录的功能，必须验证用户登录状态
- 所有需要特定权限的功能，必须验证用户权限
- 未登录用户访问需要登录的功能时，返回"未认证"错误
- 已登录但权限不足的用户，返回"权限不足"错误

**权限检查时机**：
- 每次请求都必须验证用户身份和权限
- 不能仅在前端检查权限，后端必须强制验证

---

## 测试场景

### 1. 登录功能测试场景

| 场景编号 | 测试场景       | 操作步骤                     | 预期结果                   |
| -------- | -------------- | ---------------------------- | -------------------------- |
| TC-001   | 正常登录       | 输入正确的用户名和密码       | 登录成功，跳转到首页       |
| TC-002   | 用户名不存在   | 输入不存在的用户名           | 提示"用户名或密码错误"     |
| TC-003   | 密码错误       | 输入错误的密码               | 提示"用户名或密码错误"     |
| TC-004   | 账号被禁用     | 使用被禁用的账号登录         | 提示"账号已被禁用"         |
| TC-005   | 参数缺失       | 不输入用户名或密码           | 提示"请输入用户名和密码"   |
| TC-006   | 记住我功能     | 勾选"记住我"后登录           | 7 天内无需重新登录         |
| TC-007   | 登录凭证过期   | 使用过期的登录凭证访问系统   | 提示"登录已过期，请重新登录" |

### 2. 权限控制测试场景

| 场景编号 | 测试场景             | 用户角色 | 操作             | 预期结果           |
| -------- | -------------------- | -------- | ---------------- | ------------------ |
| TC-101   | 普通用户发帖         | 普通用户 | 创建帖子         | 成功               |
| TC-102   | 普通用户编辑自己帖子 | 普通用户 | 编辑自己的帖子   | 成功               |
| TC-103   | 普通用户删除他人帖子 | 普通用户 | 删除他人的帖子   | 提示"权限不足"     |
| TC-104   | 管理员删除任意帖子   | 管理员   | 删除任意帖子     | 成功               |
| TC-105   | 管理员置顶帖子       | 管理员   | 置顶帖子         | 成功               |
| TC-106   | 未登录用户发帖       | 未登录   | 尝试创建帖子     | 提示"请先登录"     |
| TC-107   | 普通用户创建用户     | 普通用户 | 尝试创建新用户   | 提示"权限不足"     |

### 3. 密码管理测试场景

| 场景编号 | 测试场景         | 操作步骤                   | 预期结果                   |
| -------- | ---------------- | -------------------------- | -------------------------- |
| TC-201   | 正常修改密码     | 输入正确的原密码和新密码   | 修改成功，需重新登录       |
| TC-202   | 原密码错误       | 输入错误的原密码           | 提示"原密码错误"           |
| TC-203   | 新密码格式不符   | 新密码长度不足 6 位        | 提示"密码长度必须为 6-32 位" |
| TC-204   | 两次密码不一致   | 两次输入的新密码不同       | 提示"两次输入的密码不一致" |
| TC-205   | 管理员重置密码   | 管理员为用户重置密码       | 重置成功，用户被强制登出   |

### 4. 账号管理测试场景

| 场景编号 | 测试场景       | 操作步骤                 | 预期结果                 |
| -------- | -------------- | ------------------------ | ------------------------ |
| TC-301   | 创建新用户     | 管理员创建新用户账号     | 创建成功，返回用户信息   |
| TC-302   | 用户名重复     | 创建已存在的用户名       | 提示"用户名已存在"       |
| TC-303   | 禁用用户账号   | 管理员禁用某用户账号     | 禁用成功，用户无法登录   |
| TC-304   | 启用用户账号   | 管理员启用被禁用的账号   | 启用成功，用户可以登录   |
| TC-305   | 禁用后强制登出 | 禁用已登录用户的账号     | 用户立即被登出           |

---

## 功能清单

### 普通用户功能
- [x] 用户登录
- [x] 用户登出
- [x] 修改密码
- [x] 查看我的权限
- [x] 自动续期登录状态

### 管理员功能
- [x] 创建用户账号
- [x] 重置用户密码
- [x] 启用/禁用用户账号
- [x] 查看所有用户权限

---

**文档版本：** v1.0（纯需求版）  
**创建日期：** 2025-10-23  
**最后更新：** 2025-10-23  
**文档类型：** 产品需求文档（PRD）
