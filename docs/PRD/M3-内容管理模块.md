# M3 - 内容管理模块 PRD

## 模块概述

**模块名称**：内容管理模块  
**模块编号**：M3  
**优先级**：P0（最高优先级，核心基础模块）  
**目标用户**：全体系统用户（普通用户 + 管理员）

### 业务目标

本模块旨在解决以下核心业务问题：

1. **内容发布**：为用户提供便捷的帖子发布功能，支持富文本编辑和图片上传
2. **内容浏览**：提供流式时间线展示，让用户快速浏览社区动态
3. **内容管理**：支持帖子的编辑、删除、置顶等管理操作
4. **内容组织**：通过板块分类和排序，帮助用户找到感兴趣的内容
5. **数据统计**：记录帖子浏览量，反映内容热度

### 模块边界

> ⚠️ **职责范围**：本模块仅负责帖子的完整生命周期管理（创建、编辑、删除、浏览、置顶等），不涉及回复、点赞、收藏等互动功能。互动功能由 M4 互动评论模块负责。

**与其他模块的关系**：

- **依赖 M1**：验证用户身份和权限
- **依赖 M2**：获取作者信息
- **依赖 M5**：验证板块是否存在
- **依赖 M7**：上传帖子中的图片
- **被 M4 依赖**：提供帖子信息用于回复、点赞、收藏
- **被 M6 依赖**：提供帖子内容用于搜索索引

---

## 功能需求

### 1. 发布新帖

#### 1.1 业务场景

**使用场景**：用户想在论坛发布技术文章、问题求助、资源分享等内容。

**用户故事**：

- 作为一个论坛用户，我希望能够发布带有代码、图片的技术文章，与其他用户分享我的经验。
- 作为一个论坛用户，我希望使用格式化的方式编写内容，让文章排版更美观。
- 作为一个论坛用户，我希望能够选择合适的板块发布帖子，让目标用户更容易找到。

#### 1.2 功能说明

用户在发帖页面填写标题、内容，选择板块后发布帖子。

**输入信息**：

- 标题（必填）
- 内容（必填，支持格式化文本）
- 所属板块（必填）
- 图片（可选，多张）

**输出结果**：

- 发布成功：跳转到帖子详情页，显示"发布成功"提示
- 发布失败：显示错误原因

#### 1.3 业务规则

**标题规则**：

- 长度：5-100 个字符
- 不能全部为空格
- 不能包含特殊字符（除了常见标点符号）

**内容规则**：

- 最小长度：10 个字符
- 最大长度：50,000 个字符
- 支持格式化文本（标题、加粗、斜体、列表、代码块等）
- 支持插入图片

**图片规则**：

- 支持格式：JPG、PNG、GIF
- 单张大小：不超过 5MB
- 数量限制：每篇帖子最多 10 张图片

**板块规则**：

- 必须选择一个有效的板块
- 板块必须是启用状态

**发布限制**：

- 无特殊限制

#### 1.4 交互流程

1. 用户点击"发帖"按钮，进入发帖页面
2. 填写帖子标题
3. 使用编辑器编写内容
4. （可选）上传图片到内容中
5. 选择所属板块
6. 点击"发布"按钮
7. 系统验证输入信息
8. 验证通过：
   - 创建帖子记录
   - 更新用户发帖数
   - 跳转到帖子详情页
   - 显示"发布成功"提示
9. 验证失败：
   - 显示错误提示
   - 用户可以修改后重新提交

---

### 2. 浏览帖子列表

#### 2.1 业务场景

**使用场景**：

- 用户打开论坛首页，查看最新发布的帖子
- 用户进入某个板块，查看该板块的帖子列表
- 用户滚动页面，加载更多帖子

**用户故事**：

- 作为一个论坛用户，我希望在首页看到所有板块的最新帖子，了解社区动态。
- 作为一个论坛用户，我希望能够按板块筛选帖子，专注于我感兴趣的主题。
- 作为一个论坛用户，我希望置顶帖子显示在最前面，不错过重要公告。

#### 2.2 功能说明

以时间线（类似 Twitter/X）的方式展示帖子列表，支持分页加载和板块筛选。

**筛选条件**：

- 全部板块（默认）
- 指定板块

**显示信息**：
每个帖子卡片显示：

- 标题
- 作者头像和昵称
- 发布时间（相对时间，如"3 小时前"）
- 内容预览（前 200 字，纯文本）
- 所属板块（徽章）
- 统计数据：浏览量、回复数、点赞数
- 置顶标识（如有）

**排序方式**：

- **默认排序**：置顶帖子优先，然后按发布时间倒序（最新在前）
- 按最新回复：最近有回复的帖子在前
- 按热度：综合点赞数、回复数、浏览数排序

#### 2.3 业务规则

**分页规则**：

- 每页默认 20 条帖子
- 支持调整每页数量（最大 50 条）
- 滚动到底部自动加载下一页

**置顶规则**：

- 置顶帖子始终显示在列表最前面
- 同为置顶帖子时，按置顶时间倒序
- 置顶帖子数量不限制

**内容预览规则**：

- 提取纯文本内容（去除格式标记）
- 显示前 200 个字符
- 如果超过 200 字符，添加"..."省略号
- 不显示图片（仅显示文字）

#### 2.4 交互流程

1. 用户访问首页或点击板块
2. 系统显示该板块的帖子列表
3. 置顶帖子显示在最前面
4. 用户滚动到底部时，自动加载下一页
5. 用户可以点击板块切换，查看不同板块的帖子

---

### 3. 查看帖子详情

#### 3.1 业务场景

**使用场景**：用户点击帖子标题，查看完整的帖子内容和回复列表。

**用户故事**：

- 作为一个论坛用户，我希望看到完整的帖子内容，包括格式化后的样式。
- 作为一个论坛用户，我希望看到代码块有清晰的显示，方便阅读。
- 作为一个论坛用户，我希望能够点击图片查看大图。
- 作为一个论坛用户，我希望看到该帖子的所有回复。

#### 3.2 功能说明

显示帖子的完整信息，包括格式化的内容展示。

**显示信息**：

- 帖子标题
- 作者信息（头像、昵称、发帖时间）
- 所属板块（徽章）
- 完整内容（格式化显示）
- 代码块（清晰展示 + 一键复制按钮）
- 图片（点击放大预览）
- 统计数据：浏览量、回复数、点赞数
- 操作按钮：
  - 点赞按钮（由 M4 负责）
  - 收藏按钮（由 M4 负责）
  - 编辑按钮（作者本人可见）
  - 删除按钮（作者/管理员可见）
  - 置顶按钮（管理员可见）
- 回复列表（由 M4 负责）
- 回复输入框（由 M4 负责）

#### 3.3 业务规则

**权限控制**：

- 所有用户都可以查看公开的帖子
- 已删除的帖子仅管理员可见
- 作者可以看到"编辑"和"删除"按钮
- 管理员可以看到"删除"和"置顶"按钮

**浏览量统计**：

- 每次访问帖子详情页，浏览量 +1
- 同一用户短时间内（10 分钟）多次访问不重复计数
- 作者本人访问不计入浏览量

**内容展示**：

- 正确显示格式化内容（标题、列表、引用等）
- 代码块清晰展示，提供一键复制功能
- 支持表格、引用、列表等格式
- 自动将网址转换为可点击的链接
- 图片支持点击放大查看

#### 3.4 交互流程

1. 用户点击帖子标题
2. 跳转到帖子详情页
3. 显示完整的帖子内容和格式
4. 显示统计数据（浏览量、回复数、点赞数）
5. 根据用户身份显示相应的操作按钮
6. 显示回复列表（由 M4 负责）
7. 用户可以进行互动操作（点赞、收藏、回复）

---

### 4. 编辑帖子

#### 4.1 业务场景

**使用场景**：

- 作者发现帖子内容有错误，需要修改
- 作者想补充新的内容或图片
- 管理员需要修正不当内容

**用户故事**：

- 作为一个论坛用户，我希望能够编辑我发布的帖子，修正错误或补充内容。
- 作为一个论坛用户，我希望看到帖子的"已编辑"标识，了解内容被修改过。
- 作为管理员，我希望能够编辑任何帖子，处理不当内容。

#### 4.2 功能说明

允许作者和管理员编辑帖子的标题和内容。

**可编辑字段**：

- 标题
- 内容
- 所属板块

**不可编辑字段**：

- 作者
- 发布时间
- 浏览量等统计数据

**输出结果**：

- 编辑成功：更新帖子内容，跳转到帖子详情页，显示"修改成功"提示
- 编辑失败：显示错误原因

#### 4.3 业务规则

**编辑权限**：

- 作者可以编辑自己的帖子
- 管理员可以编辑任何帖子
- 其他用户无法编辑

**编辑限制**：

- 发布后 24 小时内可以无限制编辑
- 24 小时后，每篇帖子最多编辑 5 次
- 管理员无编辑次数限制

**编辑历史**：

- 每次编辑保存一个历史版本
- 帖子被编辑后，显示"已编辑"标识
- 显示最后编辑时间
- 如果编辑者不是作者（管理员编辑），显示编辑者信息
- 管理员可以查看完整的编辑历史

**验证规则**：

- 与发布帖子相同的验证规则
- 标题长度、内容长度、敏感词过滤等

#### 4.4 交互流程

1. 用户在帖子详情页点击"编辑"按钮
2. 进入编辑页面，预填充原帖子内容
3. 修改标题、内容或板块
4. 点击"保存"按钮
5. 系统验证权限和输入信息
6. 验证通过：
   - 保存编辑历史版本
   - 更新帖子内容
   - 更新最后修改时间
   - 跳转到帖子详情页
   - 显示"修改成功"提示
7. 验证失败：
   - 显示错误提示
   - 用户可以继续修改

---

### 5. 删除帖子

#### 5.1 业务场景

**使用场景**：

- 作者想删除自己发布的帖子
- 管理员需要删除违规内容

**用户故事**：

- 作为一个论坛用户，我希望能够删除我不想保留的帖子。
- 作为管理员，我希望能够删除违规帖子，维护社区秩序。
- 作为管理员，我希望删除操作可以恢复，防止误删。

#### 5.2 功能说明

支持软删除和硬删除两种方式。

**删除方式**：

- **软删除**（默认）：标记为已删除，数据保留，用户不可见
- **硬删除**（仅管理员）：永久删除数据，不可恢复

**影响范围**：

- 帖子内容不再显示在列表中
- 帖子详情页显示"该帖子已被删除"
- 帖子的回复、点赞、收藏记录保留
- 作者的发帖数 -1

#### 5.3 业务规则

**删除权限**：

- 作者可以删除自己的帖子（软删除）
- 管理员可以删除任何帖子（软删除或硬删除）
- 其他用户无法删除

**删除确认**：

- 删除操作需要二次确认
- 提示删除后的影响（如回复数据保留）
- 管理员删除需要填写删除原因

**删除限制**：

- 帖子有回复时，建议不删除（仅提示，不强制）
- 被置顶的帖子，删除前需要先取消置顶

**恢复功能**：

- 软删除的帖子可以恢复（仅管理员）
- 恢复后帖子重新出现在列表中
- 硬删除的帖子无法恢复

#### 5.4 交互流程

**作者删除自己的帖子**：

1. 用户在帖子详情页点击"删除"按钮
2. 弹出确认对话框："确定要删除这篇帖子吗？删除后可以联系管理员恢复。"
3. 用户点击"确认删除"
4. 系统执行软删除
5. 更新用户发帖数
6. 跳转到首页
7. 显示"帖子已删除"提示

**管理员删除帖子**：

1. 管理员在帖子详情页点击"删除"按钮
2. 弹出对话框：
   - 选择删除方式（软删除/硬删除）
   - 填写删除原因（必填）
3. 管理员点击"确认删除"
4. 系统执行删除操作
5. 记录操作日志
6. 显示"帖子已删除"提示

---

### 6. 置顶/取消置顶帖子（管理员功能）

#### 6.1 业务场景

**使用场景**：管理员需要将重要公告或优质内容置顶，让用户优先看到。

**用户故事**：

- 作为管理员，我希望能够置顶重要公告，确保所有用户都能看到。
- 作为管理员，我希望能够置顶优质内容，提升社区内容质量。
- 作为管理员，我希望能够取消置顶，让帖子恢复正常排序。

#### 6.2 功能说明

管理员可以将帖子设置为置顶状态，置顶帖子显示在列表最前面。

**操作选项**：

- 置顶帖子
- 取消置顶

**置顶类型**：

- **全局置顶**：在所有板块的首页都显示
- **板块置顶**：仅在该帖子所属板块显示

#### 6.3 业务规则

**置顶权限**：

- 仅管理员可以执行置顶操作
- 普通用户无法置顶

**置顶限制**：

- 全局置顶最多 3 篇
- 每个板块置顶最多 5 篇
- 已删除的帖子无法置顶

**置顶顺序**：

- 全局置顶优先于板块置顶
- 同为全局置顶时，按置顶时间倒序（最新置顶的在前）
- 同为板块置顶时，按置顶时间倒序

**置顶标识**：

- 置顶帖子显示"置顶"徽章
- 使用不同颜色区分全局置顶和板块置顶

#### 6.4 交互流程

**置顶帖子**：

1. 管理员在帖子详情页点击"置顶"按钮
2. 选择置顶类型：全局置顶 或 板块置顶
3. 点击"确认"
4. 系统检查置顶数量限制
5. 设置置顶状态
6. 显示"置顶成功"提示

**取消置顶**：

1. 管理员在帖子详情页点击"取消置顶"按钮
2. 确认操作
3. 系统取消置顶状态
4. 显示"已取消置顶"提示

---

### 7. 查看帖子编辑历史（管理员功能）

#### 7.1 业务场景

**使用场景**：管理员需要查看帖子的编辑历史，审查内容变更。

**用户故事**：

- 作为管理员，我希望能够查看帖子的编辑历史，了解内容是如何变化的。
- 作为管理员，我希望能够对比不同版本的内容，识别恶意修改。

#### 7.2 功能说明

管理员可以查看帖子的所有历史版本，包括标题、内容、编辑时间、编辑者。

**显示信息**：

- 版本号（从 1 开始递增）
- 编辑时间
- 编辑者（用户名和昵称）
- 修改前的标题
- 修改前的内容
- 与当前版本的差异对比

#### 7.3 业务规则

**查看权限**：

- 仅管理员可以查看编辑历史
- 普通用户无法查看

**版本保留**：

- 所有编辑历史永久保留
- 硬删除帖子时，同时删除编辑历史

**差异对比**：

- 高亮显示新增内容
- 高亮显示删除内容
- 清晰展示内容变化

#### 7.4 交互流程

1. 管理员在帖子详情页点击"编辑历史"按钮
2. 显示历史版本列表
3. 管理员选择某个版本查看详情
4. 显示该版本的完整内容
5. （可选）与当前版本对比差异

---

### 8. 查看用户的帖子列表

#### 8.1 业务场景

**使用场景**：在用户个人主页查看该用户发布的所有帖子。

**用户故事**：

- 作为一个论坛用户，我希望在个人主页看到我发布过的所有帖子。
- 作为一个论坛用户，我希望查看其他用户的发帖历史，了解他们分享过哪些内容。

#### 8.2 功能说明

查询指定用户发布的所有帖子，支持分页和排序。

**显示信息**：

- 与帖子列表相同的显示格式
- 默认按发布时间倒序

#### 8.3 业务规则

- 仅显示该用户发布的帖子
- 不显示已删除的帖子（本人可以看到自己被删除的帖子）
- 支持按发布时间、点赞数、回复数排序

#### 8.4 调用说明

由 M2 用户管理模块在个人主页调用，展示用户的发帖列表。

---

## 数据统计规则

### 浏览量统计

**计数规则**：

- 每次访问帖子详情页，浏览量 +1
- 同一用户 10 分钟内多次访问不重复计数
- 作者本人访问不计入浏览量
- 未登录用户按 IP 地址去重

**显示规则**：

- 帖子列表显示浏览量
- 帖子详情页显示浏览量
- 个人主页统计显示总浏览量

### 回复数和点赞数

**说明**：

- 回复数和点赞数由 M4 互动评论模块维护
- 本模块仅展示这些数据
- 数据实时更新

---

## 权限验证

**操作权限**：

- 发布帖子：需要登录
- 编辑帖子：仅作者或管理员
- 删除帖子：仅作者或管理员
- 置顶帖子：仅管理员

**数据隔离**：

- 用户只能操作自己的帖子
- 管理员可以操作任何帖子
- 系统强制验证权限

---

## 测试场景

### 1. 发布帖子测试场景

| 场景编号 | 测试场景   | 操作步骤                           | 预期结果                          |
| -------- | ---------- | ---------------------------------- | --------------------------------- |
| TC-001   | 正常发布   | 填写标题、内容、选择板块，点击发布 | 发布成功，跳转到帖子详情页        |
| TC-002   | 标题为空   | 不填写标题，点击发布               | 提示"请输入标题"                  |
| TC-003   | 标题过短   | 输入 4 个字符的标题                | 提示"标题长度至少 5 个字符"       |
| TC-004   | 标题过长   | 输入 101 个字符的标题              | 提示"标题长度不能超过 100 个字符" |
| TC-005   | 内容为空   | 不填写内容                         | 提示"请输入内容"                  |
| TC-006   | 内容过短   | 输入 9 个字符的内容                | 提示"内容长度至少 10 个字符"      |
| TC-007   | 未选择板块 | 不选择板块                         | 提示"请选择板块"                  |
| TC-008   | 上传图片   | 上传符合规格的图片                 | 图片成功插入到内容中              |
| TC-009   | 图片过大   | 上传超过 5MB 的图片                | 提示"图片大小不能超过 5MB"        |

### 2. 浏览帖子测试场景

| 场景编号 | 测试场景     | 操作步骤             | 预期结果             |
| -------- | ------------ | -------------------- | -------------------- |
| TC-101   | 查看帖子列表 | 访问首页             | 显示最新帖子列表     |
| TC-102   | 置顶帖子优先 | 查看帖子列表         | 置顶帖子显示在最前面 |
| TC-103   | 板块筛选     | 选择某个板块         | 只显示该板块的帖子   |
| TC-104   | 分页加载     | 滚动到页面底部       | 自动加载下一页帖子   |
| TC-105   | 查看帖子详情 | 点击帖子标题         | 显示完整的帖子内容   |
| TC-106   | 格式显示     | 查看包含格式的帖子   | 正确显示格式化内容   |
| TC-107   | 代码显示     | 查看包含代码块的帖子 | 代码清晰显示         |
| TC-108   | 图片预览     | 点击帖子中的图片     | 图片放大显示         |
| TC-109   | 浏览量增加   | 访问帖子详情页       | 浏览量 +1            |
| TC-110   | 重复访问     | 10 分钟内再次访问    | 浏览量不增加         |

### 3. 编辑帖子测试场景

| 场景编号 | 测试场景         | 操作步骤                   | 预期结果                   |
| -------- | ---------------- | -------------------------- | -------------------------- |
| TC-201   | 作者编辑自己帖子 | 点击"编辑"，修改内容，保存 | 编辑成功，显示"已编辑"标识 |
| TC-202   | 编辑他人帖子     | 普通用户尝试编辑他人帖子   | 无编辑按钮或提示"权限不足" |
| TC-203   | 管理员编辑帖子   | 管理员编辑任意帖子         | 编辑成功                   |
| TC-204   | 超过编辑次数     | 24 小时后第 6 次编辑       | 提示"超过编辑次数限制"     |
| TC-205   | 保存编辑历史     | 编辑帖子后查看历史         | 管理员可以看到编辑历史     |

### 4. 删除帖子测试场景

| 场景编号 | 测试场景         | 操作步骤                 | 预期结果                   |
| -------- | ---------------- | ------------------------ | -------------------------- |
| TC-301   | 作者删除自己帖子 | 点击"删除"，确认         | 帖子被软删除，不再显示     |
| TC-302   | 删除他人帖子     | 普通用户尝试删除他人帖子 | 无删除按钮或提示"权限不足" |
| TC-303   | 管理员软删除     | 管理员软删除帖子         | 帖子被标记为已删除         |
| TC-304   | 管理员硬删除     | 管理员硬删除帖子         | 帖子及相关数据永久删除     |
| TC-305   | 恢复已删除帖子   | 管理员恢复软删除的帖子   | 帖子重新显示在列表中       |

### 5. 置顶帖子测试场景

| 场景编号 | 测试场景       | 操作步骤                   | 预期结果                   |
| -------- | -------------- | -------------------------- | -------------------------- |
| TC-401   | 管理员置顶帖子 | 点击"置顶"，选择类型，确认 | 帖子被置顶，显示在列表最前 |
| TC-402   | 普通用户置顶   | 普通用户尝试置顶帖子       | 无置顶按钮或提示"权限不足" |
| TC-403   | 全局置顶限制   | 已有 3 篇全局置顶时再置顶  | 提示"全局置顶数量已达上限" |
| TC-404   | 取消置顶       | 管理员取消置顶             | 帖子恢复正常排序           |

---

## 功能清单

### 普通用户功能

- [x] 发布新帖
- [x] 浏览帖子列表（全部/按板块）
- [x] 查看帖子详情
- [x] 编辑自己的帖子
- [x] 删除自己的帖子
- [x] 查看自己的发帖历史

### 管理员功能

- [x] 编辑任意帖子
- [x] 删除任意帖子（软删除/硬删除）
- [x] 恢复已删除的帖子
- [x] 置顶/取消置顶帖子
- [x] 查看帖子编辑历史
- [x] 查看所有帖子列表

---

**文档版本：** v1.0（纯需求版）  
**创建日期：** 2025-10-27  
**最后更新：** 2025-10-27  
**文档类型：** 产品需求文档（PRD）
