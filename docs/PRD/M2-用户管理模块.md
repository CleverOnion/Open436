# M2 - 用户管理模块 PRD

## 模块概述

**模块名称**：用户管理模块  
**模块编号**：M2  
**优先级**：P0（最高优先级，核心基础模块）  
**目标用户**：全体系统用户（普通用户 + 管理员）

### 业务目标

本模块旨在解决以下核心业务问题：

1. **用户信息管理**：管理用户的个人资料（昵称、头像、简介等）
2. **用户数据展示**：为用户提供个人主页，展示发帖、回复等活动数据
3. **用户统计分析**：统计用户的活动数据（发帖数、回复数、获赞数等）
4. **用户信息查询**：支持查看其他用户的公开信息和活动历史

### 模块边界

> ⚠️ **职责范围**：本模块仅负责用户的业务信息（昵称、头像、简介、统计数据等），不涉及认证凭据（用户名、密码）和权限管理。认证和权限由 M1 认证与授权模块负责。

**与 M1 的关系**：
- M1 负责：用户名、密码、登录、权限、角色
- M2 负责：昵称、头像、简介、个人主页、统计数据
- 两个模块通过 `user_id` 关联

---

## 功能需求

### 1. 查看用户信息

#### 1.1 业务场景

**使用场景**：
- 用户查看自己的个人主页，了解自己的资料和活动统计
- 用户查看其他用户的个人主页，了解对方的公开信息

**用户故事**：
- 作为一个论坛用户，我希望能够查看自己的个人主页，看到我的昵称、头像、简介和发帖统计。
- 作为一个论坛用户，我希望能够点击其他用户的昵称，查看他们的个人主页和发帖历史。

#### 1.2 功能说明

用户可以查看个人主页，包含以下信息：

**基本资料**：
- 用户 ID
- 昵称
- 头像
- 个人简介
- 注册时间

**统计数据**：
- 发帖总数
- 回复总数
- 获得的点赞总数
- 获得的收藏总数

**活动历史**（可选查看）：
- 最近发布的帖子列表
- 最近的回复列表

#### 1.3 业务规则

**信息可见性**：
- 所有用户都可以查看其他用户的公开信息
- 基本资料和统计数据对所有人可见
- 活动历史对所有人可见

**数据准确性**：
- 统计数据应实时更新（或准实时）
- 发帖数、回复数等数据应与实际数据一致

#### 1.4 交互流程

1. 用户点击某个用户的昵称或头像
2. 系统跳转到该用户的个人主页
3. 显示用户的基本资料和统计数据
4. 用户可以切换查看"发帖历史"或"回复历史"标签页
5. 点击帖子标题可跳转到帖子详情页

---

### 2. 编辑个人资料

#### 2.1 业务场景

**使用场景**：用户希望修改自己的昵称、头像或个人简介。

**用户故事**：
- 作为一个论坛用户，我希望能够修改我的昵称和头像，让我的个人主页更有个性。
- 作为一个论坛用户，我希望能够编写个人简介，介绍我自己。

#### 2.2 功能说明

用户在个人设置页面可以编辑以下信息：

**可编辑字段**：
- 昵称（必填）
- 头像（可选，支持上传图片）
- 个人简介（可选）

**输出结果**：
- 修改成功：提示"个人资料已更新"
- 修改失败：提示错误原因

#### 2.3 业务规则

**昵称规则**：
- 长度：2-20 个字符
- 允许中文、英文、数字
- 不允许包含特殊符号（除了下划线 `_` 和连字符 `-`）
- 昵称可以重复（与用户名不同）

**头像规则**：
- 支持的格式：JPG、PNG、GIF
- 文件大小：不超过 2MB
- 推荐尺寸：200x200 像素
- 如果不上传头像，使用系统默认头像

**个人简介规则**：
- 最大长度：200 个字符
- 允许换行
- 不允许包含恶意代码或链接（需过滤）

**修改频率限制**：
- 昵称：每 30 天只能修改一次
- 头像：无限制
- 简介：无限制

#### 2.4 交互流程

1. 用户进入"个人设置"页面
2. 点击"编辑资料"
3. 修改昵称、上传头像或编辑简介
4. 点击"保存"
5. 系统验证输入格式
6. 验证通过：
   - 更新用户资料
   - 提示"个人资料已更新"
   - 返回个人主页
7. 验证失败：
   - 显示错误提示
   - 用户可以重新编辑

---

### 3. 查看用户发帖历史

#### 3.1 业务场景

**使用场景**：用户想查看某个用户发布过的所有帖子。

**用户故事**：
- 作为一个论坛用户，我希望能够查看某个用户的所有帖子，了解他发布过哪些内容。
- 作为一个论坛用户，我希望能够在我的个人主页查看我发布过的所有帖子。

#### 3.2 功能说明

在用户个人主页的"发帖历史"标签页，显示该用户发布的所有帖子列表。

**显示信息**：
- 帖子标题
- 发布时间
- 所属板块
- 回复数
- 点赞数
- 浏览数

**排序方式**：
- 默认按发布时间倒序（最新的在前）
- 可选按点赞数排序
- 可选按回复数排序

**分页**：
- 每页显示 20 条
- 支持翻页

#### 3.3 业务规则

- 显示该用户所有公开的帖子
- 已删除的帖子不显示
- 按发布时间倒序排列

#### 3.4 交互流程

1. 用户进入某个用户的个人主页
2. 点击"发帖历史"标签
3. 系统显示该用户的帖子列表
4. 用户可以点击帖子标题查看详情
5. 用户可以切换排序方式或翻页

---

### 4. 查看用户回复历史

#### 4.1 业务场景

**使用场景**：用户想查看某个用户回复过的所有帖子。

**用户故事**：
- 作为一个论坛用户，我希望能够查看某个用户的所有回复，了解他参与过哪些讨论。

#### 4.2 功能说明

在用户个人主页的"回复历史"标签页，显示该用户发布的所有回复列表。

**显示信息**：
- 回复内容（前 100 字）
- 回复时间
- 所属帖子标题
- 获得的点赞数

**排序方式**：
- 默认按回复时间倒序（最新的在前）

**分页**：
- 每页显示 20 条
- 支持翻页

#### 4.3 业务规则

- 显示该用户所有公开的回复
- 已删除的回复不显示
- 按回复时间倒序排列

#### 4.4 交互流程

1. 用户进入某个用户的个人主页
2. 点击"回复历史"标签
3. 系统显示该用户的回复列表
4. 用户可以点击帖子标题查看完整讨论
5. 用户可以翻页查看更多回复

---

### 5. 创建用户（管理员功能）

#### 5.1 业务场景

**使用场景**：管理员为新成员创建完整的用户账号（包括认证账号和用户资料）。

**用户故事**：
- 作为管理员，我希望能够为新成员创建账号，包括设置用户名、密码和基本资料。

#### 5.2 功能说明

管理员在用户管理页面创建新用户，需要填写认证信息和基本资料。

**输入信息**：

**认证信息**（由 M1 处理）：
- 用户名（必填，唯一）
- 初始密码（必填）
- 用户角色（必填，普通用户/管理员）

**基本资料**（由 M2 处理）：
- 昵称（必填）
- 头像（可选）
- 个人简介（可选）

**输出结果**：
- 创建成功：返回新用户的完整信息
- 创建失败：提示错误原因

#### 5.3 业务规则

- 仅管理员可以创建用户
- 用户名必须唯一（由 M1 验证）
- 昵称可以重复
- 创建成功后，用户可以立即登录
- 创建账号时，自动初始化统计数据（发帖数=0，回复数=0 等）

#### 5.4 交互流程

1. 管理员进入"用户管理"页面
2. 点击"创建用户"按钮
3. 填写用户名、密码、角色
4. 填写昵称、上传头像（可选）、编辑简介（可选）
5. 点击"确认创建"
6. 系统先调用 M1 创建认证账号
7. 认证账号创建成功后，创建用户资料
8. 初始化统计数据
9. 提示"用户创建成功"
10. 显示新用户信息

---

### 6. 编辑用户资料（管理员功能）

#### 6.1 业务场景

**使用场景**：管理员需要修改某个用户的资料（如昵称不当需要修改）。

**用户故事**：
- 作为管理员，我希望能够修改用户的昵称和简介，处理不当内容。

#### 6.2 功能说明

管理员可以编辑任何用户的资料，不受昵称修改频率限制。

**可编辑字段**：
- 昵称
- 头像
- 个人简介

**输出结果**：
- 修改成功：提示"用户资料已更新"
- 修改失败：提示错误原因

#### 6.3 业务规则

- 仅管理员可以编辑他人资料
- 管理员不受昵称修改频率限制
- 其他验证规则与普通用户相同

#### 6.4 交互流程

1. 管理员进入"用户管理"页面
2. 找到需要编辑的用户
3. 点击"编辑资料"按钮
4. 修改昵称、头像或简介
5. 点击"保存"
6. 系统更新用户资料
7. 提示"用户资料已更新"

---

### 7. 查看用户列表（管理员功能）

#### 7.1 业务场景

**使用场景**：管理员需要查看所有用户的列表，进行用户管理。

**用户故事**：
- 作为管理员，我希望能够查看所有用户的列表，了解用户的基本信息和状态。

#### 7.2 功能说明

管理员可以查看所有用户的列表，支持搜索和筛选。

**显示信息**：
- 用户 ID
- 用户名
- 昵称
- 角色（普通用户/管理员）
- 账号状态（正常/禁用）
- 注册时间
- 发帖数
- 回复数

**搜索功能**：
- 按用户名搜索
- 按昵称搜索

**筛选功能**：
- 按角色筛选（全部/普通用户/管理员）
- 按状态筛选（全部/正常/禁用）

**排序方式**：
- 默认按注册时间倒序
- 可选按发帖数排序
- 可选按回复数排序

**分页**：
- 每页显示 50 条
- 支持翻页

#### 7.3 业务规则

- 仅管理员可以查看用户列表
- 显示所有用户（包括禁用的用户）
- 支持快速搜索和筛选

#### 7.4 交互流程

1. 管理员进入"用户管理"页面
2. 系统显示用户列表
3. 管理员可以输入关键词搜索
4. 管理员可以选择筛选条件
5. 管理员可以点击用户查看详情
6. 管理员可以对用户执行操作（编辑资料、禁用账号等）

---

## 数据统计规则

### 统计数据说明

**发帖数**：
- 统计该用户发布的所有帖子数量
- 不包括已删除的帖子

**回复数**：
- 统计该用户发布的所有回复数量
- 不包括已删除的回复

**获赞数**：
- 统计该用户的所有帖子和回复获得的点赞总数
- 包括帖子获赞和回复获赞

**获收藏数**：
- 统计该用户的所有帖子被收藏的总数

### 统计数据更新时机

**实时更新场景**：
- 用户发布新帖子：发帖数 +1
- 用户删除帖子：发帖数 -1
- 用户发布回复：回复数 +1
- 用户删除回复：回复数 -1
- 用户的帖子被点赞：获赞数 +1
- 用户的帖子被取消点赞：获赞数 -1
- 用户的帖子被收藏：获收藏数 +1
- 用户的帖子被取消收藏：获收藏数 -1

---

## 安全需求

### 1. 头像上传安全

**文件类型验证**：
- 仅允许上传图片文件（JPG、PNG、GIF）
- 验证文件的真实类型，不能仅依赖文件扩展名
- 拒绝上传可执行文件或脚本文件

**文件大小限制**：
- 单个文件不超过 2MB
- 超过限制时提示"文件过大，请上传小于 2MB 的图片"

**文件存储安全**：
- 上传的文件应存储在独立的文件服务器或对象存储
- 文件名应随机生成，避免文件名冲突
- 文件 URL 应使用 CDN 加速访问

### 2. 内容安全

**个人简介过滤**：
- 过滤恶意代码（如 JavaScript、HTML 标签）
- 过滤外部链接（防止钓鱼）
- 过滤敏感词汇

**昵称过滤**：
- 过滤敏感词汇
- 过滤特殊字符（除了 `_` 和 `-`）
- 不允许纯数字昵称（容易与 user_id 混淆）

### 3. 权限验证

**编辑权限**：
- 用户只能编辑自己的资料
- 管理员可以编辑任何用户的资料
- 每次编辑操作都必须验证权限

**查看权限**：
- 所有用户都可以查看其他用户的公开信息
- 无需特殊权限

---

## 测试场景

### 1. 查看用户信息测试场景

| 场景编号 | 测试场景           | 操作步骤                 | 预期结果                   |
| -------- | ------------------ | ------------------------ | -------------------------- |
| TC-001   | 查看自己的个人主页 | 点击"我的主页"           | 显示个人资料和统计数据     |
| TC-002   | 查看他人的个人主页 | 点击其他用户的昵称       | 显示该用户的公开信息       |
| TC-003   | 查看用户发帖历史   | 进入个人主页，点击"发帖" | 显示该用户的所有帖子列表   |
| TC-004   | 查看用户回复历史   | 进入个人主页，点击"回复" | 显示该用户的所有回复列表   |

### 2. 编辑个人资料测试场景

| 场景编号 | 测试场景         | 操作步骤                   | 预期结果                       |
| -------- | ---------------- | -------------------------- | ------------------------------ |
| TC-101   | 正常修改昵称     | 输入符合规则的昵称         | 修改成功，提示"资料已更新"     |
| TC-102   | 昵称长度不符     | 输入 1 个字符的昵称        | 提示"昵称长度必须为 2-20 个字符" |
| TC-103   | 昵称包含特殊符号 | 输入包含 `@` 的昵称        | 提示"昵称不能包含特殊符号"     |
| TC-104   | 上传头像         | 上传 JPG 格式的图片        | 上传成功，头像更新             |
| TC-105   | 头像文件过大     | 上传 5MB 的图片            | 提示"文件过大，请上传小于 2MB 的图片" |
| TC-106   | 修改个人简介     | 输入个人简介               | 修改成功                       |
| TC-107   | 昵称修改频率限制 | 30 天内第二次修改昵称      | 提示"昵称每 30 天只能修改一次" |

### 3. 用户统计数据测试场景

| 场景编号 | 测试场景       | 操作步骤           | 预期结果       |
| -------- | -------------- | ------------------ | -------------- |
| TC-201   | 发帖后统计更新 | 用户发布新帖子     | 发帖数 +1      |
| TC-202   | 删帖后统计更新 | 用户删除自己的帖子 | 发帖数 -1      |
| TC-203   | 回复后统计更新 | 用户发布回复       | 回复数 +1      |
| TC-204   | 获赞后统计更新 | 用户的帖子被点赞   | 获赞数 +1      |
| TC-205   | 收藏后统计更新 | 用户的帖子被收藏   | 获收藏数 +1    |

### 4. 管理员功能测试场景

| 场景编号 | 测试场景         | 操作步骤                 | 预期结果               |
| -------- | ---------------- | ------------------------ | ---------------------- |
| TC-301   | 创建新用户       | 管理员创建新用户账号     | 创建成功，返回用户信息 |
| TC-302   | 编辑用户资料     | 管理员修改用户昵称       | 修改成功               |
| TC-303   | 查看用户列表     | 管理员进入用户管理页面   | 显示所有用户列表       |
| TC-304   | 搜索用户         | 管理员输入用户名搜索     | 显示匹配的用户         |
| TC-305   | 筛选用户         | 管理员筛选"禁用"的用户   | 显示所有禁用用户       |

---

## 功能清单

### 普通用户功能
- [x] 查看自己的个人主页
- [x] 查看他人的个人主页
- [x] 编辑个人资料（昵称、头像、简介）
- [x] 查看用户发帖历史
- [x] 查看用户回复历史
- [x] 查看个人统计数据

### 管理员功能
- [x] 创建用户（包括认证账号和用户资料）
- [x] 编辑任何用户的资料
- [x] 查看用户列表
- [x] 搜索和筛选用户
- [x] 查看用户详细信息

---

## 与其他模块的关系

### 与 M1 认证与授权模块的关系

**数据关联**：
- M1 和 M2 通过 `user_id` 关联
- M1 创建认证账号时生成 `user_id`
- M2 使用相同的 `user_id` 创建用户资料

**职责分工**：
- M1 负责：用户名、密码、登录、权限、角色、账号状态
- M2 负责：昵称、头像、简介、统计数据、个人主页

**接口调用**：
- 创建用户时，先调用 M1 的创建认证账号接口，再调用 M2 的创建用户资料接口
- 禁用用户时，调用 M1 的禁用账号接口，M2 不处理账号状态

### 与 M3 内容管理模块的关系

**数据关联**：
- 帖子和回复表中包含 `author_id`（即 `user_id`）
- M2 通过 `author_id` 查询用户的发帖和回复历史

**统计数据更新**：
- 用户发帖时，M3 通知 M2 更新发帖数
- 用户删帖时，M3 通知 M2 更新发帖数
- 用户回复时，M3 通知 M2 更新回复数
- 用户获赞时，M3 通知 M2 更新获赞数

---

**文档版本：** v1.0（纯需求版）  
**创建日期：** 2025-10-23  
**最后更新：** 2025-10-23  
**文档类型：** 产品需求文档（PRD）
