# M4 - 评论与互动模块 PRD

## 模块概述

**模块名称**：评论与互动模块  
**模块编号**：M4  
**优先级**：P1（高优先级）  
**目标用户**：全体系统用户（普通用户 + 管理员）

### 业务目标

本模块旨在解决以下核心业务问题：

1. **社区互动**：为用户提供回复、点赞、收藏等互动功能，活跃社区氛围
2. **内容讨论**：支持用户对帖子进行评论和讨论，形成知识交流
3. **内容筛选**：通过点赞和收藏，帮助用户发现和保存优质内容
4. **互动统计**：统计回复数、点赞数、收藏数，反映内容受欢迎程度

### 模块边界

> ⚠️ **职责范围**：本模块仅负责回复、点赞、收藏等互动功能，不涉及帖子的创建、编辑、删除等内容管理功能。内容管理由 M3 内容管理模块负责。

**与其他模块的关系**：

- **依赖 M1**：验证用户身份和权限
- **依赖 M2**：获取回复者信息
- **依赖 M3**：验证帖子是否存在，更新帖子的互动统计数据
- **被 M2 依赖**：提供用户的回复历史

---

## 功能需求

### 1. 发布回复

#### 1.1 业务场景

**使用场景**：用户阅读帖子后，想发表自己的看法或提出问题。

**用户故事**：

- 作为一个论坛用户，我希望能够回复帖子，与作者和其他用户交流讨论。
- 作为一个论坛用户，我希望使用格式化的方式编写回复，清楚地表达观点。
- 作为一个论坛用户，我希望能够在回复中插入代码和图片，更好地说明问题。

#### 1.2 功能说明

用户在帖子详情页底部的回复框中输入内容，点击"发布回复"。

**输入信息**：

- 回复内容（必填，支持格式化文本）
- 图片（可选）

**输出结果**：

- 发布成功：回复显示在回复列表中，显示"回复成功"提示
- 发布失败：显示错误原因

#### 1.3 业务规则

**内容规则**：

- 最小长度：2 个字符
- 最大长度：10,000 个字符
- 支持格式化文本
- 支持插入图片

**图片规则**：

- 支持格式：JPG、PNG、GIF
- 单张大小：不超过 5MB
- 数量限制：每条回复最多 3 张图片

**发布限制**：

- 无特殊限制

**回复显示**：

- 回复按时间顺序显示（最早的在前）
- 每条回复显示楼层号（从 1 开始递增）
- 显示回复者信息（头像、昵称、回复时间）

#### 1.4 交互流程

1. 用户在帖子详情页滚动到底部
2. 在回复输入框中编写内容
3. （可选）上传图片
4. 点击"发布回复"按钮
5. 系统验证输入信息
6. 验证通过：
   - 创建回复记录
   - 更新帖子回复数
   - 回复显示在列表末尾
   - 显示"回复成功"提示
7. 验证失败：
   - 显示错误提示
   - 用户可以修改后重新提交

---

### 2. 查看回复列表

#### 2.1 业务场景

**使用场景**：用户查看帖子详情时，想看到其他用户的回复和讨论。

**用户故事**：

- 作为一个论坛用户，我希望看到帖子的所有回复，了解其他人的观点。
- 作为一个论坛用户，我希望按楼层顺序查看回复，便于追踪讨论过程。

#### 2.2 功能说明

在帖子详情页显示所有回复，按时间顺序排列。

**显示信息**：

每条回复显示：

- 楼层号（1 楼、2 楼...）
- 回复者头像和昵称
- 回复时间（相对时间，如"2 小时前"）
- 回复内容（格式化显示）
- 图片（如有）
- 操作按钮：
  - 编辑按钮（回复者本人可见，5 分钟内）
  - 删除按钮（回复者/管理员可见）

#### 2.3 业务规则

**排序规则**：

- 默认按时间顺序显示（最早的在前）
- 楼层号从 1 开始递增

**分页规则**：

- 每页显示 50 条回复
- 支持翻页查看更多回复

**显示规则**：

- 已删除的回复显示"该回复已被删除"
- 回复内容正确显示格式化效果

#### 2.4 交互流程

1. 用户访问帖子详情页
2. 在帖子内容下方显示回复列表
3. 按楼层顺序展示所有回复
4. 用户可以滚动查看更多回复
5. 超过 50 条回复时，显示分页控件

---

### 3. 编辑回复

#### 3.1 业务场景

**使用场景**：用户发现回复内容有错误，想在短时间内修改。

**用户故事**：

- 作为一个论坛用户，我希望能够在发布后的短时间内编辑回复，修正错误。

#### 3.2 功能说明

允许回复者在发布后的 5 分钟内编辑回复内容。

**可编辑字段**：

- 回复内容
- 图片

**不可编辑字段**：

- 回复者
- 回复时间
- 楼层号

**输出结果**：

- 编辑成功：更新回复内容，显示"修改成功"提示
- 编辑失败：显示错误原因

#### 3.3 业务规则

**编辑权限**：

- 回复者可以编辑自己的回复
- 管理员可以编辑任何回复
- 其他用户无法编辑

**编辑时限**：

- 发布后 5 分钟内可以编辑
- 超过 5 分钟后无法编辑
- 管理员无时间限制

**编辑标识**：

- 回复被编辑后，显示"已编辑"标识
- 显示最后编辑时间

**验证规则**：

- 与发布回复相同的验证规则

#### 3.4 交互流程

1. 用户在自己的回复旁点击"编辑"按钮
2. 回复内容变为可编辑状态
3. 修改内容
4. 点击"保存"按钮
5. 系统验证权限和时限
6. 验证通过：
   - 更新回复内容
   - 显示"已编辑"标识
   - 显示"修改成功"提示
7. 验证失败：
   - 显示错误提示

---

### 4. 删除回复

#### 4.1 业务场景

**使用场景**：

- 回复者想删除自己发布的不当回复
- 管理员需要删除违规回复

**用户故事**：

- 作为一个论坛用户，我希望能够删除我不想保留的回复。
- 作为管理员，我希望能够删除违规回复，维护讨论秩序。

#### 4.2 功能说明

支持软删除和硬删除两种方式。

**删除方式**：

- **软删除**（默认）：标记为已删除，显示"该回复已被删除"
- **硬删除**（仅管理员）：永久删除数据，不可恢复

**影响范围**：

- 回复内容不再显示
- 楼层号保留（避免楼层混乱）
- 帖子的回复数 -1

#### 4.3 业务规则

**删除权限**：

- 回复者可以删除自己的回复（软删除）
- 管理员可以删除任何回复（软删除或硬删除）
- 其他用户无法删除

**删除确认**：

- 删除操作需要二次确认
- 管理员删除需要填写删除原因

**楼层处理**：

- 删除回复后，楼层号保留
- 显示"该回复已被删除"占位
- 保持楼层连续性

#### 4.4 交互流程

**回复者删除自己的回复**：

1. 用户在自己的回复旁点击"删除"按钮
2. 弹出确认对话框："确定要删除这条回复吗？"
3. 用户点击"确认删除"
4. 系统执行软删除
5. 显示"该回复已被删除"
6. 更新帖子回复数

**管理员删除回复**：

1. 管理员在回复旁点击"删除"按钮
2. 弹出对话框：
   - 选择删除方式（软删除/硬删除）
   - 填写删除原因（必填）
3. 管理员点击"确认删除"
4. 系统执行删除操作
5. 记录操作日志
6. 显示"回复已删除"提示

---

### 5. 点赞帖子

#### 5.1 业务场景

**使用场景**：用户看到喜欢或有帮助的帖子，想表示认可。

**用户故事**：

- 作为一个论坛用户，我希望能够给喜欢的帖子点赞，表达我的认可。
- 作为一个论坛用户，我希望通过点赞数快速发现优质内容。

#### 5.2 功能说明

用户可以给帖子点赞或取消点赞。

**操作选项**：

- 点赞：增加帖子点赞数
- 取消点赞：减少帖子点赞数

**显示状态**：

- 未点赞：空心图标
- 已点赞：实心图标（高亮显示）
- 显示点赞总数

#### 5.3 业务规则

**点赞权限**：

- 需要登录
- 所有用户都可以点赞

**点赞限制**：

- 每个用户对每篇帖子只能点赞一次
- 可以随时取消点赞
- 不能给自己的帖子点赞

**点赞统计**：

- 点赞后，帖子点赞数 +1
- 取消点赞后，帖子点赞数 -1
- 实时更新点赞数

#### 5.4 交互流程

**点赞**：

1. 用户在帖子详情页点击"点赞"按钮
2. 图标变为实心（高亮）
3. 点赞数 +1
4. 显示短暂的动画效果

**取消点赞**：

1. 用户在已点赞的帖子上点击"点赞"按钮
2. 图标变为空心（取消高亮）
3. 点赞数 -1

---

### 6. 收藏帖子

#### 6.1 业务场景

**使用场景**：用户看到有价值的帖子，想保存起来以后查看。

**用户故事**：

- 作为一个论坛用户，我希望能够收藏有价值的帖子，方便以后查找。
- 作为一个论坛用户，我希望在个人中心查看我收藏的所有帖子。

#### 6.2 功能说明

用户可以收藏帖子或取消收藏。

**操作选项**：

- 收藏：将帖子添加到收藏列表
- 取消收藏：从收藏列表移除

**显示状态**：

- 未收藏：空心图标
- 已收藏：实心图标（高亮显示）
- 显示收藏总数

#### 6.3 业务规则

**收藏权限**：

- 需要登录
- 所有用户都可以收藏

**收藏限制**：

- 每个用户对每篇帖子只能收藏一次
- 可以随时取消收藏
- 可以收藏自己的帖子

**收藏统计**：

- 收藏后，帖子收藏数 +1
- 取消收藏后，帖子收藏数 -1
- 实时更新收藏数

**收藏列表**：

- 用户可以在"我的收藏"页面查看所有收藏的帖子
- 按收藏时间倒序显示
- 支持分页

#### 6.4 交互流程

**收藏**：

1. 用户在帖子详情页点击"收藏"按钮
2. 图标变为实心（高亮）
3. 收藏数 +1
4. 显示"收藏成功"提示

**取消收藏**：

1. 用户在已收藏的帖子上点击"收藏"按钮
2. 图标变为空心（取消高亮）
3. 收藏数 -1
4. 显示"已取消收藏"提示

---

### 7. 查看我的收藏

#### 7.1 业务场景

**使用场景**：用户想查看自己收藏过的所有帖子。

**用户故事**：

- 作为一个论坛用户，我希望能够查看我的收藏列表，快速找到之前保存的帖子。

#### 7.2 功能说明

用户可以在"我的收藏"页面查看所有收藏的帖子。

**显示信息**：

- 与帖子列表相同的显示格式
- 默认按收藏时间倒序

**操作功能**：

- 点击帖子标题查看详情
- 取消收藏

#### 7.3 业务规则

**查看权限**：

- 用户只能查看自己的收藏列表
- 无法查看他人的收藏

**显示规则**：

- 仅显示未删除的帖子
- 如果帖子被删除，收藏记录自动移除
- 按收藏时间倒序排列

**分页规则**：

- 每页显示 20 条
- 支持翻页

#### 7.4 交互流程

1. 用户点击导航栏的"我的收藏"
2. 显示收藏的帖子列表
3. 用户可以点击帖子查看详情
4. 用户可以点击"取消收藏"移除帖子

---

### 8. 查看用户的回复历史

#### 8.1 业务场景

**使用场景**：在用户个人主页查看该用户发布的所有回复。

**用户故事**：

- 作为一个论坛用户，我希望在个人主页看到我发布过的所有回复。
- 作为一个论坛用户，我希望查看其他用户的回复历史，了解他们的观点。

#### 8.2 功能说明

查询指定用户发布的所有回复，支持分页和排序。

**显示信息**：

- 回复内容（前 100 字）
- 回复时间
- 所属帖子标题
- 楼层号

#### 8.3 业务规则

- 仅显示该用户发布的回复
- 不显示已删除的回复（本人可以看到自己被删除的回复）
- 默认按回复时间倒序

#### 8.4 调用说明

由 M2 用户管理模块在个人主页调用，展示用户的回复列表。

---

## 数据统计规则

### 回复数统计

**计数规则**：

- 每发布一条回复，帖子回复数 +1
- 删除回复后，帖子回复数 -1
- 仅统计未删除的回复

**显示规则**：

- 帖子列表显示回复数
- 帖子详情页显示回复数
- 个人主页统计显示总回复数

### 点赞数统计

**计数规则**：

- 用户点赞后，帖子点赞数 +1
- 用户取消点赞后，帖子点赞数 -1
- 每个用户对每篇帖子只能点赞一次

**显示规则**：

- 帖子列表显示点赞数
- 帖子详情页显示点赞数
- 个人主页统计显示获赞总数

### 收藏数统计

**计数规则**：

- 用户收藏后，帖子收藏数 +1
- 用户取消收藏后，帖子收藏数 -1
- 每个用户对每篇帖子只能收藏一次

**显示规则**：

- 帖子详情页显示收藏数
- 个人主页统计显示获收藏总数

---

## 权限验证

**操作权限**：

- 发布回复：需要登录
- 编辑回复：仅回复者（5 分钟内）或管理员
- 删除回复：仅回复者或管理员
- 点赞帖子：需要登录
- 收藏帖子：需要登录

**数据隔离**：

- 用户只能编辑/删除自己的回复
- 管理员可以操作任何回复
- 收藏列表仅本人可见

---

## 测试场景

### 1. 发布回复测试场景

| 场景编号 | 测试场景 | 操作步骤             | 预期结果                    |
| -------- | -------- | -------------------- | --------------------------- |
| TC-001   | 正常回复 | 输入内容，点击发布   | 回复成功，显示在回复列表    |
| TC-002   | 内容为空 | 不输入内容，点击发布 | 提示"请输入回复内容"        |
| TC-003   | 内容过短 | 输入 1 个字符        | 提示"回复内容至少 2 个字符" |
| TC-004   | 上传图片 | 上传符合规格的图片   | 图片成功插入到回复中        |
| TC-005   | 图片过大 | 上传超过 5MB 的图片  | 提示"图片大小不能超过 5MB"  |
| TC-006   | 楼层显示 | 发布多条回复         | 楼层号按顺序递增（1、2、3） |

### 2. 查看回复测试场景

| 场景编号 | 测试场景   | 操作步骤           | 预期结果             |
| -------- | ---------- | ------------------ | -------------------- |
| TC-101   | 查看回复   | 打开帖子详情页     | 显示所有回复列表     |
| TC-102   | 楼层顺序   | 查看回复列表       | 按时间顺序显示       |
| TC-103   | 格式显示   | 查看包含格式的回复 | 正确显示格式化内容   |
| TC-104   | 已删除回复 | 查看被删除的回复   | 显示"该回复已被删除" |

### 3. 编辑回复测试场景

| 场景编号 | 测试场景     | 操作步骤                 | 预期结果                   |
| -------- | ------------ | ------------------------ | -------------------------- |
| TC-201   | 正常编辑     | 5 分钟内编辑回复         | 编辑成功，显示"已编辑"标识 |
| TC-202   | 超时编辑     | 5 分钟后尝试编辑         | 无编辑按钮或提示"超时"     |
| TC-203   | 编辑他人回复 | 普通用户尝试编辑他人回复 | 无编辑按钮或提示"权限不足" |
| TC-204   | 管理员编辑   | 管理员编辑任意回复       | 编辑成功                   |

### 4. 删除回复测试场景

| 场景编号 | 测试场景       | 操作步骤                 | 预期结果                   |
| -------- | -------------- | ------------------------ | -------------------------- |
| TC-301   | 删除自己的回复 | 点击"删除"，确认         | 回复被软删除               |
| TC-302   | 删除他人回复   | 普通用户尝试删除他人回复 | 无删除按钮或提示"权限不足" |
| TC-303   | 管理员软删除   | 管理员软删除回复         | 显示"该回复已被删除"       |
| TC-304   | 管理员硬删除   | 管理员硬删除回复         | 回复完全移除               |
| TC-305   | 楼层号保留     | 删除某条回复             | 楼层号保留，显示已删除提示 |

### 5. 点赞测试场景

| 场景编号 | 测试场景     | 操作步骤           | 预期结果             |
| -------- | ------------ | ------------------ | -------------------- |
| TC-401   | 点赞帖子     | 点击点赞按钮       | 点赞数 +1，图标高亮  |
| TC-402   | 取消点赞     | 再次点击点赞按钮   | 点赞数 -1，图标取消  |
| TC-403   | 重复点赞     | 多次点击点赞按钮   | 只计算一次点赞       |
| TC-404   | 未登录点赞   | 未登录用户点击点赞 | 提示"请先登录"       |
| TC-405   | 点赞自己帖子 | 作者点赞自己的帖子 | 提示"不能给自己点赞" |

### 6. 收藏测试场景

| 场景编号 | 测试场景 | 操作步骤         | 预期结果            |
| -------- | -------- | ---------------- | ------------------- |
| TC-501   | 收藏帖子 | 点击收藏按钮     | 收藏数 +1，图标高亮 |
| TC-502   | 取消收藏 | 再次点击收藏按钮 | 收藏数 -1，图标取消 |
| TC-503   | 查看收藏 | 访问我的收藏页面 | 显示所有收藏的帖子  |
| TC-504   | 移除收藏 | 在收藏列表取消   | 帖子从列表移除      |

---

## 功能清单

### 普通用户功能

- [x] 发布回复
- [x] 查看回复列表
- [x] 编辑自己的回复（5 分钟内）
- [x] 删除自己的回复
- [x] 点赞帖子
- [x] 取消点赞
- [x] 收藏帖子
- [x] 取消收藏
- [x] 查看我的收藏
- [x] 查看自己的回复历史

### 管理员功能

- [x] 编辑任意回复
- [x] 删除任意回复（软删除/硬删除）
- [x] 查看所有回复

---

**文档版本：** v1.0（纯需求版）  
**创建日期：** 2025-10-27  
**最后更新：** 2025-10-27  
**文档类型：** 产品需求文档（PRD）
