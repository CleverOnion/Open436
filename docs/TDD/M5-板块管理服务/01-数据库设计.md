# M5 板块管理服务 - 数据库设计

## 文档信息

**服务名称**: 板块管理服务 (section-service)  
**数据库**: PostgreSQL 14+  
**Schema**: public（与 M1、M7 共享）  
**版本**: v1.0

---

## 目录

1. [设计原则](#设计原则)
2. [表结构设计](#表结构设计)
3. [索引设计](#索引设计)
4. [表关系](#表关系)
5. [初始数据](#初始数据)
6. [SQL 迁移脚本](#sql-迁移脚本)

---

## 设计原则

### 1. Schema 选择

**使用 public schema 的原因**:

- 板块数据量小（预期 < 100 条记录）
- 与 M7 的 files 表有外键关联（icon_file_id）
- 需要被 M3 内容服务频繁查询
- 简化跨服务查询的复杂度

### 2. 数据完整性

- 使用外键约束确保 icon_file_id 的有效性
- 使用唯一约束确保 slug 和 name 不重复
- 使用 CHECK 约束限制数据范围

### 3. 性能优化

- 为高频查询字段添加索引（slug, is_enabled, sort_order）
- 使用冗余字段 posts_count 避免关联查询
- 使用合适的数据类型减少存储空间

### 4. 扩展性

- 预留 description 字段支持富文本
- color 字段支持自定义主题
- sort_order 支持灵活排序

---

## 表结构设计

### sections 表（板块主表）

板块信息的核心存储表，包含板块的基本信息、配置和统计数据。

#### 表定义

```sql
CREATE TABLE IF NOT EXISTS public.sections (
    -- 主键
    id SERIAL PRIMARY KEY,
    
    -- 板块标识（用于 URL）
    slug VARCHAR(20) NOT NULL UNIQUE,
    
    -- 板块名称
    name VARCHAR(50) NOT NULL UNIQUE,
    
    -- 板块描述
    description TEXT,
    
    -- 板块图标（外键关联 files 表）
    icon_file_id UUID,
    
    -- 板块颜色（HEX 格式）
    color VARCHAR(7) NOT NULL,
    
    -- 排序号（1-999）
    sort_order INTEGER NOT NULL DEFAULT 100,
    
    -- 启用状态
    is_enabled BOOLEAN NOT NULL DEFAULT TRUE,
    
    -- 帖子数量（冗余字段）
    posts_count INTEGER NOT NULL DEFAULT 0,
    
    -- 时间戳
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- 约束
    CONSTRAINT chk_sort_order CHECK (sort_order >= 1 AND sort_order <= 999),
    CONSTRAINT chk_posts_count CHECK (posts_count >= 0),
    CONSTRAINT chk_color_format CHECK (color ~ '^#[0-9A-Fa-f]{6}$'),
    CONSTRAINT chk_slug_format CHECK (slug ~ '^[a-z0-9_]+$'),
    
    -- 外键（关联 M7 的 files 表）
    CONSTRAINT fk_icon_file FOREIGN KEY (icon_file_id) 
        REFERENCES public.files(id) ON DELETE SET NULL
);
```

#### 字段说明

| 字段名        | 类型                      | 约束          | 说明                                    |
|---------------|---------------------------|---------------|-----------------------------------------|
| **id**        | SERIAL                    | PRIMARY KEY   | 自增主键                                |
| **slug**      | VARCHAR(20)               | NOT NULL, UNIQUE | 板块标识，用于 URL，仅小写字母、数字、下划线 |
| **name**      | VARCHAR(50)               | NOT NULL, UNIQUE | 板块名称，2-50 个字符                   |
| **description** | TEXT                    | -             | 板块描述，支持 Markdown                 |
| **icon_file_id** | UUID                   | -             | 板块图标文件 ID，外键关联 files 表      |
| **color**     | VARCHAR(7)                | NOT NULL      | 板块颜色，HEX 格式（如 #1976D2）        |
| **sort_order** | INTEGER                  | NOT NULL      | 排序号，1-999，数字越小越靠前           |
| **is_enabled** | BOOLEAN                  | NOT NULL      | 启用状态，FALSE 为禁用（软删除）        |
| **posts_count** | INTEGER                 | NOT NULL      | 板块内帖子数量，冗余字段，默认 0        |
| **created_at** | TIMESTAMP WITH TIME ZONE | NOT NULL      | 创建时间，UTC 时区                      |
| **updated_at** | TIMESTAMP WITH TIME ZONE | NOT NULL      | 最后更新时间，UTC 时区                  |

#### 字段约束说明

**1. slug 约束**:
- 格式: 仅小写字母、数字、下划线
- 长度: 3-20 个字符
- 唯一性: 全局唯一
- 用途: URL 路径（如 `/sections/tech`）

**2. name 约束**:
- 长度: 2-50 个字符
- 唯一性: 全局唯一
- 用途: 显示名称

**3. color 约束**:
- 格式: HEX 颜色码（`#RRGGBB`）
- 示例: `#1976D2`, `#9C27B0`
- 用途: UI 展示（徽章、标签）

**4. sort_order 约束**:
- 范围: 1-999
- 用途: 控制板块显示顺序
- 相同序号: 按 id 升序次要排序

**5. posts_count 约束**:
- 范围: >= 0
- 用途: 显示板块活跃度
- 更新时机: M3 创建/删除帖子时

---

## 索引设计

### 1. 主键索引

```sql
-- 自动创建
PRIMARY KEY (id)
```

**用途**: 按 ID 查询板块

### 2. slug 唯一索引

```sql
CREATE UNIQUE INDEX idx_sections_slug ON public.sections(slug);
```

**用途**: 
- 通过 slug 查询板块（高频）
- 确保 slug 唯一性

**查询示例**:
```sql
SELECT * FROM sections WHERE slug = 'tech';
```

### 3. name 唯一索引

```sql
CREATE UNIQUE INDEX idx_sections_name ON public.sections(name);
```

**用途**: 
- 验证板块名称唯一性
- 按名称搜索板块

### 4. sort_order 索引

```sql
CREATE INDEX idx_sections_sort_order ON public.sections(sort_order, id);
```

**用途**: 
- 获取板块列表时按排序号排序
- 组合索引（sort_order + id）保证稳定排序

**查询示例**:
```sql
SELECT * FROM sections 
WHERE is_enabled = TRUE 
ORDER BY sort_order ASC, id ASC;
```

### 5. is_enabled 索引

```sql
CREATE INDEX idx_sections_is_enabled ON public.sections(is_enabled);
```

**用途**: 
- 筛选启用/禁用的板块
- 与 sort_order 索引配合使用

**查询示例**:
```sql
SELECT * FROM sections WHERE is_enabled = TRUE;
```

### 6. 复合索引（优化查询）

```sql
CREATE INDEX idx_sections_enabled_sort ON public.sections(is_enabled, sort_order, id);
```

**用途**: 
- 覆盖最常见的查询场景
- 同时筛选启用状态和排序

**查询示例**:
```sql
SELECT id, slug, name, color, posts_count 
FROM sections 
WHERE is_enabled = TRUE 
ORDER BY sort_order, id;
```

---

## 表关系

### 1. 与 files 表的关系（M7 文件服务）

```
sections.icon_file_id → files.id (M7)
```

**关系类型**: 多对一（可选）  
**外键策略**: ON DELETE SET NULL  
**说明**: 板块图标存储在 M7 文件服务，删除文件时将 icon_file_id 设为 NULL

**查询示例**:
```sql
-- 获取板块及其图标 URL
SELECT 
    s.id,
    s.slug,
    s.name,
    f.file_url AS icon_url
FROM sections s
LEFT JOIN files f ON s.icon_file_id = f.id
WHERE s.is_enabled = TRUE;
```

### 2. 与 posts 表的关系（M3 内容服务）

```
posts.section_id → sections.id (M3)
```

**关系类型**: 一对多  
**外键策略**: ON DELETE RESTRICT（防止删除有帖子的板块）  
**说明**: 每个帖子属于一个板块，板块下可以有多个帖子

**注意**: posts 表由 M3 服务管理，外键在 M3 的数据库中定义

**业务规则**:
- 删除板块前需确保 posts_count = 0
- 禁用板块不影响已有帖子的访问
- 禁用板块后不允许发布新帖

---

## 初始数据

### 预设 6 个板块

系统初始化时，需要插入以下 6 个预设板块：

```sql
INSERT INTO public.sections (slug, name, description, color, sort_order, is_enabled, posts_count) 
VALUES
    ('tech', '技术交流', '分享编程技术和开发经验，讨论最新技术趋势', '#1976D2', 1, TRUE, 0),
    ('design', '设计分享', 'UI/UX 设计作品展示、设计心得分享', '#9C27B0', 2, TRUE, 0),
    ('discuss', '综合讨论', '各类话题的自由讨论空间', '#4CAF50', 3, TRUE, 0),
    ('question', '问答求助', '技术问题求助、疑难解答互助', '#FF9800', 4, TRUE, 0),
    ('share', '资源分享', '开发工具、学习教程、开源项目推荐', '#00BCD4', 5, TRUE, 0),
    ('announce', '公告通知', '官方公告、重要通知、系统更新', '#F44336', 6, TRUE, 0)
ON CONFLICT (slug) DO NOTHING;
```

### 板块详细说明

| slug     | name     | description                      | color   | sort_order | 使用场景              |
|----------|----------|----------------------------------|---------|------------|-----------------------|
| tech     | 技术交流 | 分享编程技术和开发经验           | #1976D2 | 1          | 技术讨论、框架对比    |
| design   | 设计分享 | UI/UX 设计作品和心得             | #9C27B0 | 2          | 设计作品、灵感分享    |
| discuss  | 综合讨论 | 各类话题的自由讨论               | #4CAF50 | 3          | 日常交流、开放话题    |
| question | 问答求助 | 技术问题求助和解答               | #FF9800 | 4          | 问题求助、技术答疑    |
| share    | 资源分享 | 工具、教程等资源推荐             | #00BCD4 | 5          | 工具推荐、教程分享    |
| announce | 公告通知 | 官方公告和重要通知               | #F44336 | 6          | 系统公告、活动通知    |

---

## SQL 迁移脚本

### 完整迁移脚本（V1__create_sections_table.sql）

```sql
-- =====================================================
-- M5 板块管理服务 - 数据库迁移脚本
-- 版本: V1
-- 创建日期: 2025-11-04
-- 说明: 创建 sections 表及相关索引
-- =====================================================

-- 1. 创建 sections 表
CREATE TABLE IF NOT EXISTS public.sections (
    id SERIAL PRIMARY KEY,
    slug VARCHAR(20) NOT NULL UNIQUE,
    name VARCHAR(50) NOT NULL UNIQUE,
    description TEXT,
    icon_file_id UUID,
    color VARCHAR(7) NOT NULL,
    sort_order INTEGER NOT NULL DEFAULT 100,
    is_enabled BOOLEAN NOT NULL DEFAULT TRUE,
    posts_count INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_sort_order CHECK (sort_order >= 1 AND sort_order <= 999),
    CONSTRAINT chk_posts_count CHECK (posts_count >= 0),
    CONSTRAINT chk_color_format CHECK (color ~ '^#[0-9A-Fa-f]{6}$'),
    CONSTRAINT chk_slug_format CHECK (slug ~ '^[a-z0-9_]+$'),
    CONSTRAINT fk_icon_file FOREIGN KEY (icon_file_id) 
        REFERENCES public.files(id) ON DELETE SET NULL
);

-- 2. 创建索引
CREATE UNIQUE INDEX IF NOT EXISTS idx_sections_slug 
    ON public.sections(slug);

CREATE UNIQUE INDEX IF NOT EXISTS idx_sections_name 
    ON public.sections(name);

CREATE INDEX IF NOT EXISTS idx_sections_sort_order 
    ON public.sections(sort_order, id);

CREATE INDEX IF NOT EXISTS idx_sections_is_enabled 
    ON public.sections(is_enabled);

CREATE INDEX IF NOT EXISTS idx_sections_enabled_sort 
    ON public.sections(is_enabled, sort_order, id);

-- 3. 创建更新时间触发器函数（如果不存在）
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 4. 创建触发器（自动更新 updated_at）
DROP TRIGGER IF EXISTS update_sections_updated_at ON public.sections;
CREATE TRIGGER update_sections_updated_at
    BEFORE UPDATE ON public.sections
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 5. 插入初始数据（6 个预设板块）
INSERT INTO public.sections (slug, name, description, color, sort_order, is_enabled, posts_count) 
VALUES
    ('tech', '技术交流', '分享编程技术和开发经验，讨论最新技术趋势', '#1976D2', 1, TRUE, 0),
    ('design', '设计分享', 'UI/UX 设计作品展示、设计心得分享', '#9C27B0', 2, TRUE, 0),
    ('discuss', '综合讨论', '各类话题的自由讨论空间', '#4CAF50', 3, TRUE, 0),
    ('question', '问答求助', '技术问题求助、疑难解答互助', '#FF9800', 4, TRUE, 0),
    ('share', '资源分享', '开发工具、学习教程、开源项目推荐', '#00BCD4', 5, TRUE, 0),
    ('announce', '公告通知', '官方公告、重要通知、系统更新', '#F44336', 6, TRUE, 0)
ON CONFLICT (slug) DO NOTHING;

-- 6. 添加表注释
COMMENT ON TABLE public.sections IS '板块表 - 论坛板块信息';
COMMENT ON COLUMN public.sections.id IS '板块ID（主键）';
COMMENT ON COLUMN public.sections.slug IS '板块标识（用于URL，唯一）';
COMMENT ON COLUMN public.sections.name IS '板块名称（唯一）';
COMMENT ON COLUMN public.sections.description IS '板块描述（支持Markdown）';
COMMENT ON COLUMN public.sections.icon_file_id IS '板块图标文件ID（外键 → files.id）';
COMMENT ON COLUMN public.sections.color IS '板块颜色（HEX格式）';
COMMENT ON COLUMN public.sections.sort_order IS '排序号（1-999，越小越靠前）';
COMMENT ON COLUMN public.sections.is_enabled IS '启用状态（FALSE为禁用）';
COMMENT ON COLUMN public.sections.posts_count IS '帖子数量（冗余字段）';
COMMENT ON COLUMN public.sections.created_at IS '创建时间';
COMMENT ON COLUMN public.sections.updated_at IS '最后更新时间';

-- 7. 验证数据
SELECT 
    id,
    slug,
    name,
    color,
    sort_order,
    is_enabled,
    posts_count
FROM public.sections
ORDER BY sort_order;
```

### 执行迁移

#### 方式 1: 使用 psql 执行

```bash
# 连接到数据库
psql -h localhost -p 55432 -U open436 -d open436

# 执行迁移脚本
\i path/to/V1__create_sections_table.sql

# 验证表结构
\d sections

# 查看数据
SELECT * FROM sections;
```

#### 方式 2: 使用 Docker 执行

```bash
# 复制脚本到容器
docker cp V1__create_sections_table.sql open436-postgres-dev:/tmp/

# 进入容器执行
docker exec -it open436-postgres-dev psql -U open436 -d open436 -f /tmp/V1__create_sections_table.sql
```

#### 方式 3: 集成到 docker-compose 启动流程

在 `deploy/dev/db-init/` 目录下创建迁移脚本，会在首次启动时自动执行。

---

## 数据验证

### 验证表结构

```sql
-- 查看表定义
\d sections

-- 查看索引
\di sections*

-- 查看约束
SELECT 
    conname AS constraint_name,
    contype AS constraint_type,
    pg_get_constraintdef(oid) AS definition
FROM pg_constraint
WHERE conrelid = 'sections'::regclass;
```

### 验证初始数据

```sql
-- 查看所有板块
SELECT 
    id,
    slug,
    name,
    color,
    sort_order,
    is_enabled,
    posts_count,
    created_at
FROM sections
ORDER BY sort_order;

-- 验证数据完整性
SELECT 
    COUNT(*) AS total_sections,
    SUM(CASE WHEN is_enabled THEN 1 ELSE 0 END) AS enabled_sections,
    SUM(posts_count) AS total_posts
FROM sections;
```

### 测试约束

```sql
-- 测试 slug 唯一性（应该失败）
INSERT INTO sections (slug, name, color, sort_order) 
VALUES ('tech', '测试板块', '#000000', 10);
-- ERROR: duplicate key value violates unique constraint "sections_slug_key"

-- 测试 color 格式约束（应该失败）
INSERT INTO sections (slug, name, color, sort_order) 
VALUES ('test', '测试板块', 'blue', 10);
-- ERROR: new row violates check constraint "chk_color_format"

-- 测试 sort_order 范围约束（应该失败）
INSERT INTO sections (slug, name, color, sort_order) 
VALUES ('test', '测试板块', '#000000', 1000);
-- ERROR: new row violates check constraint "chk_sort_order"
```

---

## 性能分析

### 查询性能测试

```sql
-- 开启查询分析
EXPLAIN ANALYZE
SELECT * FROM sections 
WHERE is_enabled = TRUE 
ORDER BY sort_order, id;

-- 预期使用索引: idx_sections_enabled_sort
-- 执行时间: < 1ms（数据量小）
```

### 索引使用情况

```sql
-- 查看索引统计
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan AS index_scans,
    idx_tup_read AS tuples_read,
    idx_tup_fetch AS tuples_fetched
FROM pg_stat_user_indexes
WHERE tablename = 'sections';
```

---

## 数据备份与恢复

### 备份板块数据

```bash
# 仅备份 sections 表数据
pg_dump -h localhost -p 55432 -U open436 -d open436 \
  --table=sections --data-only > sections_backup.sql

# 备份表结构 + 数据
pg_dump -h localhost -p 55432 -U open436 -d open436 \
  --table=sections > sections_full_backup.sql
```

### 恢复板块数据

```bash
# 恢复数据
psql -h localhost -p 55432 -U open436 -d open436 < sections_backup.sql
```

---

## 扩展字段（未来）

如果需要扩展功能，可以考虑添加以下字段：

```sql
-- 添加板块规则说明
ALTER TABLE sections ADD COLUMN rules TEXT;

-- 添加板块管理员（JSON 数组）
ALTER TABLE sections ADD COLUMN moderators JSONB DEFAULT '[]'::jsonb;

-- 添加板块统计缓存更新时间
ALTER TABLE sections ADD COLUMN stats_updated_at TIMESTAMP WITH TIME ZONE;

-- 添加板块权限配置
ALTER TABLE sections ADD COLUMN permissions JSONB DEFAULT '{}'::jsonb;
```

---

## 总结

### 关键设计决策

1. **使用 public schema**: 简化跨服务查询
2. **外键关联 files 表**: 利用 M7 的文件管理能力
3. **冗余 posts_count 字段**: 避免频繁关联查询
4. **软删除策略**: 使用 is_enabled 而非物理删除
5. **复合索引优化**: 覆盖最常见的查询场景

### 性能特点

- ✅ 表数据量小（< 100 条），查询性能优秀
- ✅ 索引覆盖所有关键查询场景
- ✅ 触发器自动更新 updated_at
- ✅ 约束保证数据完整性

### 维护建议

- 定期检查 posts_count 准确性（与实际帖子数对比）
- 监控索引使用情况，移除未使用的索引
- 定期备份板块数据
- 谨慎使用 ALTER TABLE，避免锁表

---

**文档版本**: v1.0  
**创建日期**: 2025-11-04  
**最后更新**: 2025-11-04

