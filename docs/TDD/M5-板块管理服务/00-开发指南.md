# M5 板块管理服务 - 开发指南

## 文档信息

**服务名称**: 板块管理服务 (section-service)  
**技术栈**: Python 3.11+ + Django 4.2+ + Django REST Framework  
**版本**: v1.0

---

## 目录

1. [开发环境搭建](#开发环境搭建)
2. [项目结构](#项目结构)
3. [开发规范](#开发规范)
4. [代码风格](#代码风格)
5. [Git 工作流](#git-工作流)
6. [常见问题](#常见问题)

---

## 开发环境搭建

### 系统要求

- **操作系统**: Linux / macOS / Windows
- **Python**: 3.11+
- **PostgreSQL**: 14+
- **Git**: 2.30+
- **Docker**: 24+ (可选，用于运行基础设施)

### 安装 Python 3.11+

#### macOS (使用 Homebrew)

```bash
brew install python@3.11
```

#### Ubuntu/Debian

```bash
sudo apt update
sudo apt install python3.11 python3.11-venv python3.11-dev
```

#### Windows

从官网下载安装: https://www.python.org/downloads/

### 安装 PostgreSQL

#### macOS

```bash
brew install postgresql@14
brew services start postgresql@14
```

#### Ubuntu/Debian

```bash
sudo apt install postgresql-14
sudo systemctl start postgresql
```

#### Windows

使用 Docker Desktop 或从官网安装: https://www.postgresql.org/download/windows/

---

## 创建项目

### 1. 克隆代码仓库

```bash
git clone https://github.com/CleverOnion/Open436.git
cd Open436
```

### 2. 创建项目目录

```bash
# 在 Open436 根目录下创建服务目录
mkdir -p Open436-SectionService
cd Open436-SectionService
```

### 3. 创建虚拟环境

```bash
# 创建虚拟环境
python3.11 -m venv venv

# 激活虚拟环境
# Linux/macOS:
source venv/bin/activate

# Windows:
venv\Scripts\activate
```

### 4. 安装 Django 和依赖

创建 `requirements.txt`:

```txt
# Django 核心
Django==4.2.7
djangorestframework==3.14.0

# 数据库
psycopg2-binary==2.9.9
dj-database-url==2.1.0

# API 文档
drf-spectacular==0.26.5

# CORS 支持
django-cors-headers==4.3.1

# 环境变量
python-dotenv==1.0.0

# 服务发现
python-consul==1.1.0

# HTTP 客户端（调用其他服务）
requests==2.31.0

# 日志增强
python-json-logger==2.0.7

# 时间处理
python-dateutil==2.8.2

# 验证工具
validators==0.22.0
```

创建 `requirements-dev.txt`:

```txt
# 开发依赖
-r requirements.txt

# 测试
pytest==7.4.3
pytest-django==4.7.0
pytest-cov==4.1.0
factory-boy==3.3.0

# 代码质量
black==23.12.1
flake8==6.1.0
isort==5.13.2
pylint==3.0.3

# 调试
ipython==8.18.1
django-debug-toolbar==4.2.0
```

安装依赖:

```bash
# 升级 pip
pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt

# 安装开发依赖
pip install -r requirements-dev.txt
```

### 5. 创建 Django 项目

```bash
# 创建 Django 项目（config 作为配置目录）
django-admin startproject config .

# 创建 apps 目录
mkdir apps
touch apps/__init__.py

# 创建 sections 应用
python manage.py startapp sections apps/sections

# 创建 core 应用（核心工具）
python manage.py startapp core apps/core
```

### 6. 配置环境变量

创建 `.env.example`:

```bash
# Django 设置
DEBUG=True
SECRET_KEY=your-secret-key-here-change-in-production
ALLOWED_HOSTS=localhost,127.0.0.1

# 数据库配置（连接到共享的 PostgreSQL，使用 public schema）
DATABASE_URL=postgresql://open436:open436@localhost:55432/open436

# 服务配置
SERVICE_PORT=8005
SERVICE_HOST=0.0.0.0

# Consul 配置
CONSUL_URL=http://localhost:8500
CONSUL_SERVICE_NAME=section-service
CONSUL_SERVICE_ID=section-service-1

# 其他服务地址（通过 Consul 服务发现）
AUTH_SERVICE_NAME=auth-service
FILE_SERVICE_NAME=file-service

# 日志级别
LOG_LEVEL=DEBUG
```

创建 `.env` 文件:

```bash
cp .env.example .env
# 根据实际情况修改配置
```

### 7. 配置 Django 设置

编辑 `config/settings.py`:

```python
import os
from pathlib import Path
from dotenv import load_dotenv
import dj_database_url

# 加载环境变量
load_dotenv()

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-me')
DEBUG = os.getenv('DEBUG', 'False') == 'True'
ALLOWED_HOSTS = os.getenv('ALLOWED_HOSTS', 'localhost').split(',')

# Application definition
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # Third-party apps
    'rest_framework',
    'corsheaders',
    'drf_spectacular',
    
    # Local apps
    'apps.sections',
    'apps.core',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'corsheaders.middleware.CorsMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'apps.core.middleware.TokenAuthMiddleware',  # 自定义 Token 验证中间件
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'

# Database
DATABASES = {
    'default': dj_database_url.config(
        default=os.getenv('DATABASE_URL'),
        conn_max_age=600
    )
}

# REST Framework 配置
REST_FRAMEWORK = {
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ],
    'DEFAULT_PARSER_CLASSES': [
        'rest_framework.parsers.JSONParser',
        'rest_framework.parsers.MultiPartParser',
    ],
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 20,
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
    'EXCEPTION_HANDLER': 'apps.core.exceptions.custom_exception_handler',
}

# DRF Spectacular (OpenAPI) 配置
SPECTACULAR_SETTINGS = {
    'TITLE': 'Open436 板块管理服务 API',
    'DESCRIPTION': 'M5 板块管理服务的 RESTful API 文档',
    'VERSION': '1.0.0',
    'SERVE_INCLUDE_SCHEMA': False,
}

# CORS 配置
CORS_ALLOW_ALL_ORIGINS = DEBUG
CORS_ALLOWED_ORIGINS = [
    'http://localhost:8000',  # Kong Gateway
    'http://localhost:3000',  # 前端开发服务器
]

# 国际化
LANGUAGE_CODE = 'zh-hans'
TIME_ZONE = 'Asia/Shanghai'
USE_I18N = True
USE_TZ = True

# 静态文件
STATIC_URL = 'static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'

# 默认主键字段类型
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# Consul 配置
CONSUL_URL = os.getenv('CONSUL_URL', 'http://localhost:8500')
CONSUL_SERVICE_NAME = os.getenv('CONSUL_SERVICE_NAME', 'section-service')
CONSUL_SERVICE_ID = os.getenv('CONSUL_SERVICE_ID', 'section-service-1')
SERVICE_PORT = int(os.getenv('SERVICE_PORT', '8005'))
SERVICE_HOST = os.getenv('SERVICE_HOST', '0.0.0.0')

# 其他服务名称（用于 Consul 服务发现）
AUTH_SERVICE_NAME = os.getenv('AUTH_SERVICE_NAME', 'auth-service')
FILE_SERVICE_NAME = os.getenv('FILE_SERVICE_NAME', 'file-service')

# 日志配置
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '[{levelname}] {asctime} {module} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
            'formatter': 'verbose',
        },
    },
    'root': {
        'handlers': ['console'],
        'level': os.getenv('LOG_LEVEL', 'INFO'),
    },
}
```

### 8. 配置 URL 路由

编辑 `config/urls.py`:

```python
from django.contrib import admin
from django.urls import path, include
from drf_spectacular.views import (
    SpectacularAPIView,
    SpectacularRedocView,
    SpectacularSwaggerView,
)

urlpatterns = [
    path('admin/', admin.site.urls),
    
    # API 路由
    path('api/', include('apps.sections.urls')),
    
    # API 文档
    path('api/schema/', SpectacularAPIView.as_view(), name='schema'),
    path('api/docs/', SpectacularSwaggerView.as_view(url_name='schema'), name='swagger-ui'),
    path('api/redoc/', SpectacularRedocView.as_view(url_name='schema'), name='redoc'),
    
    # 健康检查
    path('health/', include('apps.core.urls')),
]
```

### 9. 数据库准备

由于 sections 表在 public schema 中与其他服务共享，需要先通过 SQL 创建表结构：

```bash
# 连接到数据库（通过 Docker 或本地）
psql -h localhost -p 55432 -U open436 -d open436

# 执行建表 SQL（参考 01-数据库设计.md）
```

### 10. 运行开发服务器

```bash
# 执行 Django 迁移（仅创建 Django 内部表）
python manage.py migrate

# 创建超级用户（可选）
python manage.py createsuperuser

# 运行开发服务器
python manage.py runserver 8005
```

### 11. 验证服务

```bash
# 健康检查
curl http://localhost:8005/health/

# 获取板块列表
curl http://localhost:8005/api/sections

# 查看 API 文档
open http://localhost:8005/api/docs/
```

---

## 项目结构

```
Open436-SectionService/
├── manage.py                       # Django 管理脚本
├── requirements.txt                # 生产依赖
├── requirements-dev.txt            # 开发依赖
├── .env.example                    # 环境变量示例
├── .env                            # 环境变量（不提交到 Git）
├── .gitignore                      # Git 忽略文件
├── README.md                       # 项目说明
├── Dockerfile                      # Docker 镜像
├── docker-compose.yml              # 服务编排
│
├── config/                         # Django 配置目录
│   ├── __init__.py
│   ├── settings.py                 # Django 设置
│   ├── urls.py                     # 全局路由
│   ├── wsgi.py                     # WSGI 配置
│   └── asgi.py                     # ASGI 配置
│
├── apps/                           # 应用目录
│   ├── __init__.py
│   │
│   ├── sections/                   # 板块管理应用
│   │   ├── __init__.py
│   │   ├── models.py               # Section 模型
│   │   ├── serializers.py          # DRF 序列化器
│   │   ├── views.py                # 视图集 (SectionViewSet)
│   │   ├── urls.py                 # 路由配置
│   │   ├── permissions.py          # 权限类
│   │   ├── services.py             # 业务逻辑
│   │   ├── validators.py           # 自定义验证器
│   │   ├── admin.py                # Django Admin
│   │   ├── apps.py                 # 应用配置
│   │   ├── migrations/             # 数据库迁移
│   │   │   └── __init__.py
│   │   └── tests/                  # 测试
│   │       ├── __init__.py
│   │       ├── test_models.py
│   │       ├── test_serializers.py
│   │       ├── test_views.py
│   │       └── test_services.py
│   │
│   └── core/                       # 核心工具应用
│       ├── __init__.py
│       ├── middleware.py           # Token 验证中间件
│       ├── exceptions.py           # 自定义异常
│       ├── consul_client.py        # Consul 客户端
│       ├── service_client.py       # 服务间调用客户端
│       ├── utils.py                # 工具函数
│       ├── urls.py                 # 健康检查路由
│       ├── views.py                # 健康检查视图
│       └── apps.py
│
├── tests/                          # 集成测试
│   ├── __init__.py
│   ├── conftest.py                 # pytest 配置
│   └── test_integration.py         # 集成测试
│
├── staticfiles/                    # 静态文件（生产）
├── logs/                           # 日志文件
└── docs/                           # 文档
    └── api_examples.md             # API 使用示例
```

---

## 开发规范

### 1. 代码组织

#### Model 层（数据模型）

```python
# apps/sections/models.py
from django.db import models

class Section(models.Model):
    """板块模型 - 使用已有的 sections 表"""
    
    id = models.AutoField(primary_key=True)
    slug = models.SlugField(max_length=20, unique=True, db_index=True)
    name = models.CharField(max_length=50, unique=True)
    # ... 其他字段
    
    class Meta:
        db_table = 'sections'
        managed = False  # 不由 Django 管理迁移
        ordering = ['sort_order', 'id']
```

#### Serializer 层（序列化）

```python
# apps/sections/serializers.py
from rest_framework import serializers
from .models import Section

class SectionSerializer(serializers.ModelSerializer):
    """板块序列化器"""
    
    class Meta:
        model = Section
        fields = '__all__'
    
    def validate_slug(self, value):
        # 验证 slug 格式
        pass
```

#### ViewSet 层（视图）

```python
# apps/sections/views.py
from rest_framework import viewsets
from .models import Section
from .serializers import SectionSerializer

class SectionViewSet(viewsets.ModelViewSet):
    """板块视图集"""
    
    queryset = Section.objects.all()
    serializer_class = SectionSerializer
```

#### Service 层（业务逻辑）

```python
# apps/sections/services.py
class SectionService:
    """板块业务逻辑"""
    
    @staticmethod
    def increment_posts_count(section_id: int, value: int = 1):
        """更新板块帖子数"""
        pass
```

### 2. 命名规范

#### Python 命名

- **模块名**: 小写字母 + 下划线 (`section_service.py`)
- **类名**: 大驼峰 (`SectionSerializer`)
- **函数名**: 小写字母 + 下划线 (`get_enabled_sections()`)
- **常量**: 全大写 + 下划线 (`MAX_SECTION_NAME_LENGTH`)

#### API 路由命名

- **RESTful 风格**: `/api/sections`, `/api/sections/:id`
- **自定义动作**: `/api/sections/:id/enable`, `/api/sections/reorder`

### 3. 文档注释

```python
def create_section(slug: str, name: str, **kwargs) -> Section:
    """
    创建新板块
    
    Args:
        slug: 板块标识（英文小写、数字、下划线）
        name: 板块名称（2-20 个字符）
        **kwargs: 其他可选参数（description, color, sort_order 等）
    
    Returns:
        Section: 创建的板块实例
    
    Raises:
        ValidationError: 当参数验证失败时
        IntegrityError: 当 slug 或 name 重复时
    """
    pass
```

---

## 代码风格

### 1. 使用 Black 格式化

```bash
# 格式化所有代码
black .

# 格式化特定文件
black apps/sections/views.py

# 检查（不修改）
black --check .
```

配置 `pyproject.toml`:

```toml
[tool.black]
line-length = 100
target-version = ['py311']
include = '\.pyi?$'
exclude = '''
/(
    \.git
  | \.venv
  | venv
  | migrations
)/
'''
```

### 2. 使用 isort 排序导入

```bash
# 排序导入
isort .

# 检查
isort --check-only .
```

配置 `.isort.cfg`:

```ini
[settings]
profile = black
line_length = 100
```

### 3. 使用 flake8 检查代码质量

```bash
# 检查代码
flake8 .
```

配置 `.flake8`:

```ini
[flake8]
max-line-length = 100
exclude = .git,__pycache__,venv,.venv,migrations
ignore = E203, W503
```

---

## Git 工作流

### 1. 分支策略

- `main` - 主分支，生产环境
- `develop` - 开发分支
- `feature/xxx` - 功能分支
- `bugfix/xxx` - Bug 修复分支
- `hotfix/xxx` - 紧急修复分支

### 2. 提交规范

遵循 Conventional Commits:

```bash
# 格式
<type>(<scope>): <subject>

# 示例
feat(sections): 添加板块创建接口
fix(sections): 修复板块排序问题
docs(readme): 更新 API 文档
test(sections): 添加板块单元测试
refactor(serializers): 重构序列化器
```

**Type 类型**:
- `feat`: 新功能
- `fix`: Bug 修复
- `docs`: 文档更新
- `style`: 代码格式（不影响功能）
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建工具或辅助工具变动

### 3. Git 忽略文件

`.gitignore`:

```gitignore
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
venv/
.venv/
env/
ENV/

# Django
*.log
db.sqlite3
staticfiles/
media/

# IDE
.vscode/
.idea/
*.swp
*.swo

# 环境变量
.env
.env.local

# 测试
.pytest_cache/
.coverage
htmlcov/

# OS
.DS_Store
Thumbs.db
```

---

## 常见问题

### 1. 数据库连接失败

**问题**: `OperationalError: could not connect to server`

**解决**:
```bash
# 检查 PostgreSQL 是否运行
docker ps | grep postgres

# 检查端口是否正确
psql -h localhost -p 55432 -U open436 -d open436

# 检查 .env 中的 DATABASE_URL
```

### 2. 端口被占用

**问题**: `Error: That port is already in use`

**解决**:
```bash
# 查找占用端口的进程
lsof -i :8005

# 关闭进程
kill -9 <PID>

# 或更改端口
python manage.py runserver 8006
```

### 3. 迁移错误

**问题**: `django.db.utils.ProgrammingError: relation "sections" already exists`

**解决**:
```python
# 在 models.py 中设置 managed = False
class Section(models.Model):
    class Meta:
        managed = False  # 不让 Django 管理此表
```

### 4. Consul 服务注册失败

**问题**: `ConnectionError: Cannot connect to Consul`

**解决**:
```bash
# 检查 Consul 是否运行
curl http://localhost:8500/v1/status/leader

# 启动 Consul（如果使用 Docker）
cd deploy/dev
./start.ps1
```

### 5. Token 验证失败

**问题**: `401 Unauthorized` 调用管理员接口时

**解决**:
```bash
# 确保请求头包含正确的 Token
curl -H "Authorization: Bearer <token>" \
  http://localhost:8005/api/sections

# 检查 M1 认证服务是否运行
curl http://localhost:8001/api/auth/verify
```

---

## 性能优化建议

### 1. 数据库查询优化

```python
# 使用 select_related 减少查询次数
sections = Section.objects.select_related('icon_file').all()

# 使用 only() 只查询需要的字段
sections = Section.objects.only('id', 'name', 'slug').all()

# 使用 defer() 排除大字段
sections = Section.objects.defer('description').all()
```

### 2. 缓存策略

```python
from django.core.cache import cache

def get_enabled_sections():
    """获取启用的板块列表（带缓存）"""
    cache_key = 'sections:enabled'
    sections = cache.get(cache_key)
    
    if sections is None:
        sections = list(Section.objects.filter(is_enabled=True))
        cache.set(cache_key, sections, 300)  # 缓存 5 分钟
    
    return sections
```

### 3. 批量操作

```python
# 使用 bulk_create 批量创建
Section.objects.bulk_create([
    Section(slug='tech', name='技术交流'),
    Section(slug='design', name='设计分享'),
])

# 使用 bulk_update 批量更新
sections = Section.objects.all()
for section in sections:
    section.sort_order += 1
Section.objects.bulk_update(sections, ['sort_order'])
```

---

## 下一步

1. 阅读 [01-数据库设计.md](./01-数据库设计.md) - 了解数据表结构
2. 阅读 [02-API接口设计.md](./02-API接口设计.md) - 学习 API 规范
3. 阅读 [03-Django模型设计.md](./03-Django模型设计.md) - 实现数据模型
4. 开始开发！

---

**文档版本**: v1.0  
**创建日期**: 2025-11-04  
**最后更新**: 2025-11-04

