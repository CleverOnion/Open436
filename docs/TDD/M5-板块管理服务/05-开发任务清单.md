# M5 板块管理服务 - 开发任务清单

## 文档信息

**服务名称**: 板块管理服务 (section-service)  
**技术栈**: Python 3.11+ + Django 4.2+ + Django REST Framework  
**版本**: v1.0

---

## 目录

1. [开发阶段概述](#开发阶段概述)
2. [阶段 1: 环境搭建](#阶段-1-环境搭建)
3. [阶段 2: 数据模型实现](#阶段-2-数据模型实现)
4. [阶段 3: API 实现](#阶段-3-api-实现)
5. [阶段 4: 权限控制](#阶段-4-权限控制)
6. [阶段 5: 服务集成](#阶段-5-服务集成)
7. [阶段 6: 测试与部署](#阶段-6-测试与部署)
8. [开发进度跟踪](#开发进度跟踪)

---

## 开发阶段概述

### 总体规划

| 阶段 | 名称           | 预计工时 | 优先级 | 依赖关系 |
|------|----------------|----------|--------|----------|
| 1    | 环境搭建       | 4 小时   | P0     | 无       |
| 2    | 数据模型实现   | 6 小时   | P0     | 阶段 1   |
| 3    | API 实现       | 12 小时  | P0     | 阶段 2   |
| 4    | 权限控制       | 8 小时   | P0     | 阶段 3   |
| 5    | 服务集成       | 10 小时  | P1     | 阶段 4   |
| 6    | 测试与部署     | 8 小时   | P1     | 阶段 5   |

**总预计工时**: 48 小时（约 6 个工作日）

### 开发流程

```
阶段 1: 环境搭建
    ↓
阶段 2: 数据模型实现
    ↓
阶段 3: API 实现
    ↓
阶段 4: 权限控制
    ↓
阶段 5: 服务集成
    ↓
阶段 6: 测试与部署
```

---

## 阶段 1: 环境搭建

**目标**: 搭建 Django 开发环境，配置项目基础结构

**预计工时**: 4 小时

### 1.1 安装 Python 和依赖

- [ ] 安装 Python 3.11+
- [ ] 创建虚拟环境
- [ ] 安装 Django 4.2+
- [ ] 安装 Django REST Framework
- [ ] 安装其他依赖（见 requirements.txt）

**验收标准**:
```bash
python --version  # 3.11+
pip list | grep Django  # 4.2+
```

**预计工时**: 1 小时

---

### 1.2 创建 Django 项目

- [ ] 使用 `django-admin` 创建项目
- [ ] 创建 `apps` 目录
- [ ] 创建 `sections` 应用
- [ ] 创建 `core` 应用（核心工具）

**命令**:
```bash
django-admin startproject config .
mkdir apps
touch apps/__init__.py
python manage.py startapp sections apps/sections
python manage.py startapp core apps/core
```

**验收标准**:
- 项目结构完整
- 可以运行 `python manage.py runserver`

**预计工时**: 1 小时

---

### 1.3 配置 Django 设置

- [ ] 配置 `settings.py`
  - [ ] 添加 `rest_framework`
  - [ ] 添加 `corsheaders`
  - [ ] 添加 `drf_spectacular`
  - [ ] 配置数据库连接（PostgreSQL）
  - [ ] 配置 REST Framework
  - [ ] 配置 CORS
  - [ ] 配置日志
- [ ] 创建 `.env` 文件
- [ ] 配置环境变量

**验收标准**:
- Django 可以连接到数据库
- API 文档可以访问（/api/docs/）

**预计工时**: 1.5 小时

---

### 1.4 配置 URL 路由

- [ ] 配置全局 URL（`config/urls.py`）
- [ ] 配置应用 URL（`apps/sections/urls.py`）
- [ ] 配置 API 文档路由
- [ ] 配置健康检查路由

**验收标准**:
- 访问 `/health/` 返回健康状态
- 访问 `/api/docs/` 显示 Swagger UI

**预计工时**: 0.5 小时

---

## 阶段 2: 数据模型实现

**目标**: 实现 Section 模型和相关业务逻辑

**预计工时**: 6 小时

### 2.1 创建数据库表

- [ ] 编写 SQL 建表脚本（`V1__create_sections_table.sql`）
- [ ] 创建 sections 表
- [ ] 创建索引
- [ ] 创建触发器（自动更新 updated_at）
- [ ] 插入初始数据（6 个预设板块）

**验收标准**:
```sql
SELECT * FROM sections;  -- 返回 6 条记录
\d sections  -- 显示表结构
```

**预计工时**: 2 小时

---

### 2.2 实现 Section 模型

- [ ] 编写 `Section` 模型（`apps/sections/models.py`）
  - [ ] 定义所有字段
  - [ ] 添加验证器
  - [ ] 设置 `managed=False`
  - [ ] 配置 Meta 类
- [ ] 实现类方法
  - [ ] `get_enabled_sections()`
  - [ ] `get_by_slug()`
- [ ] 实现实例方法
  - [ ] `increment_posts_count()`
  - [ ] `can_be_deleted()`
  - [ ] `disable()`
  - [ ] `enable()`

**验收标准**:
```python
# 可以查询板块
sections = Section.objects.all()
print(sections)
```

**预计工时**: 2 小时

---

### 2.3 Django Admin 配置

- [ ] 注册 Section 模型到 Admin
- [ ] 配置列表显示字段
- [ ] 配置搜索字段
- [ ] 配置过滤器

**验收标准**:
- 访问 `/admin/` 可以管理板块

**预计工时**: 1 小时

---

### 2.4 模型测试

- [ ] 编写模型单元测试（`tests/test_models.py`）
  - [ ] 测试模型创建
  - [ ] 测试字段验证
  - [ ] 测试类方法
  - [ ] 测试实例方法

**验收标准**:
```bash
python manage.py test apps.sections.tests.test_models
# All tests passed
```

**预计工时**: 1 小时

---

## 阶段 3: API 实现

**目标**: 实现所有 API 接口

**预计工时**: 12 小时

### 3.1 实现序列化器

- [ ] `SectionListSerializer` - 列表序列化器
- [ ] `SectionDetailSerializer` - 详情序列化器
- [ ] `SectionCreateSerializer` - 创建序列化器
  - [ ] 验证 slug 格式和唯一性
  - [ ] 验证 name 唯一性
  - [ ] 验证 color 格式
- [ ] `SectionUpdateSerializer` - 更新序列化器
- [ ] `SectionStatusSerializer` - 状态序列化器
- [ ] `SectionReorderSerializer` - 排序序列化器
- [ ] `SectionStatisticsSerializer` - 统计序列化器

**验收标准**:
```python
# 可以序列化板块
serializer = SectionListSerializer(section)
print(serializer.data)
```

**预计工时**: 3 小时

---

### 3.2 实现视图集 - 公开接口

- [ ] 实现 `SectionViewSet`
  - [ ] `list()` - 获取板块列表
  - [ ] `retrieve()` - 获取板块详情（支持 ID/slug）
  - [ ] 配置 `get_queryset()` - 权限过滤
  - [ ] 配置 `get_serializer_class()` - 动态序列化器
  - [ ] 配置 `get_permissions()` - 权限控制

**验收标准**:
```bash
curl http://localhost:8005/api/sections
# 返回板块列表
```

**预计工时**: 2 小时

---

### 3.3 实现视图集 - 管理员接口

- [ ] `create()` - 创建板块
- [ ] `update()` - 更新板块
- [ ] `destroy()` - 删除板块（软删除）
- [ ] `status()` - 启用/禁用板块（自定义 action）
- [ ] `reorder()` - 批量调整排序（自定义 action）
- [ ] `statistics()` - 获取统计数据（自定义 action）

**验收标准**:
```bash
curl -X POST http://localhost:8005/api/sections \
  -H "Authorization: Bearer {token}" \
  -d '{...}'
# 创建成功
```

**预计工时**: 4 小时

---

### 3.4 实现内部接口

- [ ] 实现 `InternalSectionViewSet`
  - [ ] `increment_posts()` - 更新板块帖子数

**验收标准**:
```bash
curl -X POST http://localhost:8005/internal/sections/1/increment-posts \
  -d '{"value": 1}'
# 更新成功
```

**预计工时**: 1 小时

---

### 3.5 统一响应格式

- [ ] 实现 `success_response()` 函数
- [ ] 实现 `error_response()` 函数
- [ ] 实现自定义异常处理器

**位置**: `apps/core/responses.py`

**验收标准**:
- 所有接口返回统一格式

**预计工时**: 1 小时

---

### 3.6 API 测试

- [ ] 编写视图测试（`tests/test_views.py`）
  - [ ] 测试公开接口
  - [ ] 测试管理员接口
  - [ ] 测试权限控制
  - [ ] 测试错误场景

**验收标准**:
```bash
python manage.py test apps.sections.tests.test_views
# All tests passed
```

**预计工时**: 1 小时

---

## 阶段 4: 权限控制

**目标**: 实现 Token 验证和权限管理

**预计工时**: 8 小时

### 4.1 实现 Consul 客户端

- [ ] 实现 `ConsulClient` 类（`apps/core/consul_client.py`）
  - [ ] `register_service()` - 注册服务
  - [ ] `deregister_service()` - 注销服务
  - [ ] `get_service()` - 获取服务地址

**验收标准**:
```python
consul_client = ConsulClient()
service = consul_client.get_service('auth-service')
print(service)  # {'address': '...', 'port': 8001}
```

**预计工时**: 2 小时

---

### 4.2 实现认证服务客户端

- [ ] 实现 `AuthServiceClient` 类（`apps/core/service_client.py`）
  - [ ] `verify_token()` - 验证 Token
  - [ ] 集成 Consul 服务发现
  - [ ] 添加重试机制

**验收标准**:
```python
auth_client = AuthServiceClient()
result = auth_client.verify_token(token)
print(result)  # {'valid': True, 'userId': 1, 'role': 'admin'}
```

**预计工时**: 2 小时

---

### 4.3 实现 Token 验证中间件

- [ ] 实现 `TokenAuthMiddleware`（`apps/core/middleware.py`）
  - [ ] 提取 Token
  - [ ] 调用 M1 验证
  - [ ] 将用户信息附加到 request
  - [ ] 处理验证失败
- [ ] 配置跳过路径（公开接口、健康检查、内部接口）

**验收标准**:
```bash
# 未认证访问管理接口
curl -X POST http://localhost:8005/api/sections
# 返回 401

# 认证后访问
curl -X POST http://localhost:8005/api/sections \
  -H "Authorization: Bearer {token}"
# 正常处理
```

**预计工时**: 2 小时

---

### 4.4 实现权限类

- [ ] 实现 `IsAdminUser` 权限类（`apps/core/permissions.py`）
  - [ ] 检查 `request.user_role == 'admin'`

**验收标准**:
```python
# 普通用户访问管理接口
# 返回 403 Forbidden
```

**预计工时**: 1 小时

---

### 4.5 权限测试

- [ ] 测试 Token 验证
- [ ] 测试管理员权限
- [ ] 测试普通用户访问限制

**预计工时**: 1 小时

---

## 阶段 5: 服务集成

**目标**: 集成 M1、M3、M7 服务

**预计工时**: 10 小时

### 5.1 集成 M7 文件服务

- [ ] 实现 `FileServiceClient`（`apps/core/service_client.py`）
  - [ ] `get_file_url()` - 获取文件 URL
  - [ ] `get_file_info()` - 获取文件信息
- [ ] 序列化器中获取图标 URL
  - [ ] 实现 `get_icon_url()` 方法
  - [ ] 添加缓存优化

**验收标准**:
```python
# 序列化器返回 icon_url
serializer = SectionListSerializer(section)
print(serializer.data['icon_url'])  # http://minio:9000/...
```

**预计工时**: 3 小时

---

### 5.2 提供内部接口给 M3

- [ ] 实现内部接口视图
  - [ ] 更新板块帖子数
- [ ] 编写接口文档
- [ ] 测试 M3 调用

**验收标准**:
```bash
# M3 可以更新帖子数
curl -X POST http://section-service:8005/internal/sections/1/increment-posts \
  -d '{"value": 1}'
```

**预计工时**: 2 小时

---

### 5.3 Consul 服务注册

- [ ] 实现启动时注册
  - [ ] 在 `AppConfig.ready()` 中注册
- [ ] 实现健康检查端点
  - [ ] 检查数据库连接
- [ ] 测试服务发现

**验收标准**:
```bash
# 在 Consul UI 中看到 section-service
curl http://localhost:8500/v1/catalog/service/section-service
```

**预计工时**: 2 小时

---

### 5.4 错误处理和重试

- [ ] 实现重试装饰器（`apps/core/utils.py`）
- [ ] 为服务调用添加重试
- [ ] 实现超时配置
- [ ] 添加日志记录

**验收标准**:
- 服务调用失败时自动重试
- 日志记录详细错误信息

**预计工时**: 2 小时

---

### 5.5 集成测试

- [ ] 编写集成测试（`tests/test_integration.py`）
  - [ ] 测试与 M1 的集成
  - [ ] 测试与 M7 的集成
  - [ ] 测试服务发现

**预计工时**: 1 小时

---

## 阶段 6: 测试与部署

**目标**: 完善测试，准备部署

**预计工时**: 8 小时

### 6.1 单元测试

- [ ] 完善模型测试
  - [ ] 测试所有字段验证
  - [ ] 测试所有方法
- [ ] 完善序列化器测试
  - [ ] 测试验证逻辑
- [ ] 完善视图测试
  - [ ] 测试所有 API 接口
  - [ ] 测试错误场景

**验收标准**:
```bash
python manage.py test
# All tests passed
```

**预计工时**: 3 小时

---

### 6.2 测试覆盖率

- [ ] 安装 coverage
- [ ] 运行覆盖率测试
- [ ] 补充缺失的测试

**目标**: 测试覆盖率 > 80%

**验收标准**:
```bash
coverage run --source='.' manage.py test
coverage report
# 覆盖率 > 80%
```

**预计工时**: 2 小时

---

### 6.3 API 文档

- [ ] 使用 drf-spectacular 生成 OpenAPI Schema
- [ ] 验证 Swagger UI 可访问
- [ ] 验证 ReDoc 可访问
- [ ] 编写 API 使用示例

**验收标准**:
- 访问 `/api/docs/` 显示完整 API 文档

**预计工时**: 1 小时

---

### 6.4 Docker 配置

- [ ] 编写 `Dockerfile`
- [ ] 编写 `docker-compose.yml`
- [ ] 构建镜像
- [ ] 测试容器运行

**验收标准**:
```bash
docker build -t section-service:latest .
docker run -d -p 8005:8005 section-service:latest
curl http://localhost:8005/health/
```

**预计工时**: 1.5 小时

---

### 6.5 部署文档

- [ ] 编写部署说明
- [ ] 编写环境变量配置说明
- [ ] 编写数据库初始化步骤
- [ ] 编写服务启动步骤

**预计工时**: 0.5 小时

---

## 开发进度跟踪

### 进度表

| 阶段 | 任务总数 | 已完成 | 进行中 | 未开始 | 进度 |
|------|---------|--------|--------|--------|------|
| 阶段 1 | 4 | 0 | 0 | 4 | 0% |
| 阶段 2 | 4 | 0 | 0 | 4 | 0% |
| 阶段 3 | 6 | 0 | 0 | 6 | 0% |
| 阶段 4 | 5 | 0 | 0 | 5 | 0% |
| 阶段 5 | 5 | 0 | 0 | 5 | 0% |
| 阶段 6 | 5 | 0 | 0 | 5 | 0% |
| **总计** | **29** | **0** | **0** | **29** | **0%** |

### 里程碑

| 里程碑 | 描述 | 预计完成日期 | 状态 |
|--------|------|--------------|------|
| M1 | 环境搭建完成 | D+1 | ⏳ 待开始 |
| M2 | 数据模型完成 | D+2 | ⏳ 待开始 |
| M3 | 公开 API 完成 | D+3 | ⏳ 待开始 |
| M4 | 管理员 API 完成 | D+4 | ⏳ 待开始 |
| M5 | 服务集成完成 | D+5 | ⏳ 待开始 |
| M6 | 测试与部署完成 | D+6 | ⏳ 待开始 |

---

## 质量检查清单

### 代码质量

- [ ] 代码符合 PEP 8 规范
- [ ] 使用 Black 格式化代码
- [ ] 使用 isort 排序导入
- [ ] 使用 flake8 检查代码质量
- [ ] 所有函数有文档字符串
- [ ] 关键逻辑有注释

### 测试质量

- [ ] 单元测试覆盖率 > 80%
- [ ] 所有 API 接口有测试
- [ ] 边界条件有测试
- [ ] 错误场景有测试
- [ ] 集成测试通过

### 文档质量

- [ ] API 文档完整
- [ ] 部署文档清晰
- [ ] 代码注释充分
- [ ] README 完善

### 安全检查

- [ ] Token 验证正确
- [ ] 权限控制严格
- [ ] SQL 注入防护
- [ ] XSS 防护
- [ ] 敏感信息不泄露

---

## 常见问题与解决方案

### 问题 1: 数据库连接失败

**症状**: Django 无法连接到 PostgreSQL

**解决**:
1. 检查 PostgreSQL 是否运行
2. 检查 `.env` 中的 `DATABASE_URL`
3. 检查防火墙配置

### 问题 2: Consul 服务注册失败

**症状**: 服务无法注册到 Consul

**解决**:
1. 检查 Consul 是否运行
2. 检查 `CONSUL_URL` 配置
3. 检查健康检查端点是否正常

### 问题 3: Token 验证失败

**症状**: 所有请求返回 401

**解决**:
1. 检查 M1 认证服务是否运行
2. 检查 Token 格式是否正确
3. 检查中间件配置

### 问题 4: 测试失败

**症状**: 单元测试或集成测试失败

**解决**:
1. 检查测试数据库配置
2. 检查测试数据是否正确
3. 查看详细错误信息

---

## 开发工具推荐

### IDE

- **PyCharm Professional** - 功能强大，Django 支持好
- **VS Code** - 轻量级，插件丰富

### VS Code 插件

- Python
- Django
- REST Client
- GitLens
- Docker

### 调试工具

- Django Debug Toolbar
- ipdb / pdb
- Postman / Insomnia

### 数据库工具

- pgAdmin
- DBeaver
- DataGrip

---

## 总结

### 开发要点

1. **遵循 Django 最佳实践**: 分层架构，代码模块化
2. **完善的测试**: 单元测试、集成测试、E2E 测试
3. **清晰的文档**: API 文档、开发文档、部署文档
4. **服务集成**: 完善的错误处理和重试机制
5. **性能优化**: 数据库查询优化、缓存策略

### 预期成果

- ✅ 完整的板块管理服务
- ✅ 9 个 API 接口全部实现
- ✅ 与 M1、M3、M7 集成完成
- ✅ 测试覆盖率 > 80%
- ✅ Docker 部署就绪
- ✅ 完善的文档

---

**文档版本**: v1.0  
**创建日期**: 2025-11-04  
**最后更新**: 2025-11-04

