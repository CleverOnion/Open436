# M7 文件存储服务 - 开发任务清单

## 文档信息

**服务名称**: 文件存储服务 (file-service)  
**技术栈**: Rust + Actix-web + PostgreSQL + Minio  
**版本**: v1.0

---

## 目录

1. [任务概览](#任务概览)
2. [阶段1: 基础框架（P0）](#阶段1-基础框架p0)
3. [阶段2: 存储抽象层（P0）](#阶段2-存储抽象层p0)
4. [阶段3: 核心API（P0）](#阶段3-核心apip0)
5. [阶段4: 生命周期管理（P1）](#阶段4-生命周期管理p1)
6. [阶段5: 自动化功能（P1）](#阶段5-自动化功能p1)
7. [阶段6: 测试与优化（P2）](#阶段6-测试与优化p2)
8. [验收标准](#验收标准)

---

## 任务概览

### 开发阶段划分

| 阶段 | 名称           | 优先级 | 预计工期 | 依赖   |
| ---- | -------------- | ------ | -------- | ------ |
| 1    | 基础框架       | P0     | 2 天     | 无     |
| 2    | 存储抽象层     | P0     | 2 天     | 阶段 1 |
| 3    | 核心 API       | P0     | 3 天     | 阶段 2 |
| 4    | 生命周期管理   | P1     | 2 天     | 阶段 3 |
| 5    | 自动化功能     | P1     | 2 天     | 阶段 4 |
| 6    | 测试与优化     | P2     | 3 天     | 阶段 5 |

**总计**: 约 14 个工作日

### 优先级说明

- **P0 (高优先级)**: 核心功能，必须完成
- **P1 (中优先级)**: 重要功能，建议完成
- **P2 (低优先级)**: 优化功能，可后续迭代

---

## 阶段1: 基础框架（P0）

### 目标

搭建 Rust + Actix-web 项目框架，完成数据库连接和配置管理。

### 任务清单

#### 1.1 项目初始化

- [ ] 创建 Rust 项目 `cargo new file-service --bin`
- [ ] 配置 `Cargo.toml` 依赖
  - [ ] actix-web = "4.4"
  - [ ] tokio = "1.35"
  - [ ] sqlx = "0.7" (postgres, runtime-tokio-native-tls, uuid, chrono)
  - [ ] serde = "1.0"
  - [ ] dotenvy = "0.15"
  - [ ] tracing = "0.1"
  - [ ] anyhow = "1.0"
  - [ ] thiserror = "1.0"
- [ ] 创建 `.env.example` 文件
- [ ] 创建 `.gitignore` 文件

**参考文档**: [00-开发指南.md](./00-开发指南.md#项目初始化)

#### 1.2 配置管理

- [ ] 实现 `config.rs` 配置结构
  - [ ] `ServerConfig`: 服务器配置
  - [ ] `DatabaseConfig`: 数据库配置
  - [ ] `StorageConfig`: 存储配置
  - [ ] `CleanupConfig`: 清理配置
- [ ] 实现 `Config::from_env()` 方法
- [ ] 测试配置加载

**文件**: `src/config.rs`

#### 1.3 数据库连接

- [ ] 实现数据库连接池 `db.rs`
- [ ] 配置 SQLx 连接参数（max_connections, timeout）
- [ ] 添加数据库健康检查
- [ ] 测试数据库连接

**文件**: `src/db.rs`

#### 1.4 数据库迁移

- [ ] 安装 `sqlx-cli`: `cargo install sqlx-cli --features postgres`
- [ ] 创建迁移文件：
  - [ ] `migrations/20251028_001_initial_schema.sql` - 创建 Schema 和表
  - [ ] `migrations/20251028_002_indexes.sql` - 创建索引
  - [ ] `migrations/20251028_003_triggers.sql` - 创建触发器
- [ ] 运行迁移: `sqlx migrate run`
- [ ] 验证表结构

**参考文档**: [01-数据库设计.md](./01-数据库设计.md#数据迁移)

#### 1.5 日志系统

- [ ] 配置 `tracing-subscriber`
- [ ] 实现日志中间件
- [ ] 测试日志输出（不同级别）

**文件**: `src/main.rs`

#### 1.6 错误处理

- [ ] 定义自定义错误类型 `FileError`
- [ ] 实现 `ResponseError` trait
- [ ] 定义错误码常量

**文件**: `src/utils/error.rs`

**验收标准**:

- ✅ 项目可成功编译: `cargo build`
- ✅ 数据库连接正常
- ✅ 日志正常输出
- ✅ 配置可从 `.env` 加载

---

## 阶段2: 存储抽象层（P0）

### 目标

实现存储后端抽象层，支持 S3（Minio）和本地存储。

### 任务清单

#### 2.1 定义 StorageBackend Trait

- [ ] 创建 `storage/backend.rs`
- [ ] 定义 `StorageBackend` trait
  - [ ] `upload()` 方法
  - [ ] `download()` 方法
  - [ ] `delete()` 方法
  - [ ] `get_url()` 方法
  - [ ] `exists()` 方法
- [ ] 添加 `#[async_trait]` 支持

**文件**: `src/storage/backend.rs`

**参考文档**: [03-存储抽象层设计.md](./03-存储抽象层设计.md#storagebackend-trait-定义)

#### 2.2 实现 S3StorageBackend

- [ ] 添加依赖: `aws-sdk-s3 = "1.8"`, `aws-config = "1.0"`
- [ ] 创建 `storage/s3.rs`
- [ ] 实现 S3 配置解析
- [ ] 实现 `upload()` 方法
- [ ] 实现 `download()` 方法
- [ ] 实现 `delete()` 方法
- [ ] 实现 `get_url()` 方法
- [ ] 实现 `exists()` 方法
- [ ] 支持 Path-Style URL（Minio）

**文件**: `src/storage/s3.rs`

#### 2.3 实现 LocalStorageBackend

- [ ] 创建 `storage/local.rs`
- [ ] 实现所有 `StorageBackend` 方法
- [ ] 创建存储目录
- [ ] 按日期分目录存储

**文件**: `src/storage/local.rs`

#### 2.4 存储工厂

- [ ] 创建 `storage/factory.rs`
- [ ] 实现 `create_storage()` 工厂方法
- [ ] 根据配置创建对应的存储实例
- [ ] 测试不同配置下的存储创建

**文件**: `src/storage/factory.rs`

#### 2.5 路径生成器

- [ ] 创建 `utils/path_generator.rs`
- [ ] 实现 `generate_storage_key()` - 生成 UUID 文件名
- [ ] 实现 `sanitize_filename()` - 清理文件名
- [ ] 实现 `validate_storage_key()` - 验证路径安全
- [ ] 测试路径生成

**文件**: `src/utils/path_generator.rs`

**验收标准**:

- ✅ S3 存储可正常上传/下载/删除文件（Minio）
- ✅ 本地存储可正常上传/下载/删除文件
- ✅ 工厂模式可根据配置切换存储后端
- ✅ 路径生成安全且唯一

---

## 阶段3: 核心API（P0）

### 目标

实现文件上传、查询、URL 获取等核心 API。

### 任务清单

#### 3.1 数据模型

- [ ] 创建 `models/enums.rs`
  - [ ] `FileType` 枚举
  - [ ] `FileStatus` 枚举
- [ ] 创建 `models/file.rs`
  - [ ] `File` 结构体
  - [ ] 数据库映射
- [ ] 创建 `models/file_usage.rs`
  - [ ] `FileUsage` 结构体

**文件**: `src/models/`

#### 3.2 文件验证器

- [ ] 创建 `utils/validator.rs`
- [ ] 实现文件类型验证（魔数）
  - [ ] 添加依赖: `infer = "0.15"`
  - [ ] 实现 `validate_file_type()`
- [ ] 实现文件大小验证
  - [ ] 实现 `get_size_limit()`
  - [ ] 实现 `validate_file_size()`
- [ ] 实现 MIME 类型验证
  - [ ] 实现 `validate_mime_type()`
- [ ] 实现扩展名验证
  - [ ] 实现 `validate_extension()`

**文件**: `src/utils/validator.rs`

**参考文档**: [04-文件验证与安全.md](./04-文件验证与安全.md#文件类型验证)

#### 3.3 文件上传接口

- [ ] 创建 `handlers/upload.rs`
- [ ] 实现 `upload_handler()` 方法
  - [ ] 解析 multipart 表单
  - [ ] 验证文件类型和大小
  - [ ] 生成存储路径
  - [ ] 上传到存储后端
  - [ ] 保存元数据到数据库
  - [ ] 返回文件信息
- [ ] 实现身份认证中间件
- [ ] 测试上传接口

**文件**: `src/handlers/upload.rs`

**参考文档**: [02-API接口设计.md](./02-API接口设计.md#1-上传文件)

#### 3.4 文件查询接口

- [ ] 创建 `handlers/info.rs`
- [ ] 实现 `get_file_info_handler()` - 获取文件信息
- [ ] 实现 `get_file_url_handler()` - 获取文件 URL
- [ ] 测试查询接口

**文件**: `src/handlers/info.rs`

#### 3.5 批量查询接口

- [ ] 创建 `handlers/batch.rs`
- [ ] 实现 `batch_info_handler()` - 批量获取文件信息
- [ ] 限制批量查询数量（最多 100）
- [ ] 测试批量查询

**文件**: `src/handlers/batch.rs`

#### 3.6 路由配置

- [ ] 创建 `handlers/mod.rs`
- [ ] 实现 `configure_routes()` 方法
- [ ] 配置所有路由
- [ ] 添加 CORS 中间件
- [ ] 测试路由

**文件**: `src/handlers/mod.rs`

**验收标准**:

- ✅ 可通过 API 上传文件
- ✅ 文件类型和大小验证正常
- ✅ 可查询文件信息和 URL
- ✅ 批量查询正常工作

---

## 阶段4: 生命周期管理（P1）

### 目标

实现文件使用标记和删除功能。

### 任务清单

#### 4.1 使用标记接口

- [ ] 创建 `handlers/usage.rs`
- [ ] 实现 `mark_used_handler()` - 标记已使用
  - [ ] 验证文件存在
  - [ ] 插入 `file_usages` 记录
  - [ ] 更新文件状态为 `used`
- [ ] 实现 `mark_unused_handler()` - 标记未使用
  - [ ] 删除 `file_usages` 记录
  - [ ] 检查是否还有其他使用
  - [ ] 更新文件状态
- [ ] 测试使用标记

**文件**: `src/handlers/usage.rs`

**参考文档**: [02-API接口设计.md](./02-API接口设计.md#文件使用管理)

#### 4.2 文件删除接口

- [ ] 创建 `handlers/delete.rs`
- [ ] 实现 `delete_file_handler()` - 删除文件
  - [ ] 验证管理员权限
  - [ ] 从存储后端删除物理文件
  - [ ] 更新数据库状态为 `deleted`
  - [ ] 删除使用关联
  - [ ] 记录删除日志
- [ ] 测试删除接口

**文件**: `src/handlers/delete.rs`

#### 4.3 权限验证

- [ ] 创建 `middleware/auth.rs`
- [ ] 实现 `extract_user_id()` - 从 Kong 传递的请求头获取用户 ID
- [ ] 实现 `is_admin()` - 验证管理员权限
- [ ] 测试权限验证

**文件**: `src/middleware/auth.rs`

**验收标准**:

- ✅ 可标记文件为已使用/未使用
- ✅ 管理员可删除文件
- ✅ 非管理员无法删除文件
- ✅ 删除文件后无法访问

---

## 阶段5: 自动化功能（P1）

### 目标

实现定时清理任务和统计接口。

### 任务清单

#### 5.1 清理服务

- [ ] 创建 `services/cleanup_service.rs`
- [ ] 实现 `cleanup_unused_files()` 方法
  - [ ] 查询待清理文件
  - [ ] 批量删除物理文件
  - [ ] 更新数据库状态
  - [ ] 记录清理日志
- [ ] 实现 dry-run 模式
- [ ] 测试清理逻辑

**文件**: `src/services/cleanup_service.rs`

**参考文档**: [05-自动清理机制.md](./05-自动清理机制.md#清理服务实现)

#### 5.2 定时任务

- [ ] 添加依赖: `tokio-cron-scheduler = "0.9"`
- [ ] 创建 `scheduler/cleanup_job.rs`
- [ ] 实现 `start_cleanup_job()` 方法
- [ ] 配置 Cron 表达式
- [ ] 在 `main.rs` 中启动定时任务
- [ ] 测试定时任务

**文件**: `src/scheduler/cleanup_job.rs`

#### 5.3 手动清理接口

- [ ] 创建 `handlers/cleanup.rs`
- [ ] 实现 `cleanup_handler()` - 手动触发清理
- [ ] 支持 dry-run 参数
- [ ] 测试手动清理

**文件**: `src/handlers/cleanup.rs`

#### 5.4 统计接口

- [ ] 创建 `handlers/statistics.rs`
- [ ] 实现 `statistics_handler()` - 获取存储统计
  - [ ] 总文件数和大小
  - [ ] 按状态统计
  - [ ] 按类型统计
- [ ] 测试统计接口

**文件**: `src/handlers/statistics.rs`

#### 5.5 健康检查

- [ ] 创建 `handlers/health.rs`
- [ ] 实现 `health_handler()` - 健康检查
  - [ ] 检查数据库连接
  - [ ] 检查存储后端
- [ ] 测试健康检查

**文件**: `src/handlers/health.rs`

**验收标准**:

- ✅ 定时任务每天凌晨 2:00 自动执行
- ✅ 清理未使用且超过 30 天的文件
- ✅ 清理日志正确记录
- ✅ 可手动触发清理
- ✅ 统计接口返回正确数据

---

## 阶段6: 测试与优化（P2）

### 目标

编写测试用例，优化性能和代码质量。

### 任务清单

#### 6.1 单元测试

- [ ] 测试文件验证器
  - [ ] 测试文件类型检测
  - [ ] 测试文件大小验证
  - [ ] 测试 MIME 类型验证
- [ ] 测试路径生成器
  - [ ] 测试路径生成
  - [ ] 测试路径安全验证
- [ ] 测试存储后端
  - [ ] Mock S3 存储测试
  - [ ] Mock 本地存储测试

**文件**: `tests/unit/`

#### 6.2 集成测试

- [ ] 测试文件上传流程
- [ ] 测试文件查询流程
- [ ] 测试使用标记流程
- [ ] 测试删除流程
- [ ] 测试清理流程

**文件**: `tests/integration/`

#### 6.3 性能优化

- [ ] 优化数据库查询（添加索引）
- [ ] 优化批量操作
- [ ] 优化文件上传（流式处理）
- [ ] 添加缓存（可选）

#### 6.4 代码质量

- [ ] 运行 `cargo fmt` 格式化代码
- [ ] 运行 `cargo clippy` 检查代码
- [ ] 修复所有 clippy 警告
- [ ] 添加文档注释

#### 6.5 API 文档

- [ ] 使用 Swagger/OpenAPI 生成 API 文档
- [ ] 添加示例请求/响应
- [ ] 部署 API 文档

#### 6.6 部署准备

- [ ] 编写 `Dockerfile`
- [ ] 编写 `docker-compose.yml`
- [ ] 配置环境变量
- [ ] 测试 Docker 部署

**验收标准**:

- ✅ 测试覆盖率 > 80%
- ✅ 所有测试通过
- ✅ Clippy 无警告
- ✅ 性能满足要求（上传 < 1s）
- ✅ Docker 镜像可正常运行

---

## 验收标准

### 功能验收

| 功能             | 验收标准                                       |
| ---------------- | ---------------------------------------------- |
| 文件上传         | 可上传 JPG/PNG/GIF/SVG 文件，返回文件信息      |
| 文件查询         | 可通过文件 ID 查询文件信息和 URL               |
| 文件使用标记     | 可标记文件已使用/未使用，状态正确更新          |
| 文件删除         | 管理员可删除文件，物理文件和数据库记录均删除   |
| 批量查询         | 可批量查询最多 100 个文件信息                  |
| 定时清理         | 每天凌晨 2:00 自动清理未使用且超过 30 天的文件 |
| 手动清理         | 管理员可手动触发清理，支持 dry-run 模式        |
| 统计接口         | 可查询存储统计（总文件数、大小、按状态/类型）  |
| 健康检查         | 返回服务健康状态（数据库、存储后端）           |

### 非功能验收

| 指标         | 验收标准                |
| ------------ | ----------------------- |
| 性能         | 上传 5MB 文件 < 2s      |
| 并发         | 支持 100+ 并发上传      |
| 可用性       | 服务可用率 > 99.9%      |
| 安全性       | 所有文件验证正常        |
| 代码质量     | Clippy 无警告           |
| 测试覆盖率   | > 80%                   |
| 文档完整性   | 所有 API 有文档         |

---

## 里程碑

| 里程碑   | 完成时间   | 交付物                           |
| -------- | ---------- | -------------------------------- |
| **M1**   | 第 2 天    | 基础框架 + 数据库连接            |
| **M2**   | 第 4 天    | 存储抽象层 + S3/本地存储         |
| **M3**   | 第 7 天    | 核心 API（上传、查询）           |
| **M4**   | 第 9 天    | 生命周期管理（使用标记、删除）   |
| **M5**   | 第 11 天   | 自动化功能（定时清理、统计）     |
| **M6**   | 第 14 天   | 测试完成、文档完整、可部署       |

---

## 风险与应对

| 风险                 | 影响 | 概率 | 应对措施                       |
| -------------------- | ---- | ---- | ------------------------------ |
| Rust 学习曲线陡峭    | 高   | 中   | 提前学习，参考示例代码         |
| S3 SDK 集成复杂      | 中   | 低   | 参考官方文档和示例             |
| 定时任务不稳定       | 中   | 低   | 充分测试，添加监控告警         |
| 文件清理误删         | 高   | 低   | 添加 dry-run 模式，完善测试    |
| 存储空间不足         | 中   | 中   | 监控存储使用率，及时清理       |

---

**文档版本**: v1.0  
**创建日期**: 2025-10-28  
**最后更新**: 2025-10-28

