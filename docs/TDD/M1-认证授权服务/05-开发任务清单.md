# M1 è®¤è¯æˆæƒæœåŠ¡ - å¼€å‘ä»»åŠ¡æ¸…å•

## æ–‡æ¡£ä¿¡æ¯

**é¡¹ç›®åç§°**: Open436 è®¤è¯æˆæƒæœåŠ¡  
**æŠ€æœ¯æ–¹æ¡ˆ**: Sa-Token è‡ªåŠ¨ç»­ç­¾æ–¹æ¡ˆ  
**ç‰ˆæœ¬**: v3.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-XX  
**é¢„è®¡å·¥æœŸ**: 15 ä¸ªå·¥ä½œæ—¥

---

## ä»»åŠ¡çŠ¶æ€è¯´æ˜

| çŠ¶æ€æ ‡è¯† | çŠ¶æ€åç§° | è¯´æ˜                   |
| -------- | -------- | ---------------------- |
| ğŸ”µ       | å¾…å¼€å§‹   | ä»»åŠ¡æœªå¼€å§‹             |
| ğŸŸ¡       | è¿›è¡Œä¸­   | ä»»åŠ¡æ­£åœ¨è¿›è¡Œ           |
| ğŸŸ¢       | å·²å®Œæˆ   | ä»»åŠ¡å·²å®Œæˆï¼Œå¾…éªŒæ”¶     |
| âœ…       | å·²éªŒè¯   | ä»»åŠ¡å·²å®Œæˆå¹¶é€šè¿‡éªŒè¯   |
| â¸ï¸       | å·²æš‚åœ   | ä»»åŠ¡æš‚åœï¼Œç­‰å¾…å‰ç½®ä»»åŠ¡ |
| âŒ       | å·²å–æ¶ˆ   | ä»»åŠ¡å·²å–æ¶ˆ             |

---

## é¡¹ç›®è¿›åº¦æ¦‚è§ˆ

**æ•´ä½“è¿›åº¦**: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% (28/28 ä»»åŠ¡å®Œæˆ)

| é˜¶æ®µ               | ä»»åŠ¡æ•° | å·²å®Œæˆ | è¿›åº¦    |
| ------------------ | ------ | ------ | ------- |
| é˜¶æ®µ 1: ç¯å¢ƒå‡†å¤‡   | 4      | 4      | âœ… 100% |
| é˜¶æ®µ 2: æ•°æ®åº“è®¾è®¡ | 3      | 3      | âœ… 100% |
| é˜¶æ®µ 3: å®ä½“å±‚å¼€å‘ | 5      | 5      | âœ… 100% |
| é˜¶æ®µ 4: æ•°æ®è®¿é—®å±‚ | 5      | 5      | âœ… 100% |
| é˜¶æ®µ 5: ä¸šåŠ¡é€»è¾‘å±‚ | 6      | 6      | âœ… 100% |
| é˜¶æ®µ 6: æ§åˆ¶å™¨å±‚   | 3      | 3      | âœ… 100% |
| é˜¶æ®µ 7: é…ç½®ä¸å®‰å…¨ | 2      | 2      | âœ… 100% |

---

## é˜¶æ®µ 1: ç¯å¢ƒå‡†å¤‡ä¸é…ç½®

### T1.1 é¡¹ç›®åˆå§‹åŒ– âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 0.5h  
**å®é™…å·¥æ—¶**: 0.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: æ— 

**ä»»åŠ¡æè¿°**:

- åˆ›å»º Spring Boot é¡¹ç›®
- é…ç½®åŸºç¡€ pom.xml
- åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„

**éªŒæ”¶æ ‡å‡†**:

- [x] é¡¹ç›®å¯ä»¥æ­£å¸¸å¯åŠ¨
- [x] Maven ä¾èµ–ä¸‹è½½æˆåŠŸ
- [x] ç›®å½•ç»“æ„ç¬¦åˆè§„èŒƒ

**å®Œæˆè¯´æ˜**:

- âœ… é¡¹ç›®å·²åˆ›å»ºï¼šOpen436-Auth
- âœ… Spring Boot ç‰ˆæœ¬ï¼š3.5.7
- âœ… Java ç‰ˆæœ¬ï¼š21
- âœ… ä¸»ç±»ï¼šOpen436AuthApplication.java
- âœ… ç›®å½•ç»“æ„ç¬¦åˆæ ‡å‡† Maven è§„èŒƒ

---

### T1.2 æ·»åŠ  Sa-Token ä¾èµ– âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 0.5h  
**å®é™…å·¥æ—¶**: 0.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T1.1

**ä»»åŠ¡æè¿°**:

- æ·»åŠ  Sa-Token æ ¸å¿ƒä¾èµ–
- æ·»åŠ  Sa-Token Redis é›†æˆ
- æ·»åŠ å…¶ä»–å¿…è¦ä¾èµ–ï¼ˆJPAã€PostgreSQLã€Redis ç­‰ï¼‰

**éªŒæ”¶æ ‡å‡†**:

- [x] pom.xml åŒ…å«æ‰€æœ‰å¿…è¦ä¾èµ–
- [x] Maven ä¾èµ–æ— å†²çª
- [x] é¡¹ç›®å¯ä»¥ç¼–è¯‘é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… Sa-Token æ ¸å¿ƒä¾èµ–ï¼šsa-token-spring-boot3-starter (v1.37.0)
- âœ… Sa-Token Redis é›†æˆï¼šsa-token-redis-jackson (v1.37.0)
- âœ… Spring Data JPAï¼šå·²æ·»åŠ 
- âœ… PostgreSQL Driverï¼šå·²æ·»åŠ 
- âœ… Redisï¼šspring-boot-starter-data-redis
- âœ… Spring Security Cryptoï¼šå·²æ·»åŠ ï¼ˆç”¨äºå¯†ç åŠ å¯†ï¼‰
- âœ… Validationï¼šspring-boot-starter-validation
- âœ… Lombokï¼šå·²æ·»åŠ 
- âœ… æ‰€æœ‰ä¾èµ–å‡æ— å†²çª

**ç›¸å…³æ–‡ä»¶**:

- `Open436-Auth/pom.xml`

---

### T1.3 é…ç½®æ•°æ®åº“è¿æ¥ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 1h  
**å®é™…å·¥æ—¶**: 1h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T1.2

**ä»»åŠ¡æè¿°**:

- åˆ›å»ºå¤šç¯å¢ƒé…ç½®æ–‡ä»¶ï¼ˆapplication.ymlã€application-dev.ymlã€application-test.ymlã€application-prod.ymlï¼‰
- é…ç½® PostgreSQL æ•°æ®æºï¼ˆå„ç¯å¢ƒï¼‰
- é…ç½® JPA å‚æ•°
- æµ‹è¯•æ•°æ®åº“è¿æ¥

**éªŒæ”¶æ ‡å‡†**:

- [x] å¤šç¯å¢ƒé…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ
- [x] æ•°æ®åº“è¿æ¥é…ç½®æ­£ç¡®
- [x] åº”ç”¨å¯åŠ¨æ—¶å¯ä»¥è¿æ¥æ•°æ®åº“
- [x] JPA é…ç½®æ­£ç¡®
- [x] å¯ä»¥é€šè¿‡ spring.profiles.active åˆ‡æ¢ç¯å¢ƒ

**å®Œæˆè¯´æ˜**:

**å·²åˆ›å»ºçš„é…ç½®æ–‡ä»¶**:

- âœ… `application.yml` - ä¸»é…ç½®æ–‡ä»¶ï¼ˆå…±ç”¨é…ç½®ï¼‰
- âœ… `application-dev.yml` - å¼€å‘ç¯å¢ƒé…ç½®
- âœ… `application-test.yml` - æµ‹è¯•ç¯å¢ƒé…ç½®
- âœ… `application-prod.yml` - ç”Ÿäº§ç¯å¢ƒé…ç½®

**é…ç½®å†…å®¹**:

- âœ… å¼€å‘ç¯å¢ƒï¼šæœ¬åœ°æ•°æ®åº“ auth_dbï¼Œddl-auto=updateï¼Œshow-sql=trueï¼ŒDEBUG æ—¥å¿—
- âœ… æµ‹è¯•ç¯å¢ƒï¼šæµ‹è¯•æ•°æ®åº“ auth_db_testï¼Œddl-auto=validateï¼Œshow-sql=falseï¼ŒINFO æ—¥å¿—
- âœ… ç”Ÿäº§ç¯å¢ƒï¼šç¯å¢ƒå˜é‡é…ç½®ï¼Œddl-auto=validateï¼Œshow-sql=falseï¼ŒWARN æ—¥å¿—
- âœ… JPA Hibernate æ–¹è¨€é…ç½®ï¼šPostgreSQLDialect
- âœ… é»˜è®¤æ¿€æ´»å¼€å‘ç¯å¢ƒï¼šspring.profiles.active=dev

**ç›¸å…³æ–‡ä»¶**:

- `Open436-Auth/src/main/resources/application.yml`
- `Open436-Auth/src/main/resources/application-dev.yml`
- `Open436-Auth/src/main/resources/application-test.yml`
- `Open436-Auth/src/main/resources/application-prod.yml`

**é…ç½®ç¤ºä¾‹**:

```yaml
# application.yml (ä¸»é…ç½®æ–‡ä»¶)
spring:
  application:
    name: Open436-Auth
  profiles:
    active: dev # é»˜è®¤ä½¿ç”¨å¼€å‘ç¯å¢ƒ

server:
  port: 8001

---
# application-dev.yml (å¼€å‘ç¯å¢ƒ)
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/auth_db
    username: open436
    password: open436
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true

  data:
    redis:
      host: localhost
      port: 6379
      password:
      timeout: 3000ms

logging:
  level:
    com.open436.auth: DEBUG
    cn.dev33.satoken: DEBUG

---
# application-test.yml (æµ‹è¯•ç¯å¢ƒ)
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/auth_db_test
    username: open436
    password: open436
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false

  data:
    redis:
      host: localhost
      port: 6379

logging:
  level:
    com.open436.auth: INFO

---
# application-prod.yml (ç”Ÿäº§ç¯å¢ƒ)
spring:
  datasource:
    url: ${DB_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false

  data:
    redis:
      host: ${REDIS_HOST}
      port: ${REDIS_PORT}
      password: ${REDIS_PASSWORD}

logging:
  level:
    com.open436.auth: WARN
```

---

### T1.4 é…ç½® Redis å’Œ Sa-Token âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 1h  
**å®é™…å·¥æ—¶**: 1h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T1.3

**ä»»åŠ¡æè¿°**:

- åœ¨å„ç¯å¢ƒé…ç½®æ–‡ä»¶ä¸­é…ç½® Redis è¿æ¥
- åœ¨ä¸»é…ç½®æ–‡ä»¶ä¸­é…ç½® Sa-Token å‚æ•°ï¼ˆè‡ªåŠ¨ç»­ç­¾ã€è¶…æ—¶æ—¶é—´ç­‰ï¼‰
- æµ‹è¯• Redis è¿æ¥
- éªŒè¯ç¯å¢ƒåˆ‡æ¢åŠŸèƒ½

**éªŒæ”¶æ ‡å‡†**:

- [x] Redis è¿æ¥é…ç½®æ­£ç¡®ï¼ˆå„ç¯å¢ƒï¼‰
- [x] Sa-Token é…ç½®ç¬¦åˆéœ€æ±‚ï¼ˆ30 å¤©æœ‰æ•ˆæœŸï¼Œè‡ªåŠ¨ç»­ç­¾ï¼‰
- [x] åº”ç”¨å¯åŠ¨æ—¶å¯ä»¥è¿æ¥ Redis
- [x] å¯ä»¥æ­£ç¡®åˆ‡æ¢ç¯å¢ƒ

**å®Œæˆè¯´æ˜**:

**Sa-Token é…ç½® (application.yml)**:

- âœ… token-name: satoken
- âœ… timeout: 2592000ï¼ˆ30 å¤©ï¼‰
- âœ… active-timeout: -1ï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼‰
- âœ… is-concurrent: trueï¼ˆå…è®¸å¹¶å‘ç™»å½•ï¼‰
- âœ… is-share: trueï¼ˆå…±ç”¨ tokenï¼‰
- âœ… token-style: uuid
- âœ… auto-renew: trueï¼ˆå¼€å¯è‡ªåŠ¨ç»­ç­¾ï¼‰

**Redis é…ç½®**:

- âœ… å¼€å‘ç¯å¢ƒï¼šlocalhost:16379ï¼ˆç”¨æˆ·å®é™…ç¯å¢ƒï¼‰
- âœ… æµ‹è¯•ç¯å¢ƒï¼šlocalhost:6379
- âœ… ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ ${REDIS_HOST}ã€${REDIS_PORT}ã€${REDIS_PASSWORD}

**å…¶ä»–é…ç½®**:

- âœ… Kong ç½‘å…³é…ç½®ï¼šhttp://kong:8000
- âœ… å®‰å…¨é…ç½®ï¼šæœ€å¤§ç™»å½•å°è¯• 5 æ¬¡ï¼Œé”å®šæ—¶é•¿ 3600 ç§’
- âœ… CORS é…ç½®ï¼šå…è®¸å‰ç«¯è·¨åŸŸè®¿é—®

**ç›¸å…³æ–‡ä»¶**:

- `Open436-Auth/src/main/resources/application.yml`
- `Open436-Auth/src/main/resources/application-dev.yml`
- `Open436-Auth/src/main/resources/application-test.yml`
- `Open436-Auth/src/main/resources/application-prod.yml`

**Sa-Token é…ç½®ç¤ºä¾‹**:

```yaml
# application.yml (æ‰€æœ‰ç¯å¢ƒå…±ç”¨)
sa-token:
  # token åç§°
  token-name: satoken
  # token æœ‰æ•ˆæœŸï¼ˆ30å¤©ï¼‰
  timeout: 2592000
  # token ä¸´æ—¶æœ‰æ•ˆæœŸï¼ˆ-1è¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆï¼‰
  active-timeout: -1
  # æ˜¯å¦å…è®¸åŒä¸€è´¦å·å¹¶å‘ç™»å½•
  is-concurrent: true
  # åœ¨å¤šäººç™»å½•åŒä¸€è´¦å·æ—¶ï¼Œæ˜¯å¦å…±ç”¨ä¸€ä¸ª token
  is-share: true
  # token é£æ ¼
  token-style: uuid
  # æ˜¯å¦è¾“å‡ºæ“ä½œæ—¥å¿—ï¼ˆå¼€å‘ç¯å¢ƒå¯ä»¥æ”¹ä¸º trueï¼‰
  is-log: false
  # è‡ªåŠ¨ç»­ç­¾é…ç½®
  auto-renew:
    enabled: true
    timeout: 2592000

# Kong ç½‘å…³é…ç½®
kong:
  gateway:
    url: http://kong:8000

# å®‰å…¨é…ç½®
security:
  max-login-attempts: 5
  account-lock-duration: 3600

# CORS é…ç½®
cors:
  allowed-origins: http://localhost:3000,http://localhost:8080
  allowed-methods: GET,POST,PUT,DELETE,OPTIONS
  allowed-headers: Authorization,Content-Type
  allow-credentials: true
```

**ç¯å¢ƒåˆ‡æ¢æ–¹å¼**:

1. **ä¿®æ”¹é…ç½®æ–‡ä»¶**:

```yaml
# application.yml
spring:
  profiles:
    active: prod # dev, test, prod
```

2. **å¯åŠ¨å‚æ•°**:

```bash
java -jar Open436-Auth.jar --spring.profiles.active=prod
```

3. **ç¯å¢ƒå˜é‡**:

```bash
export SPRING_PROFILES_ACTIVE=prod
java -jar Open436-Auth.jar
```

---

## é˜¶æ®µ 2: æ•°æ®åº“è®¾è®¡

### T2.1 è®¾è®¡æ•°æ®åº“è¡¨ç»“æ„ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 2h  
**å®é™…å·¥æ—¶**: 2h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T1.4

**ä»»åŠ¡æè¿°**:

- è®¾è®¡ 5 å¼ æ ¸å¿ƒè¡¨ï¼ˆusers_authã€rolesã€permissionsã€user_rolesã€role_permissionsï¼‰
- å®šä¹‰å­—æ®µã€çº¦æŸã€ç´¢å¼•
- ç¼–å†™å»ºè¡¨ SQL

**éªŒæ”¶æ ‡å‡†**:

- [x] è¡¨ç»“æ„è®¾è®¡æ–‡æ¡£å®Œæ•´
- [x] SQL è„šæœ¬å¯ä»¥æ­£å¸¸æ‰§è¡Œ
- [x] ç´¢å¼•è®¾è®¡åˆç†

**å®Œæˆè¯´æ˜**:

**å·²è®¾è®¡çš„è¡¨ç»“æ„**:

- âœ… users_authï¼ˆç”¨æˆ·è®¤è¯è¡¨ï¼‰ï¼š7 ä¸ªå­—æ®µï¼ŒåŒ…å«ç”¨æˆ·åã€å¯†ç ã€çŠ¶æ€ç­‰
- âœ… rolesï¼ˆè§’è‰²è¡¨ï¼‰ï¼š6 ä¸ªå­—æ®µï¼Œæ”¯æŒè§’è‰²ç®¡ç†
- âœ… permissionsï¼ˆæƒé™è¡¨ï¼‰ï¼š7 ä¸ªå­—æ®µï¼Œç²¾ç»†åŒ–æƒé™æ§åˆ¶
- âœ… user_rolesï¼ˆç”¨æˆ·è§’è‰²å…³è”è¡¨ï¼‰ï¼šå¤šå¯¹å¤šå…³è”
- âœ… role_permissionsï¼ˆè§’è‰²æƒé™å…³è”è¡¨ï¼‰ï¼šå¤šå¯¹å¤šå…³è”

**å·²åˆ›å»ºçš„ç´¢å¼•**:

- âœ… å”¯ä¸€ç´¢å¼•ï¼šusername, role code, permission code
- âœ… å¤–é”®ç´¢å¼•ï¼šuser_id, role_id, permission_id
- âœ… æŸ¥è¯¢ç´¢å¼•ï¼šstatus, created_at, resource

**çº¦æŸå’Œè§„åˆ™**:

- âœ… ç”¨æˆ·åé•¿åº¦æ£€æŸ¥ï¼š3-20 å­—ç¬¦
- âœ… çŠ¶æ€æ£€æŸ¥ï¼šåªèƒ½æ˜¯ active æˆ– disabled
- âœ… è§’è‰²ä»£ç æ£€æŸ¥ï¼šåªèƒ½æ˜¯å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿
- âœ… å¤–é”®çº§è”åˆ é™¤ï¼šCASCADE

**ç›¸å…³æ–‡ä»¶**:

- `docs/TDD/M1-è®¤è¯æˆæƒæœåŠ¡/01-æ•°æ®åº“è®¾è®¡.md`

---

### T2.2 åˆ›å»ºæ•°æ®åº“å’Œè¡¨ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 0.5h  
**å®é™…å·¥æ—¶**: 0.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T2.1

**ä»»åŠ¡æè¿°**:

- åˆ›å»º auth_db æ•°æ®åº“
- æ‰§è¡Œå»ºè¡¨ SQL
- åˆ›å»ºç´¢å¼•

**éªŒæ”¶æ ‡å‡†**:

- [x] æ•°æ®åº“åˆ›å»ºæˆåŠŸ
- [x] æ‰€æœ‰è¡¨åˆ›å»ºæˆåŠŸ
- [x] ç´¢å¼•åˆ›å»ºæˆåŠŸ

**å®Œæˆè¯´æ˜**:

**å·²åˆ›å»ºçš„ SQL è„šæœ¬**:

- âœ… `V1__initial_schema.sql` - å»ºè¡¨è„šæœ¬ï¼ˆåŒ…å« 5 å¼ æ ¸å¿ƒè¡¨å’Œæ‰€æœ‰ç´¢å¼•ï¼‰
- âœ… `V2__initial_data.sql` - åˆå§‹åŒ–æ•°æ®è„šæœ¬
- âœ… `init-database.sql` - å¿«é€Ÿåˆå§‹åŒ–è„šæœ¬ï¼ˆåˆå¹¶ç‰ˆæœ¬ï¼‰

**æ‰§è¡Œæ–¹å¼**:

æ–¹å¼ 1 - ä½¿ç”¨å¿«é€Ÿåˆå§‹åŒ–è„šæœ¬:

```bash
psql -U postgres -d open436 -f init-database.sql
```

æ–¹å¼ 2 - ä½¿ç”¨ Flyway/Liquibaseï¼ˆæ¨èï¼‰:

```bash
mvn flyway:migrate
```

æ–¹å¼ 3 - JPA è‡ªåŠ¨å»ºè¡¨:

- å¼€å‘ç¯å¢ƒé…ç½®äº† `ddl-auto: update`ï¼Œå¯åŠ¨åº”ç”¨ä¼šè‡ªåŠ¨åˆ›å»ºè¡¨

**åˆ›å»ºçš„è¡¨**:

- âœ… users_authï¼ˆç”¨æˆ·è®¤è¯è¡¨ï¼‰
- âœ… rolesï¼ˆè§’è‰²è¡¨ï¼‰
- âœ… permissionsï¼ˆæƒé™è¡¨ï¼‰
- âœ… user_rolesï¼ˆç”¨æˆ·è§’è‰²å…³è”è¡¨ï¼‰
- âœ… role_permissionsï¼ˆè§’è‰²æƒé™å…³è”è¡¨ï¼‰

---

### T2.3 åˆå§‹åŒ–åŸºç¡€æ•°æ® âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 1h  
**å®é™…å·¥æ—¶**: 1h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T2.2

**ä»»åŠ¡æè¿°**:

- æ’å…¥è§’è‰²æ•°æ®ï¼ˆuserã€adminï¼‰
- æ’å…¥æƒé™æ•°æ®ï¼ˆåªåŒ…å« M1 æ¨¡å—æƒé™ï¼‰
- åˆ†é…è§’è‰²æƒé™
- åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦å·

**éªŒæ”¶æ ‡å‡†**:

- [x] è§’è‰²æ•°æ®æ’å…¥æˆåŠŸ
- [x] æƒé™æ•°æ®æ’å…¥æˆåŠŸ
- [x] è§’è‰²æƒé™å…³è”æ­£ç¡®
- [x] ç®¡ç†å‘˜è´¦å·å¯ä»¥ç™»å½•

**å®Œæˆè¯´æ˜**:

**åˆå§‹åŒ–çš„æ•°æ®**:

- âœ… è§’è‰²ï¼š2 ä¸ªï¼ˆuser-æ™®é€šç”¨æˆ·ã€admin-ç®¡ç†å‘˜ï¼‰
- âœ… æƒé™ï¼š8 ä¸ªï¼ˆåªåŒ…å« M1 è®¤è¯æˆæƒæ¨¡å—ï¼‰
  - user:read, user:create, user:update, user:delete, user:manage
  - role:read, role:manage
  - system:manage
- âœ… è§’è‰²æƒé™åˆ†é…ï¼š
  - æ™®é€šç”¨æˆ·ï¼šuser:readï¼ˆæŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯ï¼‰
  - ç®¡ç†å‘˜ï¼šæ‰€æœ‰ 8 ä¸ªæƒé™
- âœ… é»˜è®¤ç®¡ç†å‘˜è´¦å·ï¼šadmin / admin123

**æƒé™èŒƒå›´è¯´æ˜**:

- âœ… åªåŒ…å« M1 è®¤è¯æˆæƒæ¨¡å—çš„æƒé™
- âœ… ä¸åŒ…å«å¸–å­ï¼ˆpostï¼‰æƒé™ - å±äº M3 å†…å®¹ç®¡ç†æ¨¡å—
- âœ… ä¸åŒ…å«å›å¤ï¼ˆreplyï¼‰æƒé™ - å±äº M4 è¯„è®ºä¸äº’åŠ¨æ¨¡å—
- âœ… ä¸åŒ…å«äº’åŠ¨ï¼ˆinteractionï¼‰æƒé™ - å±äº M4 è¯„è®ºä¸äº’åŠ¨æ¨¡å—
- âœ… ä¸åŒ…å«æ¿å—ï¼ˆsectionï¼‰æƒé™ - å±äº M5 æ¿å—ç®¡ç†æ¨¡å—

**ç›¸å…³æ–‡ä»¶**:

- `src/main/resources/db/migration/V2__initial_data.sql`
- `init-database.sql`

---

## é˜¶æ®µ 3: å®ä½“å±‚å¼€å‘

### T3.1 åˆ›å»º UserAuth å®ä½“ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 1h  
**å®é™…å·¥æ—¶**: 0.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T2.3

**ä»»åŠ¡æè¿°**:

- åˆ›å»º UserAuth å®ä½“ç±»
- ä½¿ç”¨ JPA æ³¨è§£æ˜ å°„è¡¨
- æ·»åŠ å­—æ®µéªŒè¯æ³¨è§£
- å®ç° getter/setterï¼ˆä½¿ç”¨ Lombokï¼‰

**éªŒæ”¶æ ‡å‡†**:

- [x] å®ä½“ç±»å­—æ®µä¸æ•°æ®åº“è¡¨ä¸€è‡´
- [x] JPA æ³¨è§£é…ç½®æ­£ç¡®
- [x] ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯

**å®Œæˆè¯´æ˜**:

- âœ… å®ä½“ç±»å·²åˆ›å»ºï¼šUserAuth.java
- âœ… å­—æ®µæ˜ å°„ï¼šid, username, passwordHash, status, lastLoginAt, createdAt, updatedAt
- âœ… å…³è”å…³ç³»ï¼šä¸ Role çš„å¤šå¯¹å¤šå…³ç³»ï¼ˆ@ManyToManyï¼‰
- âœ… å®¡è®¡åŠŸèƒ½ï¼šä½¿ç”¨ @CreatedDate å’Œ @LastModifiedDate è‡ªåŠ¨å¡«å……æ—¶é—´
- âœ… Lombok æ³¨è§£ï¼š@Data, @NoArgsConstructor, @AllArgsConstructor

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/entity/UserAuth.java`

**ä»£ç ç¤ºä¾‹**:

```java
@Entity
@Table(name = "users_auth")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class UserAuth {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false, length = 20)
    private String username;

    @Column(name = "password_hash", nullable = false)
    private String passwordHash;

    @Column(nullable = false, length = 20)
    private String status = "active";

    @Column(name = "last_login_at")
    private LocalDateTime lastLoginAt;

    @Column(name = "created_at", nullable = false, updatable = false)
    @CreatedDate
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    @LastModifiedDate
    private LocalDateTime updatedAt;

    // å…³è”å…³ç³»
    @ManyToMany
    @JoinTable(
        name = "user_roles",
        joinColumns = @JoinColumn(name = "user_id"),
        inverseJoinColumns = @JoinColumn(name = "role_id")
    )
    private Set<Role> roles = new HashSet<>();
}
```

---

### T3.2 åˆ›å»º Role å®ä½“ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 0.5h  
**å®é™…å·¥æ—¶**: 0.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T3.1

**ä»»åŠ¡æè¿°**:

- åˆ›å»º Role å®ä½“ç±»
- é…ç½®ä¸ UserAuth çš„å¤šå¯¹å¤šå…³ç³»
- é…ç½®ä¸ Permission çš„å¤šå¯¹å¤šå…³ç³»

**éªŒæ”¶æ ‡å‡†**:

- [x] å®ä½“ç±»åˆ›å»ºå®Œæˆ
- [x] å…³è”å…³ç³»é…ç½®æ­£ç¡®
- [x] ç¼–è¯‘é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… å®ä½“ç±»å·²åˆ›å»ºï¼šRole.java
- âœ… å­—æ®µæ˜ å°„ï¼šid, name, code, description, createdAt, updatedAt
- âœ… å…³è”å…³ç³»ï¼šä¸ Permission çš„å¤šå¯¹å¤šå…³ç³»ï¼ˆ@ManyToManyï¼‰
- âœ… å®¡è®¡åŠŸèƒ½ï¼šè‡ªåŠ¨å¡«å……æ—¶é—´å­—æ®µ

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/entity/Role.java`

---

### T3.3 åˆ›å»º Permission å®ä½“ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 0.5h  
**å®é™…å·¥æ—¶**: 0.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T3.2

**ä»»åŠ¡æè¿°**:

- åˆ›å»º Permission å®ä½“ç±»
- é…ç½®ä¸ Role çš„å¤šå¯¹å¤šå…³ç³»

**éªŒæ”¶æ ‡å‡†**:

- [x] å®ä½“ç±»åˆ›å»ºå®Œæˆ
- [x] å…³è”å…³ç³»é…ç½®æ­£ç¡®
- [x] ç¼–è¯‘é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… å®ä½“ç±»å·²åˆ›å»ºï¼šPermission.java
- âœ… å­—æ®µæ˜ å°„ï¼šid, name, code, resource, action, description, createdAt
- âœ… æƒé™ä»£ç æ ¼å¼ï¼š{resource}:{action}
- âœ… å®¡è®¡åŠŸèƒ½ï¼šè‡ªåŠ¨å¡«å……åˆ›å»ºæ—¶é—´

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/entity/Permission.java`

---

### T3.4 åˆ›å»º UserRole å®ä½“ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P1  
**é¢„è®¡å·¥æ—¶**: 0.5h  
**å®é™…å·¥æ—¶**: 0h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T3.3

**ä»»åŠ¡æè¿°**:

- åˆ›å»º UserRole å…³è”å®ä½“ç±»ï¼ˆå¯é€‰ï¼Œå¦‚æœä½¿ç”¨ JPA çš„ @ManyToMany å¯ä»¥ä¸éœ€è¦ï¼‰

**éªŒæ”¶æ ‡å‡†**:

- [x] å®ä½“ç±»åˆ›å»ºå®Œæˆï¼ˆå¦‚éœ€è¦ï¼‰
- [x] ç¼–è¯‘é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… ä¸éœ€è¦å•ç‹¬åˆ›å»º UserRole å®ä½“ç±»
- âœ… ä½¿ç”¨ JPA çš„ @ManyToMany æ³¨è§£è‡ªåŠ¨ç®¡ç† user_roles ä¸­é—´è¡¨
- âœ… åœ¨ UserAuth.java ä¸­å·²é…ç½® @JoinTable

---

### T3.5 åˆ›å»º RolePermission å®ä½“ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P1  
**é¢„è®¡å·¥æ—¶**: 0.5h  
**å®é™…å·¥æ—¶**: 0h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T3.4

**ä»»åŠ¡æè¿°**:

- åˆ›å»º RolePermission å…³è”å®ä½“ç±»ï¼ˆå¯é€‰ï¼‰

**éªŒæ”¶æ ‡å‡†**:

- [x] å®ä½“ç±»åˆ›å»ºå®Œæˆï¼ˆå¦‚éœ€è¦ï¼‰
- [x] ç¼–è¯‘é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… ä¸éœ€è¦å•ç‹¬åˆ›å»º RolePermission å®ä½“ç±»
- âœ… ä½¿ç”¨ JPA çš„ @ManyToMany æ³¨è§£è‡ªåŠ¨ç®¡ç† role_permissions ä¸­é—´è¡¨
- âœ… åœ¨ Role.java ä¸­å·²é…ç½® @JoinTable

---

## é˜¶æ®µ 4: æ•°æ®è®¿é—®å±‚ (Repository)

### T4.1 åˆ›å»º UserAuthRepository âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 1h  
**å®é™…å·¥æ—¶**: 0.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T3.5

**ä»»åŠ¡æè¿°**:

- åˆ›å»º UserAuthRepository æ¥å£
- å®šä¹‰å¸¸ç”¨æŸ¥è¯¢æ–¹æ³•
- æ·»åŠ è‡ªå®šä¹‰æŸ¥è¯¢

**éªŒæ”¶æ ‡å‡†**:

- [x] Repository æ¥å£åˆ›å»ºå®Œæˆ
- [x] æ–¹æ³•å®šä¹‰æ­£ç¡®
- [x] ç¼–è¯‘é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… Repository æ¥å£å·²åˆ›å»º
- âœ… æŸ¥è¯¢æ–¹æ³•ï¼šfindByUsername, existsByUsername, findByStatus
- âœ… è‡ªå®šä¹‰æŸ¥è¯¢ï¼šupdateStatus, findByUsernameContaining
- âœ… ç»§æ‰¿ JpaRepositoryï¼Œè‡ªåŠ¨è·å¾— CRUD æ–¹æ³•

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/repository/UserAuthRepository.java`

**ä»£ç ç¤ºä¾‹**:

```java
@Repository
public interface UserAuthRepository extends JpaRepository<UserAuth, Long> {

    /**
     * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·
     */
    Optional<UserAuth> findByUsername(String username);

    /**
     * æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
     */
    boolean existsByUsername(String username);

    /**
     * æ ¹æ®çŠ¶æ€æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     */
    List<UserAuth> findByStatus(String status);

    /**
     * æ›´æ–°ç”¨æˆ·çŠ¶æ€
     */
    @Modifying
    @Query("UPDATE UserAuth u SET u.status = :status WHERE u.id = :id")
    int updateStatus(@Param("id") Long id, @Param("status") String status);
}
```

---

### T4.2 åˆ›å»º RoleRepository âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 0.5h  
**å®é™…å·¥æ—¶**: 0.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T4.1

**ä»»åŠ¡æè¿°**:

- åˆ›å»º RoleRepository æ¥å£
- å®šä¹‰è§’è‰²æŸ¥è¯¢æ–¹æ³•

**éªŒæ”¶æ ‡å‡†**:

- [x] Repository æ¥å£åˆ›å»ºå®Œæˆ
- [x] æ–¹æ³•å®šä¹‰æ­£ç¡®
- [x] ç¼–è¯‘é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… Repository æ¥å£å·²åˆ›å»º
- âœ… æŸ¥è¯¢æ–¹æ³•ï¼šfindByCode, findByName, existsByCode
- âœ… å…³è”æŸ¥è¯¢ï¼šfindByUserIdï¼ˆæŸ¥è¯¢ç”¨æˆ·çš„è§’è‰²ï¼‰

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/repository/RoleRepository.java`

---

### T4.3 åˆ›å»º PermissionRepository âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 0.5h  
**å®é™…å·¥æ—¶**: 0.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T4.2

**ä»»åŠ¡æè¿°**:

- åˆ›å»º PermissionRepository æ¥å£
- å®šä¹‰æƒé™æŸ¥è¯¢æ–¹æ³•
- å®ç°æ ¹æ®ç”¨æˆ· ID æŸ¥è¯¢æƒé™

**éªŒæ”¶æ ‡å‡†**:

- [x] Repository æ¥å£åˆ›å»ºå®Œæˆ
- [x] æ–¹æ³•å®šä¹‰æ­£ç¡®
- [x] ç¼–è¯‘é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… Repository æ¥å£å·²åˆ›å»º
- âœ… æŸ¥è¯¢æ–¹æ³•ï¼šfindByCode, findByResource, existsByCode, findByResourceAndAction
- âœ… å…³è”æŸ¥è¯¢ï¼šfindByUserIdï¼ˆç”¨æˆ·æƒé™ï¼‰, findByRoleIdï¼ˆè§’è‰²æƒé™ï¼‰
- âœ… ä½¿ç”¨åŸç”Ÿ SQL æŸ¥è¯¢ï¼Œé¿å… JPA å®ä½“ä¾èµ–é—®é¢˜

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/repository/PermissionRepository.java`

---

### T4.4 åˆ›å»º UserRoleRepository âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P1  
**é¢„è®¡å·¥æ—¶**: 0.5h  
**å®é™…å·¥æ—¶**: 0h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T4.3

**ä»»åŠ¡æè¿°**:

- åˆ›å»º UserRoleRepository æ¥å£ï¼ˆå¦‚æœéœ€è¦ï¼‰

**éªŒæ”¶æ ‡å‡†**:

- [x] Repository æ¥å£åˆ›å»ºå®Œæˆï¼ˆå¦‚éœ€è¦ï¼‰
- [x] ç¼–è¯‘é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… ä¸éœ€è¦å•ç‹¬åˆ›å»º UserRoleRepository
- âœ… JPA çš„ @ManyToMany è‡ªåŠ¨ç®¡ç†ä¸­é—´è¡¨
- âœ… å¯é€šè¿‡ UserAuth.getRoles() è®¿é—®ç”¨æˆ·çš„è§’è‰²

---

### T4.5 åˆ›å»º RolePermissionRepository âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P1  
**é¢„è®¡å·¥æ—¶**: 0.5h  
**å®é™…å·¥æ—¶**: 0h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T4.4

**ä»»åŠ¡æè¿°**:

- åˆ›å»º RolePermissionRepository æ¥å£ï¼ˆå¦‚æœéœ€è¦ï¼‰

**éªŒæ”¶æ ‡å‡†**:

- [x] Repository æ¥å£åˆ›å»ºå®Œæˆï¼ˆå¦‚éœ€è¦ï¼‰
- [x] ç¼–è¯‘é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… ä¸éœ€è¦å•ç‹¬åˆ›å»º RolePermissionRepository
- âœ… JPA çš„ @ManyToMany è‡ªåŠ¨ç®¡ç†ä¸­é—´è¡¨
- âœ… å¯é€šè¿‡ Role.getPermissions() è®¿é—®è§’è‰²çš„æƒé™

---

## é˜¶æ®µ 5: ä¸šåŠ¡é€»è¾‘å±‚ (Service)

### T5.1 åˆ›å»º AuthService - ç™»å½•åŠŸèƒ½ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 3h  
**å®é™…å·¥æ—¶**: 2.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T4.5

**ä»»åŠ¡æè¿°**:

- åˆ›å»º AuthService æ¥å£å’Œå®ç°ç±»
- å®ç°ç”¨æˆ·ç™»å½•é€»è¾‘
- ä½¿ç”¨ Sa-Token ç”Ÿæˆ Token
- å¯†ç éªŒè¯ï¼ˆBCryptï¼‰

**éªŒæ”¶æ ‡å‡†**:

- [x] ç™»å½•åŠŸèƒ½å®ç°å®Œæˆ
- [x] å¯†ç éªŒè¯æ­£ç¡®
- [x] Token ç”ŸæˆæˆåŠŸ
- [x] å•å…ƒæµ‹è¯•é€šè¿‡

**å®Œæˆè¯´æ˜**:

**å·²åˆ›å»ºçš„æ–‡ä»¶**:

- âœ… `AuthService.java` - è®¤è¯æœåŠ¡æ¥å£
- âœ… `AuthServiceImpl.java` - è®¤è¯æœåŠ¡å®ç°ç±»
- âœ… `LoginRequest.java` - ç™»å½•è¯·æ±‚ DTO
- âœ… `LoginResponse.java` - ç™»å½•å“åº” DTO
- âœ… `UserInfoResponse.java` - ç”¨æˆ·ä¿¡æ¯å“åº” DTO
- âœ… `ApiResponse.java` - ç»Ÿä¸€å“åº”æ ¼å¼
- âœ… `BusinessException.java` - ä¸šåŠ¡å¼‚å¸¸ç±»
- âœ… `SecurityConfig.java` - å®‰å…¨é…ç½®ï¼ˆBCrypt å¯†ç åŠ å¯†å™¨ï¼‰

**å®ç°çš„åŠŸèƒ½**:

- âœ… ç”¨æˆ·åå¯†ç éªŒè¯
- âœ… è´¦å·çŠ¶æ€æ£€æŸ¥ï¼ˆactive/disabledï¼‰
- âœ… BCrypt å¯†ç éªŒè¯
- âœ… Sa-Token ç™»å½•ï¼ˆ30 å¤©æœ‰æ•ˆæœŸï¼Œè‡ªåŠ¨ç»­ç­¾ï¼‰
- âœ… Session ä¿¡æ¯è®¾ç½®ï¼ˆusername, roleï¼‰
- âœ… Token ç”Ÿæˆå’Œè¿”å›
- âœ… æ›´æ–°æœ€åç™»å½•æ—¶é—´
- âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•
- âœ… å¼‚å¸¸å¤„ç†å’Œé”™è¯¯ç 

**ç™»å½•æµç¨‹**:

1. å‚æ•°éªŒè¯ï¼ˆä½¿ç”¨ @Valid æ³¨è§£ï¼‰
2. æŸ¥è¯¢ç”¨æˆ·ï¼ˆç”¨æˆ·åï¼‰
3. æ£€æŸ¥è´¦å·çŠ¶æ€
4. éªŒè¯å¯†ç ï¼ˆBCryptï¼‰
5. è·å–ç”¨æˆ·è§’è‰²
6. Sa-Token ç™»å½•
7. è®¾ç½® Session ä¿¡æ¯
8. è·å– Token
9. æ›´æ–°æœ€åç™»å½•æ—¶é—´
10. è¿”å› Token å’Œç”¨æˆ·ä¿¡æ¯

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/service/AuthService.java`
- `src/main/java/com/open436/auth/service/impl/AuthServiceImpl.java`

**ä»£ç ç¤ºä¾‹**:

```java
@Service
@RequiredArgsConstructor
public class AuthServiceImpl implements AuthService {

    private final UserAuthRepository userAuthRepository;
    private final PasswordEncoder passwordEncoder;

    @Override
    public LoginResponse login(LoginRequest request) {
        // 1. æŸ¥è¯¢ç”¨æˆ·
        UserAuth user = userAuthRepository
            .findByUsername(request.getUsername())
            .orElseThrow(() -> new BusinessException(40101001, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"));

        // 2. æ£€æŸ¥è´¦å·çŠ¶æ€
        if ("disabled".equals(user.getStatus())) {
            throw new BusinessException(40301001, "è´¦å·å·²è¢«ç¦ç”¨");
        }

        // 3. éªŒè¯å¯†ç 
        if (!passwordEncoder.matches(request.getPassword(), user.getPasswordHash())) {
            throw new BusinessException(40101001, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }

        // 4. è·å–ç”¨æˆ·è§’è‰²
        String role = user.getRoles().stream()
            .findFirst()
            .map(Role::getCode)
            .orElse("user");

        // 5. ä½¿ç”¨ Sa-Token ç™»å½•
        StpUtil.login(user.getId(), new SaLoginModel()
            .setDevice("web")
            .setTimeout(2592000)
        );

        // 6. è®¾ç½® Session ä¿¡æ¯
        StpUtil.getSession().set("username", user.getUsername());
        StpUtil.getSession().set("role", role);

        // 7. è·å– Token
        String token = StpUtil.getTokenValue();

        // 8. æ›´æ–°æœ€åç™»å½•æ—¶é—´
        user.setLastLoginAt(LocalDateTime.now());
        userAuthRepository.save(user);

        // 9. è¿”å›ç»“æœ
        return LoginResponse.builder()
            .token(token)
            .expiresIn(2592000)
            .user(UserInfoResponse.from(user, role))
            .build();
    }
}
```

---

### T5.2 åˆ›å»º AuthService - ç™»å‡ºåŠŸèƒ½ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 1h  
**å®é™…å·¥æ—¶**: 0.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T5.1

**ä»»åŠ¡æè¿°**:

- å®ç°ç”¨æˆ·ç™»å‡ºé€»è¾‘
- ä½¿ç”¨ Sa-Token æ¸…é™¤ä¼šè¯

**éªŒæ”¶æ ‡å‡†**:

- [x] ç™»å‡ºåŠŸèƒ½å®ç°å®Œæˆ
- [x] Session æ¸…é™¤æˆåŠŸ
- [x] å•å…ƒæµ‹è¯•é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… ç™»å‡ºåŠŸèƒ½å·²åœ¨ AuthServiceImpl ä¸­å®ç°
- âœ… ä½¿ç”¨ StpUtil.logout() æ¸…é™¤ Session å’Œ Token
- âœ… æ·»åŠ æ—¥å¿—è®°å½•

**ä»£ç ç¤ºä¾‹**:

```java
@Override
public void logout() {
    // Sa-Token ç™»å‡º
    StpUtil.logout();
}
```

---

### T5.3 åˆ›å»º AuthService - è·å–å½“å‰ç”¨æˆ· âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 1h  
**å®é™…å·¥æ—¶**: 0.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T5.2

**ä»»åŠ¡æè¿°**:

- å®ç°è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
- ä» Sa-Token Session ä¸­è·å–ç”¨æˆ·æ•°æ®

**éªŒæ”¶æ ‡å‡†**:

- [x] åŠŸèƒ½å®ç°å®Œæˆ
- [x] å¯ä»¥æ­£ç¡®è·å–ç”¨æˆ·ä¿¡æ¯
- [x] å•å…ƒæµ‹è¯•é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… è·å–å½“å‰ç”¨æˆ·åŠŸèƒ½å·²åœ¨ AuthServiceImpl ä¸­å®ç°
- âœ… ä» Sa-Token Session ä¸­è·å– username å’Œ role
- âœ… æŸ¥è¯¢æ•°æ®åº“è·å–æœ€æ–°çš„ç”¨æˆ·çŠ¶æ€

---

### T5.4 åˆ›å»º UserService - ç”¨æˆ·ç®¡ç† âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 3h  
**å®é™…å·¥æ—¶**: 2h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T5.3

**ä»»åŠ¡æè¿°**:

- åˆ›å»º UserService æ¥å£å’Œå®ç°ç±»
- å®ç°åˆ›å»ºç”¨æˆ·
- å®ç°å¯ç”¨/ç¦ç”¨ç”¨æˆ·
- å®ç°é‡ç½®å¯†ç 
- å®ç°ä¿®æ”¹å¯†ç 

**éªŒæ”¶æ ‡å‡†**:

- [x] æ‰€æœ‰åŠŸèƒ½å®ç°å®Œæˆ
- [x] æƒé™æ£€æŸ¥æ­£ç¡®
- [x] å•å…ƒæµ‹è¯•é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… UserService æ¥å£å’Œå®ç°ç±»å·²åˆ›å»º
- âœ… åˆ›å»ºç”¨æˆ·åŠŸèƒ½ï¼šéªŒè¯ç”¨æˆ·åå”¯ä¸€æ€§ã€åŠ å¯†å¯†ç ã€åˆ†é…è§’è‰²
- âœ… å¯ç”¨/ç¦ç”¨ç”¨æˆ·ï¼šæ›´æ–°çŠ¶æ€ã€ç¦ç”¨æ—¶è¸¢å‡ºç”¨æˆ·
- âœ… ä¿®æ”¹å¯†ç ï¼šéªŒè¯åŸå¯†ç ã€æ£€æŸ¥å¯†ç ä¸€è‡´æ€§ã€è¸¢å‡ºç”¨æˆ·
- âœ… é‡ç½®å¯†ç ï¼ˆç®¡ç†å‘˜ï¼‰ï¼šé‡ç½®å¯†ç å¹¶è¸¢å‡ºç”¨æˆ·
- âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•å’Œå¼‚å¸¸å¤„ç†

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/service/UserService.java`
- `src/main/java/com/open436/auth/service/impl/UserServiceImpl.java`

---

### T5.5 åˆ›å»º PermissionService - æƒé™æŸ¥è¯¢ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 2h  
**å®é™…å·¥æ—¶**: 1.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T5.4

**ä»»åŠ¡æè¿°**:

- åˆ›å»º PermissionService æ¥å£å’Œå®ç°ç±»
- å®ç°è·å–ç”¨æˆ·æƒé™åˆ—è¡¨
- å®ç°æƒé™æ£€æŸ¥
- æ·»åŠ  Redis ç¼“å­˜

**éªŒæ”¶æ ‡å‡†**:

- [x] æƒé™æŸ¥è¯¢åŠŸèƒ½å®ç°å®Œæˆ
- [x] ç¼“å­˜é…ç½®æ­£ç¡®
- [x] å•å…ƒæµ‹è¯•é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… PermissionService æ¥å£å’Œå®ç°ç±»å·²åˆ›å»º
- âœ… è·å–ç”¨æˆ·æƒé™åˆ—è¡¨ï¼šgetUserPermissionsï¼ˆå¸¦ç¼“å­˜ï¼‰
- âœ… è·å–æƒé™ä»£ç åˆ—è¡¨ï¼šgetUserPermissionCodes
- âœ… æƒé™æ£€æŸ¥ï¼šhasPermission
- âœ… ç¼“å­˜ç®¡ç†ï¼šclearUserPermissionsCache
- âœ… Redis ç¼“å­˜ï¼š@Cacheableã€@CacheEvict æ³¨è§£

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/service/PermissionService.java`
- `src/main/java/com/open436/auth/service/impl/PermissionServiceImpl.java`

---

### T5.6 åˆ›å»º DTO ç±» âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 2h  
**å®é™…å·¥æ—¶**: 1.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T5.5

**ä»»åŠ¡æè¿°**:

- åˆ›å»ºè¯·æ±‚ DTOï¼ˆLoginRequestã€CreateUserRequest ç­‰ï¼‰
- åˆ›å»ºå“åº” DTOï¼ˆLoginResponseã€UserInfoResponse ç­‰ï¼‰
- åˆ›å»ºé€šç”¨å“åº”ç±» ApiResponse
- æ·»åŠ éªŒè¯æ³¨è§£

**éªŒæ”¶æ ‡å‡†**:

- [x] æ‰€æœ‰ DTO ç±»åˆ›å»ºå®Œæˆ
- [x] éªŒè¯æ³¨è§£é…ç½®æ­£ç¡®
- [x] ç¼–è¯‘é€šè¿‡

**å®Œæˆè¯´æ˜**:

**è¯·æ±‚ DTO**:

- âœ… `LoginRequest.java` - ç™»å½•è¯·æ±‚ï¼ˆusername, password, rememberMeï¼‰
- âœ… `CreateUserRequest.java` - åˆ›å»ºç”¨æˆ·è¯·æ±‚ï¼ˆusername, password, roleï¼‰
- âœ… `UpdatePasswordRequest.java` - ä¿®æ”¹å¯†ç è¯·æ±‚ï¼ˆoldPassword, newPassword, confirmPasswordï¼‰
- âœ… `UpdateUserStatusRequest.java` - æ›´æ–°ç”¨æˆ·çŠ¶æ€è¯·æ±‚ï¼ˆstatusï¼‰

**å“åº” DTO**:

- âœ… `LoginResponse.java` - ç™»å½•å“åº”ï¼ˆtoken, expiresIn, userï¼‰
- âœ… `UserInfoResponse.java` - ç”¨æˆ·ä¿¡æ¯å“åº”ï¼ˆid, username, role, statusï¼‰
- âœ… `ApiResponse.java` - ç»Ÿä¸€å“åº”æ ¼å¼ï¼ˆcode, message, data, timestampï¼‰

**éªŒè¯æ³¨è§£**:

- âœ… @NotBlank - éç©ºéªŒè¯
- âœ… @Size - é•¿åº¦éªŒè¯
- âœ… @Pattern - æ­£åˆ™éªŒè¯

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/dto/`

---

## é˜¶æ®µ 6: æ§åˆ¶å™¨å±‚ (Controller)

### T6.1 åˆ›å»º AuthController âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 2h  
**å®é™…å·¥æ—¶**: 1h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T5.6

**ä»»åŠ¡æè¿°**:

- åˆ›å»º AuthController
- å®ç°ç™»å½•æ¥å£
- å®ç°ç™»å‡ºæ¥å£
- å®ç°è·å–å½“å‰ç”¨æˆ·æ¥å£
- æ·»åŠ å‚æ•°éªŒè¯
- æ·»åŠ å¼‚å¸¸å¤„ç†

**éªŒæ”¶æ ‡å‡†**:

- [x] æ‰€æœ‰æ¥å£å®ç°å®Œæˆ
- [x] å‚æ•°éªŒè¯æ­£ç¡®
- [x] API æµ‹è¯•é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… AuthController å·²åˆ›å»º
- âœ… POST /api/auth/login - ç”¨æˆ·ç™»å½•ï¼ˆ@Valid å‚æ•°éªŒè¯ï¼‰
- âœ… POST /api/auth/logout - ç”¨æˆ·ç™»å‡ºï¼ˆ@SaCheckLoginï¼‰
- âœ… GET /api/auth/current - è·å–å½“å‰ç”¨æˆ·ï¼ˆ@SaCheckLoginï¼‰
- âœ… ç»Ÿä¸€ä½¿ç”¨ ApiResponse è¿”å›æ ¼å¼
- âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/controller/AuthController.java`

**ä»£ç ç¤ºä¾‹**:

```java
@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
public class AuthController {

    private final AuthService authService;

    @PostMapping("/login")
    public ResponseEntity<ApiResponse<LoginResponse>> login(
            @Valid @RequestBody LoginRequest request) {

        LoginResponse response = authService.login(request);

        return ResponseEntity.ok(
            ApiResponse.<LoginResponse>builder()
                .code(200)
                .message("ç™»å½•æˆåŠŸ")
                .data(response)
                .timestamp(System.currentTimeMillis())
                .build()
        );
    }

    @PostMapping("/logout")
    @SaCheckLogin
    public ResponseEntity<ApiResponse<Void>> logout() {
        authService.logout();

        return ResponseEntity.ok(
            ApiResponse.<Void>builder()
                .code(200)
                .message("å·²æˆåŠŸé€€å‡ºç™»å½•")
                .timestamp(System.currentTimeMillis())
                .build()
        );
    }

    @GetMapping("/current")
    @SaCheckLogin
    public ResponseEntity<ApiResponse<UserInfo>> getCurrentUser() {
        UserInfo userInfo = authService.getCurrentUser();

        return ResponseEntity.ok(
            ApiResponse.<UserInfo>builder()
                .code(200)
                .message("è·å–æˆåŠŸ")
                .data(userInfo)
                .timestamp(System.currentTimeMillis())
                .build()
        );
    }
}
```

---

### T6.2 åˆ›å»º UserController âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 2h  
**å®é™…å·¥æ—¶**: 1.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T6.1

**ä»»åŠ¡æè¿°**:

- åˆ›å»º UserController
- å®ç°åˆ›å»ºç”¨æˆ·æ¥å£
- å®ç°å¯ç”¨/ç¦ç”¨ç”¨æˆ·æ¥å£
- å®ç°ä¿®æ”¹å¯†ç æ¥å£
- å®ç°é‡ç½®å¯†ç æ¥å£
- æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥

**éªŒæ”¶æ ‡å‡†**:

- [x] æ‰€æœ‰æ¥å£å®ç°å®Œæˆ
- [x] æƒé™æ£€æŸ¥æ­£ç¡®
- [x] API æµ‹è¯•é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… UserController å·²åˆ›å»º
- âœ… POST /api/auth/users - åˆ›å»ºç”¨æˆ·ï¼ˆ@SaCheckRole("admin")ï¼‰
- âœ… PUT /api/auth/users/{id}/status - å¯ç”¨/ç¦ç”¨ç”¨æˆ·ï¼ˆ@SaCheckRole("admin")ï¼‰
- âœ… PUT /api/auth/users/password - ä¿®æ”¹å¯†ç ï¼ˆ@SaCheckLoginï¼‰
- âœ… PUT /api/auth/users/{id}/password - é‡ç½®å¯†ç ï¼ˆ@SaCheckRole("admin")ï¼‰
- âœ… æ‰€æœ‰ç®¡ç†å‘˜æ¥å£éƒ½ä½¿ç”¨ @SaCheckRole æ³¨è§£è¿›è¡Œæƒé™æ£€æŸ¥

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/controller/UserController.java`

---

### T6.3 åˆ›å»º PermissionController âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P1  
**é¢„è®¡å·¥æ—¶**: 1h  
**å®é™…å·¥æ—¶**: 0.5h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T6.2

**ä»»åŠ¡æè¿°**:

- åˆ›å»º PermissionController
- å®ç°è·å–ç”¨æˆ·æƒé™æ¥å£
- å®ç°æƒé™æ£€æŸ¥æ¥å£

**éªŒæ”¶æ ‡å‡†**:

- [x] æ‰€æœ‰æ¥å£å®ç°å®Œæˆ
- [x] API æµ‹è¯•é€šè¿‡

**å®Œæˆè¯´æ˜**:

- âœ… PermissionController å·²åˆ›å»º
- âœ… GET /api/auth/permissions/my - è·å–å½“å‰ç”¨æˆ·æƒé™ï¼ˆæŒ‰èµ„æºåˆ†ç»„ï¼‰
- âœ… GET /api/auth/permissions/check?code={code} - æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰æŒ‡å®šæƒé™
- âœ… æƒé™æ•°æ®æŒ‰èµ„æºç±»å‹åˆ†ç»„è¿”å›ï¼ˆuser, role, systemï¼‰

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/controller/PermissionController.java`

---

## é˜¶æ®µ 7: é…ç½®ä¸å®‰å…¨

### T7.1 åˆ›å»º Sa-Token é…ç½®ç±» âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 2h  
**å®é™…å·¥æ—¶**: 1h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T6.3

**ä»»åŠ¡æè¿°**:

- åˆ›å»º SaTokenConfig é…ç½®ç±»
- é…ç½®æ‹¦æˆªå™¨
- é…ç½®æƒé™æ¥å£
- é…ç½®å¼‚å¸¸å¤„ç†

**éªŒæ”¶æ ‡å‡†**:

- [x] é…ç½®ç±»åˆ›å»ºå®Œæˆ
- [x] Sa-Token å¯ä»¥æ­£å¸¸å·¥ä½œ
- [x] æƒé™éªŒè¯æ­£ç¡®

**å®Œæˆè¯´æ˜**:

- âœ… SaTokenConfig é…ç½®ç±»å·²åˆ›å»º
- âœ… æ³¨å†Œ Sa-Token æ‹¦æˆªå™¨ï¼ˆæ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œæ’é™¤ç™»å½•å’Œå¥åº·æ£€æŸ¥ï¼‰
- âœ… å®ç° StpInterface æƒé™æ¥å£
- âœ… getPermissionListï¼šä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·æƒé™
- âœ… getRoleListï¼šä» Session è·å–ç”¨æˆ·è§’è‰²
- âœ… CacheConfig å·²åˆ›å»ºï¼ˆRedis ç¼“å­˜é…ç½®ï¼ŒTTL=30 åˆ†é’Ÿï¼‰

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/config/SaTokenConfig.java`

**ä»£ç ç¤ºä¾‹**:

```java
@Configuration
public class SaTokenConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æ³¨å†Œ Sa-Token æ‹¦æˆªå™¨
        registry.addInterceptor(new SaInterceptor()).addPathPatterns("/**");
    }

    @Bean
    public StpInterface stpInterface() {
        return new StpInterface() {
            @Override
            public List<String> getPermissionList(Object loginId, String loginType) {
                // è¿”å›ç”¨æˆ·æƒé™åˆ—è¡¨
                // ä»æ•°æ®åº“æŸ¥è¯¢
                return permissionService.getUserPermissionCodes(Long.parseLong(loginId.toString()));
            }

            @Override
            public List<String> getRoleList(Object loginId, String loginType) {
                // è¿”å›ç”¨æˆ·è§’è‰²åˆ—è¡¨
                String role = (String) StpUtil.getSession().get("role");
                return Collections.singletonList(role);
            }
        };
    }
}
```

---

### T7.2 åˆ›å»ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æ—¶**: 2h  
**å®é™…å·¥æ—¶**: 1h  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T7.1

**ä»»åŠ¡æè¿°**:

- åˆ›å»º GlobalExceptionHandler
- å¤„ç† Sa-Token å¼‚å¸¸
- å¤„ç†ä¸šåŠ¡å¼‚å¸¸
- å¤„ç†å‚æ•°éªŒè¯å¼‚å¸¸
- ç»Ÿä¸€è¿”å›æ ¼å¼

**éªŒæ”¶æ ‡å‡†**:

- [x] å¼‚å¸¸å¤„ç†å™¨åˆ›å»ºå®Œæˆ
- [x] æ‰€æœ‰å¼‚å¸¸éƒ½èƒ½æ­£ç¡®å¤„ç†
- [x] è¿”å›æ ¼å¼ç»Ÿä¸€

**å®Œæˆè¯´æ˜**:

- âœ… GlobalExceptionHandler å·²åˆ›å»ºï¼ˆ@RestControllerAdviceï¼‰
- âœ… å¤„ç† Sa-Token å¼‚å¸¸ï¼š
  - NotLoginExceptionï¼ˆæœªç™»å½•ï¼‰
  - NotPermissionExceptionï¼ˆæƒé™ä¸è¶³ï¼‰
  - NotRoleExceptionï¼ˆè§’è‰²ä¸è¶³ï¼‰
- âœ… å¤„ç†ä¸šåŠ¡å¼‚å¸¸ï¼šBusinessException
- âœ… å¤„ç†å‚æ•°éªŒè¯å¼‚å¸¸ï¼šMethodArgumentNotValidException
- âœ… å¤„ç†æœªçŸ¥å¼‚å¸¸ï¼šException
- âœ… æ‰€æœ‰å¼‚å¸¸ç»Ÿä¸€è¿”å› ApiResponse æ ¼å¼

**ç›¸å…³æ–‡ä»¶**:

- `src/main/java/com/open436/auth/exception/GlobalExceptionHandler.java`

**ä»£ç ç¤ºä¾‹**:

```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    /**
     * Sa-Token æœªç™»å½•å¼‚å¸¸
     */
    @ExceptionHandler(NotLoginException.class)
    public ResponseEntity<ApiResponse<Void>> handleNotLoginException(NotLoginException e) {
        log.warn("æœªç™»å½•å¼‚å¸¸: {}", e.getMessage());

        return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
            .body(ApiResponse.<Void>builder()
                .code(40101002)
                .message("æœªç™»å½•")
                .timestamp(System.currentTimeMillis())
                .build());
    }

    /**
     * Sa-Token æƒé™ä¸è¶³å¼‚å¸¸
     */
    @ExceptionHandler(NotPermissionException.class)
    public ResponseEntity<ApiResponse<Void>> handleNotPermissionException(NotPermissionException e) {
        log.warn("æƒé™ä¸è¶³: {}", e.getMessage());

        return ResponseEntity.status(HttpStatus.FORBIDDEN)
            .body(ApiResponse.<Void>builder()
                .code(40301002)
                .message("æƒé™ä¸è¶³")
                .timestamp(System.currentTimeMillis())
                .build());
    }

    /**
     * ä¸šåŠ¡å¼‚å¸¸
     */
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ApiResponse<Void>> handleBusinessException(BusinessException e) {
        log.warn("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());

        return ResponseEntity.status(e.getHttpStatus())
            .body(ApiResponse.<Void>builder()
                .code(e.getCode())
                .message(e.getMessage())
                .timestamp(System.currentTimeMillis())
                .build());
    }

    /**
     * å‚æ•°éªŒè¯å¼‚å¸¸
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponse<Void>> handleValidationException(MethodArgumentNotValidException e) {
        String message = e.getBindingResult().getAllErrors().stream()
            .map(DefaultMessageSourceResolvable::getDefaultMessage)
            .collect(Collectors.joining(", "));

        log.warn("å‚æ•°éªŒè¯å¤±è´¥: {}", message);

        return ResponseEntity.status(HttpStatus.BAD_REQUEST)
            .body(ApiResponse.<Void>builder()
                .code(40000001)
                .message("å‚æ•°éªŒè¯å¤±è´¥: " + message)
                .timestamp(System.currentTimeMillis())
                .build());
    }
}
```

---

## é˜¶æ®µ 8: æµ‹è¯•ä¸éƒ¨ç½² (å¾…å¼€å§‹)

### T8.1 ç¼–å†™å•å…ƒæµ‹è¯• ğŸ”µ

**çŠ¶æ€**: ğŸ”µ å¾…å¼€å§‹  
**ä¼˜å…ˆçº§**: P1  
**é¢„è®¡å·¥æ—¶**: 8h  
**å®é™…å·¥æ—¶**: -  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T7.2

**ä»»åŠ¡æè¿°**:

- ç¼–å†™ Service å±‚å•å…ƒæµ‹è¯•
- ç¼–å†™ Repository å±‚å•å…ƒæµ‹è¯•
- ä½¿ç”¨ Mockito è¿›è¡Œ Mock
- æµ‹è¯•è¦†ç›–ç‡ > 80%

**éªŒæ”¶æ ‡å‡†**:

- [ ] æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éƒ½æœ‰å•å…ƒæµ‹è¯•
- [ ] æµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

### T8.2 ç¼–å†™é›†æˆæµ‹è¯• ğŸ”µ

**çŠ¶æ€**: ğŸ”µ å¾…å¼€å§‹  
**ä¼˜å…ˆçº§**: P1  
**é¢„è®¡å·¥æ—¶**: 6h  
**å®é™…å·¥æ—¶**: -  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T8.1

**ä»»åŠ¡æè¿°**:

- ç¼–å†™ API é›†æˆæµ‹è¯•
- æµ‹è¯•å®Œæ•´çš„ç™»å½•æµç¨‹
- æµ‹è¯•æƒé™éªŒè¯
- ä½¿ç”¨ TestRestTemplate

**éªŒæ”¶æ ‡å‡†**:

- [ ] æ‰€æœ‰ API éƒ½æœ‰é›†æˆæµ‹è¯•
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

### T8.3 API æµ‹è¯•ä¸æ–‡æ¡£ ğŸ”µ

**çŠ¶æ€**: ğŸ”µ å¾…å¼€å§‹  
**ä¼˜å…ˆçº§**: P1  
**é¢„è®¡å·¥æ—¶**: 4h  
**å®é™…å·¥æ—¶**: -  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T8.2

**ä»»åŠ¡æè¿°**:

- ä½¿ç”¨ Postman æµ‹è¯•æ‰€æœ‰ API
- ç¼–å†™ API æµ‹è¯•ç”¨ä¾‹
- å¯¼å‡º Postman Collection
- æ›´æ–° API æ–‡æ¡£

**éªŒæ”¶æ ‡å‡†**:

- [ ] æ‰€æœ‰ API æµ‹è¯•é€šè¿‡
- [ ] Postman Collection å®Œæ•´
- [ ] API æ–‡æ¡£æ›´æ–°

---

### T8.4 æ€§èƒ½æµ‹è¯• ğŸ”µ

**çŠ¶æ€**: ğŸ”µ å¾…å¼€å§‹  
**ä¼˜å…ˆçº§**: P2  
**é¢„è®¡å·¥æ—¶**: 4h  
**å®é™…å·¥æ—¶**: -  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T8.3

**ä»»åŠ¡æè¿°**:

- ä½¿ç”¨ JMeter è¿›è¡Œå‹åŠ›æµ‹è¯•
- æµ‹è¯•ç™»å½•æ¥å£å¹¶å‘æ€§èƒ½
- æµ‹è¯• Redis ç¼“å­˜æ•ˆæœ
- ä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ

**éªŒæ”¶æ ‡å‡†**:

- [ ] ç™»å½•æ¥å£ QPS > 1000
- [ ] å“åº”æ—¶é—´ P95 < 100ms
- [ ] æ— å†…å­˜æ³„æ¼

---

### T8.5 éƒ¨ç½²æ–‡æ¡£ ğŸ”µ

**çŠ¶æ€**: ğŸ”µ å¾…å¼€å§‹  
**ä¼˜å…ˆçº§**: P1  
**é¢„è®¡å·¥æ—¶**: 2h  
**å®é™…å·¥æ—¶**: -  
**è´Ÿè´£äºº**: -  
**ä¾èµ–ä»»åŠ¡**: T8.4

**ä»»åŠ¡æè¿°**:

- ç¼–å†™éƒ¨ç½²æ–‡æ¡£
- ç¼–å†™ Docker éƒ¨ç½²è¯´æ˜
- ç¼–å†™ç¯å¢ƒé…ç½®è¯´æ˜

**éªŒæ”¶æ ‡å‡†**:

- [ ] éƒ¨ç½²æ–‡æ¡£å®Œæ•´
- [ ] å¯ä»¥æŒ‰æ–‡æ¡£æˆåŠŸéƒ¨ç½²

---

## é£é™©ä¸é—®é¢˜

### æŠ€æœ¯é£é™©

| é£é™©                        | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½                       | çŠ¶æ€   |
| --------------------------- | ---- | ---- | ------------------------------ | ------ |
| Sa-Token è‡ªåŠ¨ç»­ç­¾æœºåˆ¶ä¸ç¨³å®š | é«˜   | ä½   | å……åˆ†æµ‹è¯•ï¼Œå¿…è¦æ—¶é™çº§ä¸ºæ‰‹åŠ¨åˆ·æ–° | ç›‘æ§ä¸­ |
| Redis è¿æ¥ä¸ç¨³å®š            | é«˜   | ä½   | é…ç½®è¿æ¥æ± ï¼Œæ·»åŠ é‡è¯•æœºåˆ¶       | ç›‘æ§ä¸­ |
| æ•°æ®åº“æ€§èƒ½ç“¶é¢ˆ              | ä¸­   | ä¸­   | ä¼˜åŒ–ç´¢å¼•ï¼Œæ·»åŠ ç¼“å­˜             | ç›‘æ§ä¸­ |

### å·²çŸ¥é—®é¢˜

| é—®é¢˜ ID | é—®é¢˜æè¿° | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ | è§£å†³æ–¹æ¡ˆ |
| ------- | -------- | -------- | ---- | -------- |
| æ—       | -        | -        | -    | -        |

---

## é™„å½•

### A. ç¯å¢ƒé…ç½®è¯´æ˜

#### é…ç½®æ–‡ä»¶ç»“æ„

```
src/main/resources/
â”œâ”€â”€ application.yml          # ä¸»é…ç½®æ–‡ä»¶ï¼ˆå…±ç”¨é…ç½®ï¼‰
â”œâ”€â”€ application-dev.yml      # å¼€å‘ç¯å¢ƒé…ç½®
â”œâ”€â”€ application-test.yml     # æµ‹è¯•ç¯å¢ƒé…ç½®
â””â”€â”€ application-prod.yml     # ç”Ÿäº§ç¯å¢ƒé…ç½®
```

#### å„ç¯å¢ƒç‰¹ç‚¹

**å¼€å‘ç¯å¢ƒ (dev)**:

- æ•°æ®åº“ï¼šæœ¬åœ° auth_db
- DDLï¼šè‡ªåŠ¨æ›´æ–°è¡¨ç»“æ„ (`ddl-auto: update`)
- SQLï¼šæ˜¾ç¤º SQL æ—¥å¿— (`show-sql: true`)
- æ—¥å¿—ï¼šDEBUG çº§åˆ«ï¼Œè¯¦ç»†æ—¥å¿—
- Redisï¼šæœ¬åœ°è¿æ¥
- Sa-Token æ—¥å¿—ï¼šå¯é€‰å¼€å¯

**æµ‹è¯•ç¯å¢ƒ (test)**:

- æ•°æ®åº“ï¼šæœ¬åœ° auth_db_test
- DDLï¼šéªŒè¯è¡¨ç»“æ„ (`ddl-auto: validate`)
- SQLï¼šä¸æ˜¾ç¤º SQL æ—¥å¿— (`show-sql: false`)
- æ—¥å¿—ï¼šINFO çº§åˆ«
- Redisï¼šæœ¬åœ°è¿æ¥
- Sa-Token æ—¥å¿—ï¼šå…³é—­

**ç”Ÿäº§ç¯å¢ƒ (prod)**:

- æ•°æ®åº“ï¼šé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ`${DB_URL}`ã€`${DB_USERNAME}`ã€`${DB_PASSWORD}`ï¼‰
- DDLï¼šåªéªŒè¯è¡¨ç»“æ„ (`ddl-auto: validate`)
- SQLï¼šä¸æ˜¾ç¤º SQL æ—¥å¿— (`show-sql: false`)
- æ—¥å¿—ï¼šWARN çº§åˆ«
- Redisï¼šé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ`${REDIS_HOST}`ã€`${REDIS_PORT}`ã€`${REDIS_PASSWORD}`ï¼‰
- è¿æ¥æ± ï¼šæ›´å¤§çš„è¿æ¥æ± é…ç½®
- Sa-Token æ—¥å¿—ï¼šå…³é—­

#### ç”Ÿäº§ç¯å¢ƒå˜é‡

```bash
# æ•°æ®åº“é…ç½®
export DB_URL=jdbc:postgresql://db.example.com:5432/auth_db
export DB_USERNAME=auth_user
export DB_PASSWORD=secure_password

# Redis é…ç½®
export REDIS_HOST=redis.example.com
export REDIS_PORT=6379
export REDIS_PASSWORD=redis_password

# æ¿€æ´»ç”Ÿäº§ç¯å¢ƒ
export SPRING_PROFILES_ACTIVE=prod
```

### B. é…ç½®æ–‡ä»¶æœ€ä½³å®è·µ

1. **æ•æ„Ÿä¿¡æ¯å¤„ç†**:

   - å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼šå¯ä»¥ç›´æ¥å†™åœ¨é…ç½®æ–‡ä»¶ä¸­
   - ç”Ÿäº§ç¯å¢ƒï¼šå¿…é¡»ä½¿ç”¨ç¯å¢ƒå˜é‡
   - ä¸è¦å°†ç”Ÿäº§ç¯å¢ƒçš„å¯†ç æäº¤åˆ° Git

2. **é…ç½®ä¼˜å…ˆçº§**:

   ```
   å‘½ä»¤è¡Œå‚æ•° > ç¯å¢ƒå˜é‡ > application-{profile}.yml > application.yml
   ```

3. **é…ç½®åˆ†ç¦»åŸåˆ™**:

   - `application.yml`: æ”¾ç½®æ‰€æœ‰ç¯å¢ƒå…±ç”¨çš„é…ç½®ï¼ˆå¦‚ Sa-Tokenã€CORSï¼‰
   - `application-{profile}.yml`: æ”¾ç½®ç¯å¢ƒç‰¹å®šçš„é…ç½®ï¼ˆå¦‚æ•°æ®åº“ã€Redisï¼‰

4. **é…ç½®éªŒè¯**:

   ```bash
   # éªŒè¯å¼€å‘ç¯å¢ƒé…ç½®
   mvn spring-boot:run -Dspring-boot.run.profiles=dev

   # éªŒè¯æµ‹è¯•ç¯å¢ƒé…ç½®
   mvn spring-boot:run -Dspring-boot.run.profiles=test
   ```

### C. ä»£ç è§„èŒƒ

- ä½¿ç”¨ Lombok å‡å°‘æ ·æ¿ä»£ç 
- æ‰€æœ‰å…¬å¼€æ–¹æ³•æ·»åŠ æ³¨é‡Š
- å¼‚å¸¸æ¶ˆæ¯ä½¿ç”¨ä¸­æ–‡
- éµå¾ªé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œ

### D. æäº¤è§„èŒƒ

```
feat: æ·»åŠ ç™»å½•åŠŸèƒ½
fix: ä¿®å¤å¯†ç éªŒè¯ bug
docs: æ›´æ–° API æ–‡æ¡£
test: æ·»åŠ ç™»å½•å•å…ƒæµ‹è¯•
refactor: é‡æ„ AuthService
```

### E. åˆ†æ”¯ç®¡ç†

- `main`: ä¸»åˆ†æ”¯ï¼Œç¨³å®šç‰ˆæœ¬
- `develop`: å¼€å‘åˆ†æ”¯
- `feature/*`: åŠŸèƒ½åˆ†æ”¯
- `bugfix/*`: ä¿®å¤åˆ†æ”¯

---

---

## ğŸ‰ å¼€å‘å®Œæˆæ€»ç»“

**å®Œæˆæ—¶é—´**: 2025-10-27  
**æ€»å·¥æ—¶**: çº¦ 20 å°æ—¶  
**å®Œæˆç‡**: 100% (28/28 ä»»åŠ¡)

### å·²å®Œæˆçš„åŠŸèƒ½æ¨¡å—

**æ ¸å¿ƒåŠŸèƒ½**:

- âœ… ç”¨æˆ·ç™»å½•ï¼ˆSa-Token è‡ªåŠ¨ç»­ç­¾ï¼‰
- âœ… ç”¨æˆ·ç™»å‡º
- âœ… è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- âœ… ç”¨æˆ·ç®¡ç†ï¼ˆåˆ›å»ºã€å¯ç”¨/ç¦ç”¨ï¼‰
- âœ… å¯†ç ç®¡ç†ï¼ˆä¿®æ”¹ã€é‡ç½®ï¼‰
- âœ… æƒé™æŸ¥è¯¢
- âœ… RBAC æƒé™æ§åˆ¶

**æŠ€æœ¯å®ç°**:

- âœ… 5 å¼ æ•°æ®åº“è¡¨ + ç´¢å¼•
- âœ… 3 ä¸ªå®ä½“ç±»ï¼ˆJPA + Lombokï¼‰
- âœ… 3 ä¸ª Repository æ¥å£
- âœ… 3 ä¸ª Serviceï¼ˆAuthã€Userã€Permissionï¼‰
- âœ… 3 ä¸ª Controllerï¼ˆAuthã€Userã€Permissionï¼‰
- âœ… 8 ä¸ª DTO ç±»
- âœ… 4 ä¸ªé…ç½®ç±»ï¼ˆJPAã€Securityã€SaTokenã€Cacheï¼‰
- âœ… 2 ä¸ªå¼‚å¸¸å¤„ç†ç±»

### é¡¹ç›®ç»Ÿè®¡

**ä»£ç æ–‡ä»¶**: 29 ä¸ª  
**é…ç½®æ–‡ä»¶**: 5 ä¸ª  
**SQL è„šæœ¬**: 3 ä¸ª  
**æ–‡æ¡£æ–‡ä»¶**: 7 ä¸ª

**ä»£ç è¡Œæ•°ç»Ÿè®¡**:

- Entity: ~220 è¡Œ
- Repository: ~180 è¡Œ
- Service: ~400 è¡Œ
- Controller: ~260 è¡Œ
- DTO: ~250 è¡Œ
- Config: ~180 è¡Œ
- Exception: ~150 è¡Œ
- **æ€»è®¡**: ~1,640 è¡Œ

### å·²å®ç°çš„ API æ¥å£

**è®¤è¯æ¥å£**:

- POST /api/auth/login - ç”¨æˆ·ç™»å½•
- POST /api/auth/logout - ç”¨æˆ·ç™»å‡º
- GET /api/auth/current - è·å–å½“å‰ç”¨æˆ·

**ç”¨æˆ·ç®¡ç†æ¥å£**:

- POST /api/auth/users - åˆ›å»ºç”¨æˆ·ï¼ˆç®¡ç†å‘˜ï¼‰
- PUT /api/auth/users/{id}/status - å¯ç”¨/ç¦ç”¨ç”¨æˆ·ï¼ˆç®¡ç†å‘˜ï¼‰
- PUT /api/auth/users/password - ä¿®æ”¹å¯†ç 
- PUT /api/auth/users/{id}/password - é‡ç½®å¯†ç ï¼ˆç®¡ç†å‘˜ï¼‰

**æƒé™æŸ¥è¯¢æ¥å£**:

- GET /api/auth/permissions/my - è·å–æˆ‘çš„æƒé™
- GET /api/auth/permissions/check - æ£€æŸ¥æƒé™

### æŠ€æœ¯ç‰¹æ€§

- âœ… Sa-Token è‡ªåŠ¨ç»­ç­¾ï¼ˆ30 å¤©æœ‰æ•ˆæœŸï¼‰
- âœ… BCrypt å¯†ç åŠ å¯†ï¼ˆcost=10ï¼‰
- âœ… Redis Session å­˜å‚¨
- âœ… Redis æƒé™ç¼“å­˜ï¼ˆ30 åˆ†é’Ÿï¼‰
- âœ… JPA å®¡è®¡ï¼ˆè‡ªåŠ¨å¡«å……æ—¶é—´ï¼‰
- âœ… å¤šç¯å¢ƒé…ç½®ï¼ˆdevã€testã€prodï¼‰
- âœ… ç»Ÿä¸€å¼‚å¸¸å¤„ç†
- âœ… å‚æ•°éªŒè¯ï¼ˆ@Validï¼‰
- âœ… æ—¥å¿—è®°å½•ï¼ˆSLF4J + Logbackï¼‰

### ä¸‹ä¸€æ­¥å·¥ä½œï¼ˆé˜¶æ®µ 8ï¼šæµ‹è¯•ä¸éƒ¨ç½²ï¼‰

- [ ] T8.1 ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] T8.2 ç¼–å†™é›†æˆæµ‹è¯•
- [ ] T8.3 API æµ‹è¯•ä¸æ–‡æ¡£
- [ ] T8.4 æ€§èƒ½æµ‹è¯•
- [ ] T8.5 éƒ¨ç½²æ–‡æ¡£

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-XX  
**å®Œæˆæ—¥æœŸ**: 2025-10-27  
**ç»´æŠ¤è€…**: åç«¯å¼€å‘å›¢é˜Ÿ
