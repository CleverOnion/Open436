# M1 认证授权服务 - 数据库设计

## 文档信息

**服务名称**: 认证授权服务 (auth-service)  
**数据库**: PostgreSQL 14+  
**Schema**: `auth_db`  
**版本**: v1.0

---

## 目录

1. [数据库概述](#数据库概述)
2. [表结构设计](#表结构设计)
3. [索引设计](#索引设计)
4. [数据关系图](#数据关系图)
5. [初始化数据](#初始化数据)
6. [数据迁移策略](#数据迁移策略)

---

## 数据库概述

### 设计原则

1. **职责单一**: 仅存储认证和权限相关数据，不涉及用户业务信息
2. **数据隔离**: 与其他服务的数据库完全隔离
3. **安全优先**: 密码使用 BCrypt 加密，敏感字段不可逆
4. **性能优化**: 合理使用索引，支持高并发查询

### 表列表

| 表名 | 说明 | 记录数估算 |
|------|------|-----------|
| `users_auth` | 用户认证表 | 1000-10000 |
| `roles` | 角色表 | 5-10 |
| `permissions` | 权限表 | 20-50 |
| `user_roles` | 用户角色关联表 | 1000-10000 |
| `role_permissions` | 角色权限关联表 | 50-200 |

---

## 表结构设计

### 1. users_auth - 用户认证表

**用途**: 存储用户登录凭证和账号状态

```sql
CREATE TABLE users_auth (
    id SERIAL PRIMARY KEY,
    username VARCHAR(20) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    last_login_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_username_length CHECK (LENGTH(username) >= 3),
    CONSTRAINT chk_status CHECK (status IN ('active', 'disabled'))
);

-- 添加注释
COMMENT ON TABLE users_auth IS '用户认证表';
COMMENT ON COLUMN users_auth.id IS '用户ID（主键）';
COMMENT ON COLUMN users_auth.username IS '用户名（唯一，3-20字符）';
COMMENT ON COLUMN users_auth.password_hash IS '密码哈希（BCrypt加密）';
COMMENT ON COLUMN users_auth.status IS '账号状态：active-正常, disabled-禁用';
COMMENT ON COLUMN users_auth.last_login_at IS '最后登录时间';
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | SERIAL | PRIMARY KEY | 用户ID，自增主键 |
| `username` | VARCHAR(20) | NOT NULL, UNIQUE | 用户名，3-20字符，唯一 |
| `password_hash` | VARCHAR(255) | NOT NULL | BCrypt 加密后的密码哈希 |
| `status` | VARCHAR(20) | NOT NULL, DEFAULT 'active' | 账号状态：active/disabled |
| `last_login_at` | TIMESTAMP | NULL | 最后登录时间 |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | 更新时间 |

**业务规则**:
- 用户名长度：3-20 个字符
- 密码使用 BCrypt 加密，cost factor = 10
- 账号状态只能是 `active` 或 `disabled`
- 禁用的账号无法登录

---

### 2. roles - 角色表

**用途**: 定义系统角色

```sql
CREATE TABLE roles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    code VARCHAR(20) NOT NULL UNIQUE,
    description TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_code CHECK (code ~ '^[a-z_]+$')
);

COMMENT ON TABLE roles IS '角色表';
COMMENT ON COLUMN roles.id IS '角色ID（主键）';
COMMENT ON COLUMN roles.name IS '角色名称（中文）';
COMMENT ON COLUMN roles.code IS '角色代码（英文，小写+下划线）';
COMMENT ON COLUMN roles.description IS '角色描述';
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | SERIAL | PRIMARY KEY | 角色ID |
| `name` | VARCHAR(50) | NOT NULL, UNIQUE | 角色名称（如：普通用户、管理员） |
| `code` | VARCHAR(20) | NOT NULL, UNIQUE | 角色代码（如：user、admin） |
| `description` | TEXT | NULL | 角色描述 |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | 更新时间 |

**预定义角色**:
- `user` - 普通用户
- `admin` - 管理员

---

### 3. permissions - 权限表

**用途**: 定义系统权限

```sql
CREATE TABLE permissions (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) NOT NULL UNIQUE,
    resource VARCHAR(50) NOT NULL,
    action VARCHAR(20) NOT NULL,
    description TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_action CHECK (action IN ('create', 'read', 'update', 'delete', 'manage'))
);

COMMENT ON TABLE permissions IS '权限表';
COMMENT ON COLUMN permissions.id IS '权限ID（主键）';
COMMENT ON COLUMN permissions.name IS '权限名称（中文）';
COMMENT ON COLUMN permissions.code IS '权限代码（唯一标识）';
COMMENT ON COLUMN permissions.resource IS '资源类型（如：post, user, section）';
COMMENT ON COLUMN permissions.action IS '操作类型（create, read, update, delete, manage）';
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | SERIAL | PRIMARY KEY | 权限ID |
| `name` | VARCHAR(100) | NOT NULL | 权限名称（如：创建帖子） |
| `code` | VARCHAR(50) | NOT NULL, UNIQUE | 权限代码（如：post:create） |
| `resource` | VARCHAR(50) | NOT NULL | 资源类型（post, user, section等） |
| `action` | VARCHAR(20) | NOT NULL | 操作类型（create, read, update, delete, manage） |
| `description` | TEXT | NULL | 权限描述 |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |

**权限命名规范**:
- 格式: `{resource}:{action}`
- 示例: `post:create`, `user:manage`, `section:update`

---

### 4. user_roles - 用户角色关联表

**用途**: 多对多关联用户和角色

```sql
CREATE TABLE user_roles (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    role_id INTEGER NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_user FOREIGN KEY (user_id) 
        REFERENCES users_auth(id) ON DELETE CASCADE,
    CONSTRAINT fk_role FOREIGN KEY (role_id) 
        REFERENCES roles(id) ON DELETE CASCADE,
    CONSTRAINT uk_user_role UNIQUE (user_id, role_id)
);

COMMENT ON TABLE user_roles IS '用户角色关联表';
COMMENT ON COLUMN user_roles.user_id IS '用户ID（外键）';
COMMENT ON COLUMN user_roles.role_id IS '角色ID（外键）';
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | SERIAL | PRIMARY KEY | 关联ID |
| `user_id` | INTEGER | NOT NULL, FK | 用户ID |
| `role_id` | INTEGER | NOT NULL, FK | 角色ID |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |

**业务规则**:
- 一个用户可以有多个角色
- 同一用户不能重复分配同一角色
- 删除用户时，级联删除关联记录

---

### 5. role_permissions - 角色权限关联表

**用途**: 多对多关联角色和权限

```sql
CREATE TABLE role_permissions (
    id SERIAL PRIMARY KEY,
    role_id INTEGER NOT NULL,
    permission_id INTEGER NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_role FOREIGN KEY (role_id) 
        REFERENCES roles(id) ON DELETE CASCADE,
    CONSTRAINT fk_permission FOREIGN KEY (permission_id) 
        REFERENCES permissions(id) ON DELETE CASCADE,
    CONSTRAINT uk_role_permission UNIQUE (role_id, permission_id)
);

COMMENT ON TABLE role_permissions IS '角色权限关联表';
COMMENT ON COLUMN role_permissions.role_id IS '角色ID（外键）';
COMMENT ON COLUMN role_permissions.permission_id IS '权限ID（外键）';
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | SERIAL | PRIMARY KEY | 关联ID |
| `role_id` | INTEGER | NOT NULL, FK | 角色ID |
| `permission_id` | INTEGER | NOT NULL, FK | 权限ID |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |

**业务规则**:
- 一个角色可以有多个权限
- 同一角色不能重复分配同一权限
- 删除角色时，级联删除关联记录

---

## 索引设计

### 主键索引（自动创建）

```sql
-- 所有表的主键自动创建索引
-- users_auth(id), roles(id), permissions(id), user_roles(id), role_permissions(id)
```

### 唯一索引

```sql
-- users_auth 表
CREATE UNIQUE INDEX idx_users_auth_username ON users_auth(username);

-- roles 表
CREATE UNIQUE INDEX idx_roles_name ON roles(name);
CREATE UNIQUE INDEX idx_roles_code ON roles(code);

-- permissions 表
CREATE UNIQUE INDEX idx_permissions_code ON permissions(code);

-- user_roles 表
CREATE UNIQUE INDEX idx_user_roles_unique ON user_roles(user_id, role_id);

-- role_permissions 表
CREATE UNIQUE INDEX idx_role_permissions_unique ON role_permissions(role_id, permission_id);
```

### 普通索引

```sql
-- users_auth 表
CREATE INDEX idx_users_auth_status ON users_auth(status);
CREATE INDEX idx_users_auth_created_at ON users_auth(created_at);

-- user_roles 表
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);

-- role_permissions 表
CREATE INDEX idx_role_permissions_role_id ON role_permissions(role_id);
CREATE INDEX idx_role_permissions_permission_id ON role_permissions(permission_id);

-- permissions 表
CREATE INDEX idx_permissions_resource ON permissions(resource);
```

**索引说明**:
- `username` 唯一索引：用于登录查询
- `status` 索引：用于筛选正常/禁用用户
- 外键字段索引：提高关联查询性能

---

## 数据关系图

```
┌─────────────────┐
│   users_auth    │
│  (用户认证表)    │
├─────────────────┤
│ id (PK)         │
│ username (UK)   │
│ password_hash   │
│ status          │
└────────┬────────┘
         │
         │ 1:N
         ↓
┌─────────────────┐      N:M      ┌─────────────────┐
│   user_roles    │ ←────────────→ │     roles       │
│  (用户角色关联)  │                │   (角色表)       │
├─────────────────┤                ├─────────────────┤
│ id (PK)         │                │ id (PK)         │
│ user_id (FK)    │                │ name (UK)       │
│ role_id (FK)    │                │ code (UK)       │
└─────────────────┘                └────────┬────────┘
                                            │
                                            │ 1:N
                                            ↓
                                   ┌─────────────────┐
                                   │role_permissions │
                                   │ (角色权限关联)   │
                                   ├─────────────────┤
                                   │ id (PK)         │
                                   │ role_id (FK)    │
                                   │ permission_id   │
                                   └────────┬────────┘
                                            │
                                            │ N:1
                                            ↓
                                   ┌─────────────────┐
                                   │  permissions    │
                                   │   (权限表)       │
                                   ├─────────────────┤
                                   │ id (PK)         │
                                   │ code (UK)       │
                                   │ resource        │
                                   │ action          │
                                   └─────────────────┘
```

---

## 初始化数据

### 1. 初始化角色

```sql
INSERT INTO roles (name, code, description) VALUES
('普通用户', 'user', '可以发帖、回复、点赞、收藏'),
('管理员', 'admin', '拥有全站管理权限');
```

### 2. 初始化权限

```sql
-- 内容权限
INSERT INTO permissions (name, code, resource, action, description) VALUES
('创建帖子', 'post:create', 'post', 'create', '发布新帖子'),
('查看帖子', 'post:read', 'post', 'read', '查看帖子内容'),
('编辑自己的帖子', 'post:update_own', 'post', 'update', '编辑自己发布的帖子'),
('删除自己的帖子', 'post:delete_own', 'post', 'delete', '删除自己发布的帖子'),
('管理所有帖子', 'post:manage', 'post', 'manage', '编辑、删除任意帖子，置顶帖子'),

-- 回复权限
('创建回复', 'reply:create', 'reply', 'create', '回复帖子'),
('编辑自己的回复', 'reply:update_own', 'reply', 'update', '编辑自己的回复'),
('删除自己的回复', 'reply:delete_own', 'reply', 'delete', '删除自己的回复'),
('管理所有回复', 'reply:manage', 'reply', 'manage', '删除任意回复'),

-- 互动权限
('点赞', 'interaction:like', 'interaction', 'create', '点赞帖子'),
('收藏', 'interaction:favorite', 'interaction', 'create', '收藏帖子'),

-- 用户管理权限
('管理用户', 'user:manage', 'user', 'manage', '创建、编辑、禁用用户'),

-- 板块管理权限
('管理板块', 'section:manage', 'section', 'manage', '创建、编辑、删除板块'),

-- 系统管理权限
('系统配置', 'system:manage', 'system', 'manage', '修改系统配置');
```

### 3. 分配角色权限

```sql
-- 普通用户权限
INSERT INTO role_permissions (role_id, permission_id)
SELECT 
    (SELECT id FROM roles WHERE code = 'user'),
    id
FROM permissions
WHERE code IN (
    'post:create', 'post:read', 'post:update_own', 'post:delete_own',
    'reply:create', 'reply:update_own', 'reply:delete_own',
    'interaction:like', 'interaction:favorite'
);

-- 管理员权限（拥有所有权限）
INSERT INTO role_permissions (role_id, permission_id)
SELECT 
    (SELECT id FROM roles WHERE code = 'admin'),
    id
FROM permissions;
```

### 4. 创建默认管理员账号

```sql
-- 密码: admin123 (BCrypt 加密后)
INSERT INTO users_auth (username, password_hash, status) VALUES
('admin', '$2b$10$YourBcryptHashHere', 'active');

-- 分配管理员角色
INSERT INTO user_roles (user_id, role_id)
SELECT 
    (SELECT id FROM users_auth WHERE username = 'admin'),
    (SELECT id FROM roles WHERE code = 'admin');
```

---

## 数据迁移策略

### 使用 node-pg-migrate

**安装**:
```bash
npm install node-pg-migrate
```

**迁移文件示例** (`migrations/001_initial_schema.js`):

```javascript
exports.up = (pgm) => {
  // 创建 users_auth 表
  pgm.createTable('users_auth', {
    id: 'id',
    username: { type: 'varchar(20)', notNull: true, unique: true },
    password_hash: { type: 'varchar(255)', notNull: true },
    status: { type: 'varchar(20)', notNull: true, default: 'active' },
    last_login_at: { type: 'timestamp' },
    created_at: {
      type: 'timestamp',
      notNull: true,
      default: pgm.func('current_timestamp')
    },
    updated_at: {
      type: 'timestamp',
      notNull: true,
      default: pgm.func('current_timestamp')
    }
  });

  // 创建索引
  pgm.createIndex('users_auth', 'username', { unique: true });
  pgm.createIndex('users_auth', 'status');

  // 创建其他表...
};

exports.down = (pgm) => {
  pgm.dropTable('users_auth');
};
```

**执行迁移**:
```bash
# 执行迁移
npm run migrate up

# 回滚迁移
npm run migrate down
```

---

## 性能优化建议

### 1. 查询优化

```sql
-- 使用 EXPLAIN ANALYZE 分析查询
EXPLAIN ANALYZE
SELECT u.*, r.code as role_code
FROM users_auth u
LEFT JOIN user_roles ur ON u.id = ur.user_id
LEFT JOIN roles r ON ur.role_id = r.id
WHERE u.username = 'alice';
```

### 2. 连接池配置

```javascript
const pool = new Pool({
  max: 20,              // 最大连接数
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});
```

### 3. 定期维护

```sql
-- 更新统计信息
ANALYZE users_auth;
ANALYZE user_roles;

-- 清理死元组
VACUUM ANALYZE users_auth;
```

---

## 备份策略

### 1. 定时备份

```bash
# 每天凌晨 2 点备份
0 2 * * * pg_dump -U open436 auth_db > /backup/auth_db_$(date +\%Y\%m\%d).sql
```

### 2. 恢复数据

```bash
psql -U open436 auth_db < /backup/auth_db_20251023.sql
```

---

**文档版本**: v1.0  
**创建日期**: 2025-10-23  
**最后更新**: 2025-10-23
