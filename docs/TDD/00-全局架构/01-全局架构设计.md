# Open436 全局架构设计文档

## 文档信息

**文档版本**: v1.0  
**创建日期**: 2025-10-23  
**文档类型**: 技术设计文档（TDD）  
**适用范围**: 全体开发团队

---

## 目录

1. [架构概述](#架构概述)
2. [微服务划分](#微服务划分)
3. [技术选型](#技术选型)
4. [服务依赖关系](#服务依赖关系)
5. [数据存储方案](#数据存储方案)
6. [服务注册与发现](#服务注册与发现)

---

## 架构概述

### 1.1 架构风格

Open436 采用**微服务架构**（Microservices Architecture），将系统拆分为多个独立的服务模块，每个服务：

- **独立部署**：可以单独构建、测试、部署
- **技术异构**：可以使用不同的编程语言和框架
- **数据隔离**：每个服务拥有独立的数据库
- **松耦合**：服务间通过 API 网关和标准协议通信

### 1.2 架构优势

| 优势 | 说明 |
|------|------|
| **技术灵活性** | 不同服务可选择最适合的技术栈 |
| **独立扩展** | 可针对高负载服务单独扩容 |
| **故障隔离** | 单个服务故障不影响整体系统 |
| **团队自治** | 不同团队可独立开发维护各自服务 |
| **持续交付** | 支持服务的独立快速迭代 |

### 1.3 架构挑战

| 挑战 | 应对方案 |
|------|----------|
| **分布式复杂性** | 使用 Kong 网关统一管理、服务网格简化通信 |
| **数据一致性** | 采用最终一致性、分布式事务（Saga模式） |
| **服务治理** | 引入服务注册中心、配置中心 |
| **运维复杂度** | 容器化部署（Docker）、编排工具（K8s） |

---

## 微服务划分

### 2.1 服务列表

基于业务领域和数据模型的内聚性，系统划分为 **8 个核心微服务**：

| 服务编号 | 服务名称 | 服务标识 | 端口 | 技术栈建议 | 优先级 |
|---------|---------|---------|------|-----------|--------|
| **S1** | 认证授权服务 | `auth-service` | 8001 | Node.js + Express | P0 |
| **S2** | 用户管理服务 | `user-service` | 8002 | Java + Spring Boot | P0 |
| **S3** | 内容管理服务 | `post-service` | 8003 | Python + FastAPI | P0 |
| **S4** | 互动评论服务 | `interaction-service` | 8004 | Node.js + Koa | P1 |
| **S5** | 板块管理服务 | `section-service` | 8005 | Java + Spring Boot | P2 |
| **S6** | 搜索索引服务 | `search-service` | 8006 | Python + FastAPI | P2 |
| **S7** | 文件存储服务 | `file-service` | 8007 | Go + Gin | P1 |
| **S8** | 系统管理服务 | `admin-service` | 8008 | Node.js + NestJS | P2 |

### 2.2 服务职责说明

#### S1 - 认证授权服务 (auth-service)

**核心职责**：
- 用户登录/登出
- JWT Token 生成与验证
- 权限验证（RBAC）
- 密码管理（修改、重置）
- 用户账号状态管理（启用/禁用）

**数据实体**：
- `users_auth` - 用户认证表（用户名、密码哈希、状态）
- `roles` - 角色表
- `permissions` - 权限表
- `role_permissions` - 角色权限关联表
- `user_roles` - 用户角色关联表

**对外接口**：
```
POST   /api/auth/login          # 用户登录
POST   /api/auth/logout         # 用户登出
POST   /api/auth/refresh        # 刷新Token
GET    /api/auth/verify         # 验证Token
PUT    /api/auth/password       # 修改密码
POST   /api/auth/users          # 创建用户（管理员）
PUT    /api/auth/users/:id/status  # 启用/禁用用户
```

**技术选型理由**：
- Node.js + Express：轻量级、高并发、适合I/O密集型认证场景
- JWT 库：jsonwebtoken
- 密码加密：bcrypt

---

#### S2 - 用户管理服务 (user-service)

**核心职责**：
- 用户资料管理（昵称、头像、简介）
- 用户个人主页数据聚合
- 用户统计数据（发帖数、回复数、获赞数）
- 用户活动历史查询

**数据实体**：
- `users_profile` - 用户资料表
- `user_statistics` - 用户统计表

**对外接口**：
```
GET    /api/users/:id           # 获取用户完整信息
PUT    /api/users/:id/profile   # 更新用户资料
GET    /api/users/:id/posts     # 获取用户发帖历史
GET    /api/users/:id/replies   # 获取用户回复历史
GET    /api/users/:id/stats     # 获取用户统计数据
```

**与其他服务的协作**：
- 调用 S1（认证服务）验证用户身份
- 调用 S3（内容服务）获取用户帖子列表
- 调用 S4（互动服务）获取用户回复列表

**技术选型理由**：
- Java + Spring Boot：成熟的企业级框架、强类型、适合复杂业务逻辑
- MyBatis/JPA：ORM 框架
- Redis：缓存用户信息

---

#### S3 - 内容管理服务 (post-service)

**核心职责**：
- 帖子的创建、编辑、删除
- 帖子状态管理（草稿、发布、置顶、删除）
- 帖子列表查询（分页、排序、筛选）
- 浏览量统计

**数据实体**：
- `posts` - 帖子主表
- `post_versions` - 帖子版本历史表
- `post_views` - 浏览记录表

**对外接口**：
```
POST   /api/posts               # 创建帖子
GET    /api/posts               # 获取帖子列表
GET    /api/posts/:id           # 获取帖子详情
PUT    /api/posts/:id           # 编辑帖子
DELETE /api/posts/:id           # 删除帖子
PUT    /api/posts/:id/pin       # 置顶帖子
POST   /api/posts/:id/view      # 记录浏览
```

**技术选型理由**：
- Python + FastAPI：高性能异步框架、开发效率高、适合内容处理
- SQLAlchemy：ORM 框架
- Markdown 处理：markdown-it-py

---

#### S4 - 互动评论服务 (interaction-service)

**核心职责**：
- 回复管理（创建、编辑、删除）
- 点赞功能
- 收藏功能
- 互动数据统计

**数据实体**：
- `replies` - 回复表
- `post_likes` - 点赞表
- `post_favorites` - 收藏表

**对外接口**：
```
POST   /api/posts/:id/replies   # 发布回复
PUT    /api/replies/:id         # 编辑回复
DELETE /api/replies/:id         # 删除回复
POST   /api/posts/:id/like      # 点赞
DELETE /api/posts/:id/like      # 取消点赞
POST   /api/posts/:id/favorite  # 收藏
GET    /api/users/:id/favorites # 获取收藏列表
```

**技术选型理由**：
- Node.js + Koa：轻量级、中间件机制优雅、适合高频互动场景
- Redis：缓存点赞、收藏状态

---

#### S5 - 板块管理服务 (section-service)

**核心职责**：
- 论坛板块的创建、编辑、删除
- 板块排序和配置
- 板块与帖子的关联管理

**数据实体**：
- `sections` - 板块表
- `section_configs` - 板块配置表

**技术选型理由**：
- Java + Spring Boot：适合管理类业务逻辑

---

#### S6 - 搜索索引服务 (search-service)

**核心职责**：
- 全文搜索（帖子标题+内容）
- 搜索索引构建与维护
- 搜索结果排序优化

**数据实体**：
- `search_indices` - 搜索索引表
- `search_logs` - 搜索日志表

**技术选型理由**：
- Python + FastAPI：与 Elasticsearch 集成方便
- Elasticsearch：全文搜索引擎

---

#### S7 - 文件存储服务 (file-service)

**核心职责**：
- 图片上传与存储
- 文件元数据管理
- 文件访问 URL 生成

**数据实体**：
- `file_uploads` - 文件上传记录表
- `file_metadata` - 文件元数据表

**技术选型理由**：
- Go + Gin：高性能、并发处理能力强、适合文件I/O
- MinIO/OSS：对象存储

---

#### S8 - 系统管理服务 (admin-service)

**核心职责**：
- 后台管理 Dashboard 数据聚合
- 系统配置管理
- 操作日志记录
- 数据统计分析

**数据实体**：
- `system_configs` - 系统配置表
- `audit_logs` - 审计日志表
- `operation_logs` - 操作日志表

**技术选型理由**：
- Node.js + NestJS：模块化架构、依赖注入、适合后台管理

---

## 技术选型

### 3.1 编程语言与框架

| 服务 | 语言 | 框架 | 版本要求 | 选型理由 |
|------|------|------|---------|---------|
| S1 认证授权 | Node.js | Express | Node 18+ | 高并发、I/O密集 |
| S2 用户管理 | Java | Spring Boot | Java 17+ | 企业级、强类型 |
| S3 内容管理 | Python | FastAPI | Python 3.10+ | 异步高性能 |
| S4 互动评论 | Node.js | Koa | Node 18+ | 轻量级、中间件 |
| S5 板块管理 | Java | Spring Boot | Java 17+ | 业务逻辑复杂 |
| S6 搜索索引 | Python | FastAPI | Python 3.10+ | ES集成方便 |
| S7 文件存储 | Go | Gin | Go 1.20+ | 高性能I/O |
| S8 系统管理 | Node.js | NestJS | Node 18+ | 模块化架构 |

### 3.2 数据库选型

| 数据类型 | 技术选型 | 使用场景 |
|---------|---------|---------|
| **关系型数据库** | PostgreSQL 14+ | 主数据存储（用户、帖子、回复等） |
| **缓存数据库** | Redis 7+ | 会话缓存、热点数据、计数器 |
| **搜索引擎** | Elasticsearch 8+ | 全文搜索、日志分析 |
| **对象存储** | MinIO / 阿里云OSS | 图片、文件存储 |

**数据库隔离原则**：
- 每个服务拥有独立的数据库实例或独立的 Schema
- 服务间不直接访问其他服务的数据库
- 数据共享通过 API 调用实现

### 3.3 API 网关

**选型**: Kong Gateway 3.x

**核心功能**：
- 统一入口：所有外部请求通过网关路由到后端服务
- 认证鉴权：集成 JWT 插件，统一验证用户身份
- 限流熔断：防止服务过载
- 日志监控：统一日志收集
- 负载均衡：请求分发到多个服务实例

### 3.4 容器化与编排

| 技术 | 版本 | 用途 |
|------|------|------|
| Docker | 24+ | 容器化打包 |
| Docker Compose | 2.x | 本地开发环境 |
| Kubernetes | 1.28+ | 生产环境编排（可选） |

### 3.5 监控与日志

| 组件 | 技术选型 | 用途 |
|------|---------|------|
| 日志收集 | ELK Stack (Elasticsearch + Logstash + Kibana) | 集中式日志管理 |
| 链路追踪 | Jaeger / Zipkin | 分布式追踪 |
| 指标监控 | Prometheus + Grafana | 性能监控、告警 |
| 健康检查 | Kong Health Checks | 服务健康状态 |

---

## 服务依赖关系

### 4.1 依赖关系图

```
┌─────────────────────────────────────────────────────────────┐
│                      Kong API Gateway                        │
│                    (统一入口 + JWT验证)                       │
└────────────────────────┬────────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┬──────────────┐
         │               │               │              │
    ┌────▼────┐    ┌────▼────┐    ┌────▼────┐    ┌───▼────┐
    │   S1    │    │   S2    │    │   S3    │    │   S4   │
    │  认证   │◄───┤  用户   │◄───┤  内容   │◄───┤  互动  │
    │  授权   │    │  管理   │    │  管理   │    │  评论  │
    └────┬────┘    └────┬────┘    └────┬────┘    └───┬────┘
         │              │              │              │
         │         ┌────▼────┐    ┌────▼────┐    ┌───▼────┐
         │         │   S5    │    │   S7    │    │   S8   │
         │         │  板块   │    │  文件   │    │  系统  │
         │         │  管理   │    │  存储   │    │  管理  │
         │         └─────────┘    └─────────┘    └────────┘
         │
         └──────────────┐
                   ┌────▼────┐
                   │   S6    │
                   │  搜索   │
                   │  索引   │
                   └─────────┘
```

### 4.2 依赖说明

**S1 认证授权服务**：
- 被所有服务依赖（通过 Kong 网关的 JWT 验证）
- 不依赖其他业务服务

**S2 用户管理服务**：
- 依赖 S1（验证用户身份）
- 被 S3、S4、S8 依赖（获取用户信息）

**S3 内容管理服务**：
- 依赖 S1（验证用户身份）
- 依赖 S2（获取作者信息）
- 依赖 S7（图片上传）
- 被 S4、S6、S8 依赖

**S4 互动评论服务**：
- 依赖 S1（验证用户身份）
- 依赖 S3（验证帖子存在性）

**S7 文件存储服务**：
- 依赖 S1（验证用户身份）
- 被 S2、S3 依赖

**S8 系统管理服务**：
- 依赖所有服务（聚合数据）

### 4.3 服务调用原则

1. **同步调用**：使用 HTTP/REST API（通过 Kong 网关）
2. **异步通信**：使用消息队列（RabbitMQ/Kafka，可选）
3. **服务发现**：通过 Kong 的 Service 配置或服务注册中心
4. **超时控制**：设置合理的超时时间（建议 3-5 秒）
5. **熔断降级**：使用 Kong 的 Circuit Breaker 插件

---

## 数据存储方案

### 5.1 数据库分配

| 服务 | 数据库实例 | Schema/Database 名称 | 说明 |
|------|-----------|---------------------|------|
| S1 认证授权 | PostgreSQL-1 | `auth_db` | 用户认证、角色权限 |
| S2 用户管理 | PostgreSQL-2 | `user_db` | 用户资料、统计数据 |
| S3 内容管理 | PostgreSQL-3 | `post_db` | 帖子、版本历史 |
| S4 互动评论 | PostgreSQL-4 | `interaction_db` | 回复、点赞、收藏 |
| S5 板块管理 | PostgreSQL-5 | `section_db` | 板块配置 |
| S6 搜索索引 | Elasticsearch | `posts_index` | 搜索索引 |
| S7 文件存储 | MinIO + PostgreSQL-6 | `file_db` | 文件元数据 |
| S8 系统管理 | PostgreSQL-7 | `admin_db` | 配置、日志 |

**部署建议**：
- **开发环境**：所有服务共用一个 PostgreSQL 实例，使用不同 Schema
- **生产环境**：每个服务独立的 PostgreSQL 实例，实现物理隔离

### 5.2 Redis 缓存策略

| 缓存类型 | Key 格式 | TTL | 使用服务 |
|---------|---------|-----|---------|
| JWT Token | `token:{user_id}` | 2小时/7天 | S1 |
| 用户信息 | `user:{user_id}` | 30分钟 | S2 |
| 帖子详情 | `post:{post_id}` | 10分钟 | S3 |
| 点赞状态 | `like:{user_id}:{post_id}` | 1小时 | S4 |
| 浏览计数 | `view_count:{post_id}` | 5分钟 | S3 |

### 5.3 数据一致性方案

**场景 1：创建用户**
```
1. S1 创建认证账号 (users_auth)
2. 调用 S2 API 创建用户资料 (users_profile)
3. 如果 S2 失败，S1 回滚或标记为待同步
```

**方案**：
- 使用 **Saga 模式**（编排式）
- S1 作为协调者，负责事务补偿

**场景 2：删除用户**
```
1. S1 禁用账号
2. 异步通知 S2、S3、S4 清理相关数据
```

**方案**：
- 使用 **消息队列**（RabbitMQ）
- 发布 `user.deleted` 事件
- 各服务订阅并处理

---

## 服务注册与发现

### 6.1 方案选择

**推荐方案**：Kong Gateway + DNS

**原因**：
- Kong 本身支持服务注册（Upstream + Target）
- 简化架构，无需额外的注册中心
- 适合中小规模微服务

**可选方案**：Consul / Eureka（大规模场景）

### 6.2 Kong 服务注册示例

```bash
# 注册认证服务
curl -X POST http://localhost:8001/services \
  --data name=auth-service \
  --data url=http://auth-service:8001

# 添加路由
curl -X POST http://localhost:8001/services/auth-service/routes \
  --data paths[]=/api/auth \
  --data strip_path=false
```

### 6.3 健康检查配置

```yaml
# Kong Upstream 健康检查
healthchecks:
  active:
    healthy:
      interval: 10  # 每10秒检查一次
      successes: 2  # 连续2次成功视为健康
    unhealthy:
      interval: 5
      tcp_failures: 3  # 连续3次失败视为不健康
```

---

## 开发环境搭建

### 7.1 本地开发环境

**使用 Docker Compose 一键启动所有服务**：

```yaml
# docker-compose.yml
version: '3.8'

services:
  # Kong 网关
  kong:
    image: kong:3.4
    ports:
      - "8000:8000"  # 代理端口
      - "8001:8001"  # Admin API
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-db
      KONG_PG_PASSWORD: kong

  # PostgreSQL (共享)
  postgres:
    image: postgres:14
    environment:
      POSTGRES_USER: open436
      POSTGRES_PASSWORD: open436
    volumes:
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql

  # Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  # 认证服务
  auth-service:
    build: ./services/auth-service
    ports:
      - "8001:8001"
    environment:
      DATABASE_URL: postgresql://open436:open436@postgres/auth_db
      REDIS_URL: redis://redis:6379

  # 用户服务
  user-service:
    build: ./services/user-service
    ports:
      - "8002:8002"
    environment:
      DATABASE_URL: postgresql://open436:open436@postgres/user_db

  # ... 其他服务
```

### 7.2 开发工具推荐

| 工具 | 用途 |
|------|------|
| Postman / Insomnia | API 测试 |
| Kong Manager | Kong 可视化管理 |
| DBeaver | 数据库管理 |
| Redis Commander | Redis 可视化 |
| Docker Desktop | 容器管理 |

---

## 部署架构

### 8.1 生产环境架构

```
                    ┌─────────────┐
                    │   Nginx     │
                    │  (SSL终端)  │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │    Kong     │
                    │  (API网关)  │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐      ┌─────▼─────┐     ┌─────▼─────┐
   │ Service │      │  Service  │     │  Service  │
   │ Pod 1   │      │   Pod 2   │     │   Pod 3   │
   │ (3副本) │      │  (2副本)  │     │  (2副本)  │
   └─────────┘      └───────────┘     └───────────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
                    ┌──────▼──────┐
                    │ PostgreSQL  │
                    │   Cluster   │
                    └─────────────┘
```

### 8.2 部署清单

| 组件 | 副本数 | 资源配置 | 说明 |
|------|--------|---------|------|
| Kong Gateway | 2 | 2C4G | 高可用 |
| S1 认证服务 | 3 | 1C2G | 高并发 |
| S2 用户服务 | 2 | 2C4G | 中等负载 |
| S3 内容服务 | 2 | 2C4G | 中等负载 |
| S4 互动服务 | 2 | 1C2G | 高频读写 |
| PostgreSQL | 1主2从 | 4C8G | 主从复制 |
| Redis | 1主2从 | 2C4G | 哨兵模式 |

---

## 下一步阅读

1. [Kong 网关配置指南](./02-Kong网关配置指南.md) - 详细的网关配置和插件使用
2. [服务间通信规范](./03-服务间通信规范.md) - 如何调用其他服务、鉴权集成
3. [API 设计规范](./04-API设计规范.md) - 统一的 API 标准
4. [部署运维指南](./05-部署运维指南.md) - Docker、K8s 部署方案

---

**文档维护**: 架构组  
**最后更新**: 2025-10-23
