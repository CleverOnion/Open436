# 部署运维指南

## 文档信息

**文档版本**: v1.0  
**创建日期**: 2025-10-23  
**文档类型**: 技术设计文档（TDD）  
**适用范围**: 运维团队、DevOps 工程师

---

## 目录

1. [环境规划](#环境规划)
2. [Docker 容器化](#docker-容器化)
3. [Docker Compose 本地部署](#docker-compose-本地部署)
4. [Kubernetes 生产部署](#kubernetes-生产部署)
5. [CI/CD 流程](#cicd-流程)
6. [监控与日志](#监控与日志)
7. [备份与恢复](#备份与恢复)

---

## 环境规划

### 1.1 环境分类

| 环境 | 用途 | 域名 | 部署方式 |
|------|------|------|---------|
| **开发环境** | 本地开发测试 | localhost | Docker Compose |
| **测试环境** | 集成测试 | test.open436.com | Docker Compose / K8s |
| **预发布环境** | 上线前验证 | staging.open436.com | Kubernetes |
| **生产环境** | 正式服务 | api.open436.com | Kubernetes |

### 1.2 资源规划

#### 开发环境

```yaml
服务数量: 8 个微服务 + Kong + PostgreSQL + Redis
总资源: 8C16G
单机部署: Docker Compose
```

#### 生产环境

```yaml
Kong Gateway: 2 副本 × 2C4G = 4C8G
认证服务 (S1): 3 副本 × 1C2G = 3C6G
用户服务 (S2): 2 副本 × 2C4G = 4C8G
内容服务 (S3): 2 副本 × 2C4G = 4C8G
互动服务 (S4): 2 副本 × 1C2G = 2C4G
其他服务: 各 1 副本
PostgreSQL: 1 主 2 从 × 4C8G = 12C24G
Redis: 1 主 2 从 × 2C4G = 6C12G
---
总计: 约 40C80G
```

---

## Docker 容器化

### 2.1 服务 Dockerfile 示例

#### Node.js 服务 (S1 认证服务)

```dockerfile
# Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# 复制依赖文件
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制源代码
COPY . .

# 多阶段构建，减小镜像体积
FROM node:18-alpine

WORKDIR /app

# 创建非 root 用户
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# 从 builder 复制文件
COPY --from=builder --chown=nodejs:nodejs /app .

# 切换用户
USER nodejs

# 暴露端口
EXPOSE 8001

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
  CMD node healthcheck.js || exit 1

# 启动命令
CMD ["node", "server.js"]
```

#### Java 服务 (S2 用户服务)

```dockerfile
# Dockerfile
FROM maven:3.9-eclipse-temurin-17 AS builder

WORKDIR /app

# 复制 pom.xml
COPY pom.xml .

# 下载依赖（利用缓存）
RUN mvn dependency:go-offline

# 复制源代码
COPY src ./src

# 构建
RUN mvn clean package -DskipTests

# 运行阶段
FROM eclipse-temurin:17-jre-alpine

WORKDIR /app

# 创建用户
RUN addgroup -g 1001 -S spring && \
    adduser -S spring -u 1001

# 复制 jar 文件
COPY --from=builder --chown=spring:spring /app/target/*.jar app.jar

USER spring

EXPOSE 8002

HEALTHCHECK --interval=30s --timeout=3s \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8002/actuator/health || exit 1

CMD ["java", "-jar", "app.jar"]
```

#### Python 服务 (S3 内容服务)

```dockerfile
# Dockerfile
FROM python:3.11-slim AS builder

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir --user -r requirements.txt

# 运行阶段
FROM python:3.11-slim

WORKDIR /app

# 创建用户
RUN useradd -m -u 1001 python

# 复制依赖
COPY --from=builder --chown=python:python /root/.local /home/python/.local

# 复制代码
COPY --chown=python:python . .

USER python

ENV PATH=/home/python/.local/bin:$PATH

EXPOSE 8003

HEALTHCHECK --interval=30s --timeout=3s \
  CMD python healthcheck.py || exit 1

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8003"]
```

### 2.2 构建镜像

```bash
# 构建认证服务镜像
docker build -t open436/auth-service:1.0.0 ./services/auth-service

# 构建用户服务镜像
docker build -t open436/user-service:1.0.0 ./services/user-service

# 构建内容服务镜像
docker build -t open436/post-service:1.0.0 ./services/post-service

# 推送到镜像仓库
docker push open436/auth-service:1.0.0
```

---

## Docker Compose 本地部署

### 3.1 完整 docker-compose.yml

```yaml
version: '3.8'

# 网络
networks:
  open436-net:
    driver: bridge

# 数据卷
volumes:
  postgres-data:
  redis-data:
  kong-db-data:

services:
  # ==================== 基础设施 ====================
  
  # PostgreSQL 数据库
  postgres:
    image: postgres:14-alpine
    container_name: open436-postgres
    environment:
      POSTGRES_USER: open436
      POSTGRES_PASSWORD: ${DB_PASSWORD:-open436_password}
      POSTGRES_DB: open436
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - open436-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U open436"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: open436-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis_password}
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - open436-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Kong 数据库
  kong-database:
    image: postgres:14-alpine
    container_name: kong-database
    environment:
      POSTGRES_USER: kong
      POSTGRES_DB: kong
      POSTGRES_PASSWORD: ${KONG_DB_PASSWORD:-kong_password}
    volumes:
      - kong-db-data:/var/lib/postgresql/data
    networks:
      - open436-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kong 初始化
  kong-migration:
    image: kong:3.4
    container_name: kong-migration
    command: kong migrations bootstrap
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: ${KONG_DB_PASSWORD:-kong_password}
      KONG_PG_DATABASE: kong
    networks:
      - open436-net
    depends_on:
      kong-database:
        condition: service_healthy
    restart: on-failure

  # Kong Gateway
  kong:
    image: kong:3.4
    container_name: kong
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: ${KONG_DB_PASSWORD:-kong_password}
      KONG_PG_DATABASE: kong
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
    ports:
      - "8000:8000"  # HTTP
      - "8443:8443"  # HTTPS
      - "8001:8001"  # Admin API
    networks:
      - open436-net
    depends_on:
      kong-database:
        condition: service_healthy
      kong-migration:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== 微服务 ====================
  
  # S1 认证授权服务
  auth-service:
    build: ./services/auth-service
    container_name: auth-service
    environment:
      NODE_ENV: development
      PORT: 8001
      DATABASE_URL: postgresql://open436:${DB_PASSWORD:-open436_password}@postgres:5432/auth_db
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379
      JWT_SECRET: ${JWT_SECRET:-your-jwt-secret-key}
      SERVICE_NAME: auth-service
      KONG_GATEWAY_URL: http://kong:8000
    ports:
      - "8001:8001"
    networks:
      - open436-net
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # S2 用户管理服务
  user-service:
    build: ./services/user-service
    container_name: user-service
    environment:
      SPRING_PROFILES_ACTIVE: development
      SERVER_PORT: 8002
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/user_db
      SPRING_DATASOURCE_USERNAME: open436
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-open436_password}
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_password}
      KONG_GATEWAY_URL: http://kong:8000
      SERVICE_NAME: user-service
    ports:
      - "8002:8002"
    networks:
      - open436-net
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  # S3 内容管理服务
  post-service:
    build: ./services/post-service
    container_name: post-service
    environment:
      DATABASE_URL: postgresql://open436:${DB_PASSWORD:-open436_password}@postgres:5432/post_db
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379
      KONG_GATEWAY_URL: http://kong:8000
      SERVICE_NAME: post-service
    ports:
      - "8003:8003"
    networks:
      - open436-net
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  # S4 互动评论服务
  interaction-service:
    build: ./services/interaction-service
    container_name: interaction-service
    environment:
      DATABASE_URL: postgresql://open436:${DB_PASSWORD:-open436_password}@postgres:5432/interaction_db
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379
      KONG_GATEWAY_URL: http://kong:8000
      SERVICE_NAME: interaction-service
    ports:
      - "8004:8004"
    networks:
      - open436-net
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  # S7 文件存储服务
  file-service:
    build: ./services/file-service
    container_name: file-service
    environment:
      DATABASE_URL: postgresql://open436:${DB_PASSWORD:-open436_password}@postgres:5432/file_db
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      KONG_GATEWAY_URL: http://kong:8000
      SERVICE_NAME: file-service
    ports:
      - "8007:8007"
    networks:
      - open436-net
    depends_on:
      - postgres
      - minio
    restart: unless-stopped

  # MinIO 对象存储
  minio:
    image: minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - ./data/minio:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - open436-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
```

### 3.2 环境变量配置

**.env 文件**：

```bash
# 数据库密码
DB_PASSWORD=your_secure_password

# Redis 密码
REDIS_PASSWORD=your_redis_password

# Kong 数据库密码
KONG_DB_PASSWORD=your_kong_password

# JWT 密钥
JWT_SECRET=your_jwt_secret_key_at_least_32_characters

# MinIO 配置
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin_password

# 服务 Token 密钥
SERVICE_TOKEN_SECRET=your_service_token_secret
```

### 3.3 启动与管理

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f auth-service

# 停止服务
docker-compose stop

# 停止并删除容器
docker-compose down

# 停止并删除容器和数据卷
docker-compose down -v
```

---

## Kubernetes 生产部署

### 4.1 命名空间

```yaml
# namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: open436
```

### 4.2 ConfigMap 配置

```yaml
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: open436-config
  namespace: open436
data:
  KONG_GATEWAY_URL: "http://kong.open436.svc.cluster.local:8000"
  POSTGRES_HOST: "postgres.open436.svc.cluster.local"
  REDIS_HOST: "redis.open436.svc.cluster.local"
```

### 4.3 Secret 敏感信息

```yaml
# secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: open436-secret
  namespace: open436
type: Opaque
stringData:
  DB_PASSWORD: "your_secure_password"
  REDIS_PASSWORD: "your_redis_password"
  JWT_SECRET: "your_jwt_secret_key"
```

### 4.4 服务部署示例 (S1 认证服务)

```yaml
# auth-service-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: open436
  labels:
    app: auth-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
      - name: auth-service
        image: open436/auth-service:1.0.0
        ports:
        - containerPort: 8001
        env:
        - name: DATABASE_URL
          value: "postgresql://open436:$(DB_PASSWORD)@$(POSTGRES_HOST):5432/auth_db"
        - name: REDIS_URL
          value: "redis://:$(REDIS_PASSWORD)@$(REDIS_HOST):6379"
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: open436-secret
              key: JWT_SECRET
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: open436-secret
              key: DB_PASSWORD
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: open436-secret
              key: REDIS_PASSWORD
        envFrom:
        - configMapRef:
            name: open436-config
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8001
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8001
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: open436
spec:
  selector:
    app: auth-service
  ports:
  - protocol: TCP
    port: 8001
    targetPort: 8001
  type: ClusterIP
```

### 4.5 Ingress 配置

```yaml
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: open436-ingress
  namespace: open436
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - api.open436.com
    secretName: open436-tls
  rules:
  - host: api.open436.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kong
            port:
              number: 8000
```

### 4.6 部署命令

```bash
# 创建命名空间
kubectl apply -f namespace.yaml

# 创建 ConfigMap 和 Secret
kubectl apply -f configmap.yaml
kubectl apply -f secret.yaml

# 部署数据库
kubectl apply -f postgres-deployment.yaml
kubectl apply -f redis-deployment.yaml

# 部署 Kong
kubectl apply -f kong-deployment.yaml

# 部署微服务
kubectl apply -f auth-service-deployment.yaml
kubectl apply -f user-service-deployment.yaml
kubectl apply -f post-service-deployment.yaml

# 配置 Ingress
kubectl apply -f ingress.yaml

# 查看部署状态
kubectl get pods -n open436
kubectl get svc -n open436
```

---

## CI/CD 流程

### 5.1 GitLab CI 示例

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - deploy

variables:
  DOCKER_REGISTRY: registry.open436.com
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

# 构建阶段
build:auth-service:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $DOCKER_REGISTRY
    - docker build -t $DOCKER_REGISTRY/auth-service:$IMAGE_TAG ./services/auth-service
    - docker push $DOCKER_REGISTRY/auth-service:$IMAGE_TAG
  only:
    - main
    - develop

# 测试阶段
test:auth-service:
  stage: test
  image: node:18
  script:
    - cd services/auth-service
    - npm install
    - npm test
  only:
    - main
    - develop

# 部署到测试环境
deploy:test:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl set image deployment/auth-service auth-service=$DOCKER_REGISTRY/auth-service:$IMAGE_TAG -n open436-test
    - kubectl rollout status deployment/auth-service -n open436-test
  only:
    - develop
  environment:
    name: test
    url: https://test.open436.com

# 部署到生产环境
deploy:production:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl set image deployment/auth-service auth-service=$DOCKER_REGISTRY/auth-service:$IMAGE_TAG -n open436
    - kubectl rollout status deployment/auth-service -n open436
  only:
    - main
  when: manual
  environment:
    name: production
    url: https://api.open436.com
```

---

## 监控与日志

### 6.1 Prometheus 监控

```yaml
# prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: open436
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    
    scrape_configs:
      - job_name: 'kong'
        static_configs:
          - targets: ['kong:8001']
      
      - job_name: 'auth-service'
        static_configs:
          - targets: ['auth-service:8001']
```

### 6.2 Grafana Dashboard

```json
{
  "dashboard": {
    "title": "Open436 Monitoring",
    "panels": [
      {
        "title": "Request Rate",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])"
          }
        ]
      }
    ]
  }
}
```

### 6.3 日志收集 (ELK)

```yaml
# filebeat-config.yaml
filebeat.inputs:
- type: container
  paths:
    - /var/lib/docker/containers/*/*.log
  processors:
    - add_kubernetes_metadata:
        host: ${NODE_NAME}

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
```

---

## 备份与恢复

### 7.1 数据库备份

```bash
# 备份脚本
#!/bin/bash
BACKUP_DIR="/backup/postgres"
DATE=$(date +%Y%m%d_%H%M%S)

# 备份所有数据库
docker exec open436-postgres pg_dumpall -U open436 > $BACKUP_DIR/backup_$DATE.sql

# 压缩
gzip $BACKUP_DIR/backup_$DATE.sql

# 删除 7 天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete
```

### 7.2 数据库恢复

```bash
# 恢复数据库
gunzip -c /backup/postgres/backup_20251023_120000.sql.gz | \
  docker exec -i open436-postgres psql -U open436
```

---

**文档维护**: 运维组  
**最后更新**: 2025-10-23
