# M2 用户管理服务 - 数据库设计

## 文档信息

**服务名称**: 用户管理服务 (user-service)  
**数据库**: PostgreSQL 14+  
**Schema**: `user_db`  
**版本**: v1.0

---

## 目录

1. [数据库概述](#数据库概述)
2. [表结构设计](#表结构设计)
3. [索引设计](#索引设计)
4. [数据关系图](#数据关系图)
5. [数据约束与验证](#数据约束与验证)
6. [性能优化](#性能优化)

---

## 数据库概述

### 设计原则

1. **职责单一**: 仅存储用户业务信息，不涉及认证凭据（由 M1 负责）
2. **数据隔离**: 与其他服务的数据库完全隔离
3. **关联简单**: 通过 `user_id` 与 M1 的 `users_auth` 表关联
4. **性能优先**: 合理使用索引和缓存，支持高并发查询

### 与 M1 的关系

| M1 认证授权服务 | M2 用户管理服务    |
| --------------- | ------------------ |
| `users_auth` 表 | `users_profile` 表 |
| user_id (PK)    | user_id (PK, FK)   |
| username        | nickname           |
| password_hash   | avatar_url         |
| status          | bio                |
| 认证凭据        | 业务信息           |

### 表列表

| 表名              | 说明       | 记录数估算 |
| ----------------- | ---------- | ---------- |
| `users_profile`   | 用户资料表 | 1000-10000 |
| `user_statistics` | 用户统计表 | 1000-10000 |

---

## 表结构设计

### 1. users_profile - 用户资料表

**用途**: 存储用户的业务信息（昵称、头像、简介等）

```sql
CREATE TABLE users_profile (
    user_id INTEGER PRIMARY KEY,
    nickname VARCHAR(20) NOT NULL,
    avatar_url VARCHAR(500),
    bio TEXT,
    nickname_updated_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_nickname_length CHECK (LENGTH(nickname) >= 2 AND LENGTH(nickname) <= 20),
    CONSTRAINT chk_bio_length CHECK (LENGTH(bio) <= 200)
);

-- 添加注释
COMMENT ON TABLE users_profile IS '用户资料表';
COMMENT ON COLUMN users_profile.user_id IS '用户ID（主键，关联 M1 的 users_auth.id）';
COMMENT ON COLUMN users_profile.nickname IS '昵称（2-20字符）';
COMMENT ON COLUMN users_profile.avatar_url IS '头像URL（存储在 M7 文件服务）';
COMMENT ON COLUMN users_profile.bio IS '个人简介（最大200字符）';
COMMENT ON COLUMN users_profile.nickname_updated_at IS '昵称最后修改时间（用于30天限制）';
COMMENT ON COLUMN users_profile.created_at IS '创建时间';
COMMENT ON COLUMN users_profile.updated_at IS '更新时间';
```

**字段说明**:

| 字段                  | 类型         | 约束        | 说明                              |
| --------------------- | ------------ | ----------- | --------------------------------- |
| `user_id`             | INTEGER      | PRIMARY KEY | 用户 ID，关联 M1 的 users_auth.id |
| `nickname`            | VARCHAR(20)  | NOT NULL    | 昵称，2-20 字符                   |
| `avatar_url`          | VARCHAR(500) | NULL        | 头像 URL（指向 M7 文件服务）      |
| `bio`                 | TEXT         | NULL        | 个人简介，最大 200 字符           |
| `nickname_updated_at` | TIMESTAMP    | NULL        | 昵称最后修改时间                  |
| `created_at`          | TIMESTAMP    | NOT NULL    | 创建时间                          |
| `updated_at`          | TIMESTAMP    | NOT NULL    | 更新时间                          |

**业务规则**:

- 昵称长度：2-20 个字符
- 昵称可以重复（与用户名不同）
- 昵称每 30 天只能修改一次
- 个人简介最大 200 字符
- 头像 URL 指向 M7 文件存储服务

**示例数据**:

```sql
INSERT INTO users_profile (user_id, nickname, avatar_url, bio) VALUES
(1, 'Alice', 'https://cdn.example.com/avatars/alice.jpg', '热爱编程的开发者'),
(2, 'Bob', 'https://cdn.example.com/avatars/bob.jpg', 'Full Stack Developer'),
(3, 'Charlie', NULL, NULL);
```

---

### 2. user_statistics - 用户统计表

**用途**: 存储用户的活动统计数据

```sql
CREATE TABLE user_statistics (
    user_id INTEGER PRIMARY KEY,
    posts_count INTEGER NOT NULL DEFAULT 0,
    replies_count INTEGER NOT NULL DEFAULT 0,
    likes_received INTEGER NOT NULL DEFAULT 0,
    favorites_received INTEGER NOT NULL DEFAULT 0,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_user FOREIGN KEY (user_id)
        REFERENCES users_profile(user_id) ON DELETE CASCADE,
    CONSTRAINT chk_posts_count CHECK (posts_count >= 0),
    CONSTRAINT chk_replies_count CHECK (replies_count >= 0),
    CONSTRAINT chk_likes_received CHECK (likes_received >= 0),
    CONSTRAINT chk_favorites_received CHECK (favorites_received >= 0)
);

-- 添加注释
COMMENT ON TABLE user_statistics IS '用户统计表';
COMMENT ON COLUMN user_statistics.user_id IS '用户ID（主键，外键）';
COMMENT ON COLUMN user_statistics.posts_count IS '发帖数';
COMMENT ON COLUMN user_statistics.replies_count IS '回复数';
COMMENT ON COLUMN user_statistics.likes_received IS '获赞总数';
COMMENT ON COLUMN user_statistics.favorites_received IS '获收藏总数';
COMMENT ON COLUMN user_statistics.updated_at IS '更新时间';
```

**字段说明**:

| 字段                 | 类型      | 约束                | 说明       |
| -------------------- | --------- | ------------------- | ---------- |
| `user_id`            | INTEGER   | PRIMARY KEY, FK     | 用户 ID    |
| `posts_count`        | INTEGER   | NOT NULL, DEFAULT 0 | 发帖数     |
| `replies_count`      | INTEGER   | NOT NULL, DEFAULT 0 | 回复数     |
| `likes_received`     | INTEGER   | NOT NULL, DEFAULT 0 | 获赞总数   |
| `favorites_received` | INTEGER   | NOT NULL, DEFAULT 0 | 获收藏总数 |
| `updated_at`         | TIMESTAMP | NOT NULL            | 更新时间   |

**业务规则**:

- 所有统计数字不能为负数
- 发帖数由 M3 内容管理服务更新
- 回复数由 M4 互动评论服务更新
- 获赞数、获收藏数由 M4 互动评论服务更新
- 删除用户时，级联删除统计数据

**更新规则**:

| 操作           | 字段               | 变化 |
| -------------- | ------------------ | ---- |
| 用户发帖       | posts_count        | +1   |
| 用户删帖       | posts_count        | -1   |
| 用户回复       | replies_count      | +1   |
| 用户删除回复   | replies_count      | -1   |
| 帖子被点赞     | likes_received     | +1   |
| 帖子被取消点赞 | likes_received     | -1   |
| 帖子被收藏     | favorites_received | +1   |
| 帖子被取消收藏 | favorites_received | -1   |

**示例数据**:

```sql
INSERT INTO user_statistics (user_id, posts_count, replies_count, likes_received, favorites_received) VALUES
(1, 15, 42, 128, 35),
(2, 8, 23, 67, 12),
(3, 0, 0, 0, 0);
```

---

## 索引设计

### 主键索引（自动创建）

```sql
-- users_profile(user_id)
-- user_statistics(user_id)
```

### 唯一索引

```sql
-- 无额外唯一索引（user_id 已作为主键）
```

### 普通索引

```sql
-- users_profile 表
CREATE INDEX idx_users_profile_nickname ON users_profile(nickname);
CREATE INDEX idx_users_profile_created_at ON users_profile(created_at);
CREATE INDEX idx_users_profile_updated_at ON users_profile(updated_at);

-- user_statistics 表
CREATE INDEX idx_user_statistics_posts_count ON user_statistics(posts_count DESC);
CREATE INDEX idx_user_statistics_likes_received ON user_statistics(likes_received DESC);
```

**索引说明**:

- `nickname` 索引：用于按昵称搜索用户
- `created_at` 索引：用于按注册时间排序
- `posts_count`, `likes_received` 降序索引：用于排行榜查询

---

## 数据关系图

### M1 与 M2 的关联

```
M1 认证授权服务                    M2 用户管理服务
┌─────────────────┐               ┌─────────────────┐
│   users_auth    │               │  users_profile  │
├─────────────────┤               ├─────────────────┤
│ id (PK)         │ 1:1           │ user_id (PK,FK) │
│ username        │ ←────────────→│ nickname        │
│ password_hash   │               │ avatar_url      │
│ status          │               │ bio             │
└─────────────────┘               └────────┬────────┘
                                           │
                                           │ 1:1
                                           ↓
                                  ┌─────────────────┐
                                  │user_statistics  │
                                  ├─────────────────┤
                                  │ user_id (PK,FK) │
                                  │ posts_count     │
                                  │ replies_count   │
                                  │ likes_received  │
                                  └─────────────────┘
```

### M2 内部关系

```
users_profile (用户资料)
    ↓ 1:1
user_statistics (用户统计)
```

**关系说明**:

- `users_profile.user_id` 关联 M1 的 `users_auth.id`（逻辑外键，跨数据库）
- `user_statistics.user_id` 关联 `users_profile.user_id`（物理外键，同数据库）
- 一个用户有一个资料记录和一个统计记录

---

## 数据约束与验证

### 1. 字段长度约束

```sql
-- 昵称长度：2-20 字符
ALTER TABLE users_profile
ADD CONSTRAINT chk_nickname_length
CHECK (LENGTH(nickname) >= 2 AND LENGTH(nickname) <= 20);

-- 个人简介长度：最大 200 字符
ALTER TABLE users_profile
ADD CONSTRAINT chk_bio_length
CHECK (bio IS NULL OR LENGTH(bio) <= 200);
```

### 2. 数值范围约束

```sql
-- 统计数据不能为负
ALTER TABLE user_statistics
ADD CONSTRAINT chk_posts_count CHECK (posts_count >= 0);

ALTER TABLE user_statistics
ADD CONSTRAINT chk_replies_count CHECK (replies_count >= 0);

ALTER TABLE user_statistics
ADD CONSTRAINT chk_likes_received CHECK (likes_received >= 0);

ALTER TABLE user_statistics
ADD CONSTRAINT chk_favorites_received CHECK (favorites_received >= 0);
```

### 3. 业务逻辑约束

#### 昵称修改频率限制（应用层实现）

```python
# 检查是否可以修改昵称
def can_update_nickname(user_id: int) -> bool:
    profile = UserProfile.objects.get(user_id=user_id)
    if profile.nickname_updated_at is None:
        return True

    days_since_last_update = (timezone.now() - profile.nickname_updated_at).days
    return days_since_last_update >= 30
```

---

## 性能优化

### 1. 查询优化

#### 获取用户完整信息（资料 + 统计）

```sql
-- 使用 LEFT JOIN 一次查询
SELECT
    p.user_id,
    p.nickname,
    p.avatar_url,
    p.bio,
    p.created_at,
    COALESCE(s.posts_count, 0) as posts_count,
    COALESCE(s.replies_count, 0) as replies_count,
    COALESCE(s.likes_received, 0) as likes_received,
    COALESCE(s.favorites_received, 0) as favorites_received
FROM users_profile p
LEFT JOIN user_statistics s ON p.user_id = s.user_id
WHERE p.user_id = 1;
```

#### Django ORM 优化

```python
# 使用 select_related 避免 N+1 查询
from django.db.models import F

user_data = UserProfile.objects.select_related('statistics').get(user_id=1)
```

### 2. 索引优化

```sql
-- 复合索引：用于按统计数据排序的用户列表
CREATE INDEX idx_statistics_posts_likes
ON user_statistics(posts_count DESC, likes_received DESC);

-- 部分索引：仅索引活跃用户（发帖数 > 0）
CREATE INDEX idx_active_users
ON user_statistics(posts_count DESC)
WHERE posts_count > 0;
```

### 3. 分区表（可选，用户量大时）

```sql
-- 按用户 ID 范围分区
CREATE TABLE users_profile_partitioned (
    LIKE users_profile INCLUDING ALL
) PARTITION BY RANGE (user_id);

CREATE TABLE users_profile_p1 PARTITION OF users_profile_partitioned
    FOR VALUES FROM (1) TO (100000);

CREATE TABLE users_profile_p2 PARTITION OF users_profile_partitioned
    FOR VALUES FROM (100000) TO (200000);
```

---

## Django 迁移文件

### 初始迁移

```python
# apps/users/migrations/0001_initial.py
from django.db import migrations, models

class Migration(migrations.Migration):
    initial = True

    dependencies = []

    operations = [
        migrations.CreateModel(
            name='UserProfile',
            fields=[
                ('user_id', models.IntegerField(primary_key=True, serialize=False)),
                ('nickname', models.CharField(max_length=20)),
                ('avatar_url', models.URLField(blank=True, max_length=500)),
                ('bio', models.TextField(blank=True, max_length=200)),
                ('nickname_updated_at', models.DateTimeField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'db_table': 'users_profile',
                'verbose_name': '用户资料',
                'verbose_name_plural': '用户资料',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='UserStatistics',
            fields=[
                ('user_id', models.OneToOneField(
                    on_delete=models.CASCADE,
                    primary_key=True,
                    related_name='statistics',
                    serialize=False,
                    to='users.userprofile'
                )),
                ('posts_count', models.IntegerField(default=0)),
                ('replies_count', models.IntegerField(default=0)),
                ('likes_received', models.IntegerField(default=0)),
                ('favorites_received', models.IntegerField(default=0)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'db_table': 'user_statistics',
                'verbose_name': '用户统计',
                'verbose_name_plural': '用户统计',
            },
        ),
        migrations.AddIndex(
            model_name='userprofile',
            index=models.Index(fields=['nickname'], name='idx_users_profile_nickname'),
        ),
        migrations.AddIndex(
            model_name='userstatistics',
            index=models.Index(fields=['-posts_count'], name='idx_user_statistics_posts_count'),
        ),
    ]
```

---

## 数据完整性保障

### 1. 触发器：自动更新 updated_at

```sql
-- 创建触发器函数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 应用到表
CREATE TRIGGER update_users_profile_updated_at
    BEFORE UPDATE ON users_profile
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_user_statistics_updated_at
    BEFORE UPDATE ON user_statistics
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

### 2. 事务保障

```python
from django.db import transaction

@transaction.atomic
def create_user_with_stats(user_id: int, nickname: str):
    """原子性创建用户资料和统计记录"""
    # 创建资料
    profile = UserProfile.objects.create(
        user_id=user_id,
        nickname=nickname
    )

    # 创建统计记录
    UserStatistics.objects.create(
        user_id=profile.user_id
    )

    return profile
```

---

## 备份与恢复

### 1. 定时备份

```bash
#!/bin/bash
# scripts/backup_db.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/user_db"
DB_NAME="user_db"
DB_USER="open436"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
pg_dump -U $DB_USER -h localhost $DB_NAME > $BACKUP_DIR/user_db_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/user_db_$DATE.sql

# 删除 7 天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "Backup completed: user_db_$DATE.sql.gz"
```

### 2. 恢复数据

```bash
# 解压备份文件
gunzip /backup/user_db/user_db_20251027.sql.gz

# 恢复数据库
psql -U open436 -d user_db < /backup/user_db/user_db_20251027.sql
```

---

## 监控与维护

### 1. 表大小监控

```sql
-- 查看表大小
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 2. 索引使用情况

```sql
-- 查看索引使用统计
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

### 3. 慢查询分析

```sql
-- 启用慢查询日志
ALTER SYSTEM SET log_min_duration_statement = 1000;  -- 记录超过1秒的查询
SELECT pg_reload_conf();
```

---

**文档版本**: v1.0  
**创建日期**: 2025-10-27  
**最后更新**: 2025-10-27
