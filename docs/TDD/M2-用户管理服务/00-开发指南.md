# M2 用户管理服务 - 开发指南

## 文档信息

**服务名称**: 用户管理服务 (user-service)  
**技术栈**: Python 3.11+ + Django 4.2+ + Django REST Framework  
**版本**: v1.0

---

## 目录

1. [开发环境搭建](#开发环境搭建)
2. [项目结构](#项目结构)
3. [开发规范](#开发规范)
4. [代码风格](#代码风格)
5. [Git 工作流](#git-工作流)
6. [常见问题](#常见问题)

---

## 开发环境搭建

### 系统要求

- **操作系统**: Linux / macOS / Windows (推荐 Linux/macOS)
- **Python**: 3.11+
- **PostgreSQL**: 14+
- **Git**: 2.30+

### 安装 Python 3.11+

#### macOS (使用 Homebrew)

```bash
brew install python@3.11
```

#### Ubuntu/Debian

```bash
sudo apt update
sudo apt install python3.11 python3.11-venv python3.11-dev
```

#### Windows

从官网下载安装: https://www.python.org/downloads/

### 安装 PostgreSQL

#### macOS

```bash
brew install postgresql@14
brew services start postgresql@14
```

#### Ubuntu/Debian

```bash
sudo apt install postgresql-14
sudo systemctl start postgresql
```

---

## 创建项目

### 1. 克隆代码仓库

```bash
git clone https://github.com/your-org/open436.git
cd open436/services/user-service
```

### 2. 创建虚拟环境

```bash
# 创建虚拟环境
python3.11 -m venv venv

# 激活虚拟环境
# Linux/macOS:
source venv/bin/activate

# Windows:
venv\Scripts\activate
```

### 3. 安装依赖

```bash
# 升级 pip
pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt

# 安装开发依赖
pip install -r requirements-dev.txt
```

### 4. 配置环境变量

创建 `.env` 文件:

```bash
cp .env.example .env
```

编辑 `.env` 文件:

```bash
# Django 设置
DEBUG=True
SECRET_KEY=your-secret-key-here
ALLOWED_HOSTS=localhost,127.0.0.1

# 数据库配置
DATABASE_URL=postgresql://open436:password@localhost:5432/user_db

# M1 认证服务地址
AUTH_SERVICE_URL=http://localhost:8001

# M7 文件存储服务地址
FILE_SERVICE_URL=http://localhost:8007

# 日志级别
LOG_LEVEL=DEBUG
```

### 5. 创建数据库

```bash
# 登录 PostgreSQL
psql -U postgres

# 创建数据库和用户
CREATE DATABASE user_db;
CREATE USER open436 WITH PASSWORD 'password';
GRANT ALL PRIVILEGES ON DATABASE user_db TO open436;
\q
```

### 6. 执行数据库迁移

```bash
# 生成迁移文件
python manage.py makemigrations

# 执行迁移
python manage.py migrate

# 加载初始数据（可选）
python manage.py loaddata initial_data.json
```

### 7. 创建超级用户

```bash
python manage.py createsuperuser
```

### 8. 运行开发服务器

```bash
python manage.py runserver 8002
```

访问: http://localhost:8002/api/docs/

---

## 项目结构

```
user-service/
├── manage.py                       # Django 管理脚本
├── requirements.txt                # 生产环境依赖
├── requirements-dev.txt            # 开发环境依赖
├── .env.example                    # 环境变量示例
├── .gitignore                      # Git 忽略文件
├── pytest.ini                      # pytest 配置
├── setup.cfg                       # flake8、isort 配置
├── Dockerfile                      # Docker 镜像
├── docker-compose.yml              # Docker Compose 配置
│
├── config/                         # Django 配置
│   ├── __init__.py
│   ├── settings.py                # 主配置文件
│   ├── settings/                  # 分环境配置
│   │   ├── base.py               # 基础配置
│   │   ├── development.py        # 开发环境
│   │   ├── production.py         # 生产环境
│   │   └── test.py               # 测试环境
│   ├── urls.py                   # 全局路由
│   ├── wsgi.py                   # WSGI 入口
│   └── asgi.py                   # ASGI 入口
│
├── apps/                          # 应用目录
│   ├── __init__.py
│   │
│   ├── users/                    # 用户管理应用
│   │   ├── __init__.py
│   │   ├── admin.py              # Django Admin 配置
│   │   ├── apps.py               # 应用配置
│   │   ├── models.py             # 数据模型
│   │   ├── serializers.py        # DRF 序列化器
│   │   ├── views.py              # 视图集
│   │   ├── urls.py               # 路由配置
│   │   ├── permissions.py        # 权限类
│   │   ├── services.py           # 业务逻辑层
│   │   ├── filters.py            # 过滤器
│   │   ├── pagination.py         # 分页器
│   │   ├── tasks.py              # Celery 任务
│   │   ├── signals.py            # Django 信号
│   │   ├── validators.py         # 字段验证器
│   │   ├── exceptions.py         # 自定义异常
│   │   ├── migrations/           # 数据库迁移文件
│   │   │   └── __init__.py
│   │   └── tests/                # 测试
│   │       ├── __init__.py
│   │       ├── test_models.py
│   │       ├── test_views.py
│   │       ├── test_services.py
│   │       └── factories.py      # 测试数据工厂
│   │
│   └── core/                     # 核心工具应用
│       ├── __init__.py
│       ├── middleware.py         # 中间件
│       ├── authentication.py     # 自定义认证
│       ├── permissions.py        # 全局权限
│       ├── exceptions.py         # 异常处理
│       ├── pagination.py         # 全局分页
│       ├── renderers.py          # 响应渲染器
│       ├── utils.py              # 工具函数
│       └── cache.py              # 缓存工具
│
├── static/                        # 静态文件
│   ├── admin/
│   └── api/
│
├── media/                         # 媒体文件
│   └── uploads/
│
├── logs/                          # 日志文件
│   ├── django.log
│   └── error.log
│
├── scripts/                       # 脚本工具
│   ├── init_db.py                # 初始化数据库
│   ├── seed_data.py              # 填充测试数据
│   └── backup_db.sh              # 备份数据库
│
└── docs/                          # 项目文档
    ├── api_examples.md
    └── deployment.md
```

---

## 开发规范

### 1. Django App 组织原则

#### 单一职责原则

每个 App 只负责一个领域的功能:

- `users`: 用户资料管理
- `core`: 核心工具和基础功能

#### App 命名规范

- 使用小写复数形式: `users`, `posts`, `comments`
- 语义清晰，避免缩写

### 2. 模型设计规范

#### 基础模型类

```python
# apps/core/models.py
from django.db import models

class TimeStampedModel(models.Model):
    """抽象基类：添加时间戳字段"""
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="创建时间")
    updated_at = models.DateTimeField(auto_now=True, verbose_name="更新时间")

    class Meta:
        abstract = True
```

#### 模型定义示例

```python
# apps/users/models.py
from django.db import models
from apps.core.models import TimeStampedModel

class UserProfile(TimeStampedModel):
    """用户资料模型"""
    user_id = models.IntegerField(primary_key=True, verbose_name="用户ID")
    nickname = models.CharField(max_length=20, verbose_name="昵称")
    avatar_url = models.URLField(blank=True, verbose_name="头像URL")
    bio = models.TextField(max_length=200, blank=True, verbose_name="个人简介")
    nickname_updated_at = models.DateTimeField(null=True, verbose_name="昵称修改时间")

    class Meta:
        db_table = 'users_profile'
        verbose_name = '用户资料'
        verbose_name_plural = '用户资料'
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.nickname} ({self.user_id})"
```

### 3. 序列化器规范

```python
# apps/users/serializers.py
from rest_framework import serializers
from .models import UserProfile

class UserProfileSerializer(serializers.ModelSerializer):
    """用户资料序列化器"""

    class Meta:
        model = UserProfile
        fields = ['user_id', 'nickname', 'avatar_url', 'bio', 'created_at']
        read_only_fields = ['user_id', 'created_at']

    def validate_nickname(self, value):
        """验证昵称"""
        if len(value) < 2:
            raise serializers.ValidationError("昵称长度至少为2个字符")
        if len(value) > 20:
            raise serializers.ValidationError("昵称长度不能超过20个字符")
        return value
```

### 4. 视图集规范

```python
# apps/users/views.py
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from .models import UserProfile
from .serializers import UserProfileSerializer
from .services import UserService

class UserViewSet(viewsets.ModelViewSet):
    """用户资料视图集"""
    queryset = UserProfile.objects.all()
    serializer_class = UserProfileSerializer
    lookup_field = 'user_id'

    @action(detail=True, methods=['get'])
    def statistics(self, request, user_id=None):
        """获取用户统计数据"""
        user = self.get_object()
        stats = UserService.get_user_statistics(user.user_id)
        return Response(stats)
```

### 5. 业务逻辑层 (Service)

```python
# apps/users/services.py
from django.db import transaction
from .models import UserProfile, UserStatistics
from apps.core.cache import cache_user_profile

class UserService:
    """用户服务类"""

    @staticmethod
    @cache_user_profile(timeout=300)
    def get_user_profile(user_id: int) -> dict:
        """获取用户资料（带缓存）"""
        try:
            profile = UserProfile.objects.get(user_id=user_id)
            return {
                'user_id': profile.user_id,
                'nickname': profile.nickname,
                'avatar_url': profile.avatar_url,
                'bio': profile.bio,
            }
        except UserProfile.DoesNotExist:
            raise ValueError(f"用户 {user_id} 不存在")

    @staticmethod
    @transaction.atomic
    def update_user_statistics(user_id: int, field: str, value: int):
        """更新用户统计数据（原子操作）"""
        stats, created = UserStatistics.objects.get_or_create(user_id=user_id)
        current_value = getattr(stats, field, 0)
        setattr(stats, field, current_value + value)
        stats.save()
```

### 6. URL 路由规范

```python
# apps/users/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import UserViewSet

app_name = 'users'

router = DefaultRouter()
router.register(r'users', UserViewSet, basename='user')

urlpatterns = [
    path('', include(router.urls)),
]
```

---

## 代码风格

### Python 代码风格 (PEP 8)

#### 使用 Black 格式化代码

```bash
# 安装 Black
pip install black

# 格式化所有代码
black .

# 检查但不修改
black --check .
```

#### 使用 flake8 检查代码

```bash
# 安装 flake8
pip install flake8

# 检查代码
flake8 .
```

配置 `setup.cfg`:

```ini
[flake8]
max-line-length = 100
exclude = migrations,venv,__pycache__,.git
ignore = E203,W503
```

#### 使用 isort 排序 import

```bash
# 安装 isort
pip install isort

# 排序 import
isort .
```

配置 `setup.cfg`:

```ini
[isort]
profile = black
line_length = 100
skip = migrations,venv
```

### 命名规范

#### 变量和函数

- 使用小写下划线: `user_profile`, `get_user_data()`
- 语义清晰，避免缩写

#### 类名

- 使用大驼峰: `UserProfile`, `UserStatistics`

#### 常量

- 使用大写下划线: `MAX_NICKNAME_LENGTH`, `DEFAULT_AVATAR_URL`

#### 私有变量/方法

- 使用单下划线前缀: `_internal_method()`, `_cache_key`

---

## Git 工作流

### 分支规范

- `main`: 主分支，生产环境代码
- `develop`: 开发分支，最新开发代码
- `feature/*`: 功能分支，如 `feature/user-profile`
- `bugfix/*`: 修复分支，如 `bugfix/nickname-validation`
- `hotfix/*`: 紧急修复，如 `hotfix/security-patch`

### 提交规范 (Conventional Commits)

```bash
# 格式
<type>(<scope>): <subject>

# 示例
feat(users): 添加用户资料更新接口
fix(statistics): 修复统计数据计算错误
docs(readme): 更新开发指南
refactor(services): 重构用户服务类
test(users): 添加用户模型单元测试
```

**Type 类型**:

- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构代码
- `test`: 添加测试
- `chore`: 构建工具或辅助工具变动

### 工作流程

```bash
# 1. 切换到 develop 分支
git checkout develop
git pull origin develop

# 2. 创建功能分支
git checkout -b feature/user-profile

# 3. 开发并提交
git add .
git commit -m "feat(users): 添加用户资料更新接口"

# 4. 推送到远程
git push origin feature/user-profile

# 5. 创建 Pull Request
# 在 GitHub/GitLab 上创建 PR，合并到 develop

# 6. 合并后删除本地分支
git checkout develop
git pull origin develop
git branch -d feature/user-profile
```

---

## 测试

### 单元测试

```python
# apps/users/tests/test_models.py
from django.test import TestCase
from apps.users.models import UserProfile

class UserProfileModelTest(TestCase):
    """用户资料模型测试"""

    def setUp(self):
        self.profile = UserProfile.objects.create(
            user_id=1,
            nickname='Alice',
            bio='Hello World'
        )

    def test_create_user_profile(self):
        """测试创建用户资料"""
        self.assertEqual(self.profile.nickname, 'Alice')
        self.assertEqual(self.profile.bio, 'Hello World')

    def test_str_method(self):
        """测试 __str__ 方法"""
        self.assertEqual(str(self.profile), 'Alice (1)')
```

### API 测试

```python
# apps/users/tests/test_views.py
from rest_framework.test import APITestCase
from rest_framework import status
from apps.users.models import UserProfile

class UserAPITest(APITestCase):
    """用户 API 测试"""

    def setUp(self):
        self.profile = UserProfile.objects.create(
            user_id=1,
            nickname='Alice'
        )

    def test_get_user_profile(self):
        """测试获取用户资料"""
        url = f'/api/users/{self.profile.user_id}/'
        response = self.client.get(url)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(response.data['nickname'], 'Alice')
```

### 运行测试

```bash
# 运行所有测试
python manage.py test

# 运行特定 app 的测试
python manage.py test apps.users

# 使用 pytest
pytest

# 生成覆盖率报告
coverage run --source='.' manage.py test
coverage report
coverage html
```

---

## 常见问题

### 1. 数据库连接错误

**问题**: `django.db.utils.OperationalError: could not connect to server`

**解决**:

```bash
# 检查 PostgreSQL 服务是否运行
sudo systemctl status postgresql

# 启动服务
sudo systemctl start postgresql

# 检查连接
psql -U open436 -d user_db -h localhost
```

### 2. Redis 连接错误

**问题**: `redis.exceptions.ConnectionError: Error 111 connecting to localhost:6379`

**解决**:

```bash
# 检查 Redis 服务
sudo systemctl status redis

# 启动服务
sudo systemctl start redis
```

### 3. 迁移冲突

**问题**: `Conflicting migrations detected`

**解决**:

```bash
# 删除冲突的迁移文件
rm apps/users/migrations/000X_conflicting.py

# 重新生成迁移
python manage.py makemigrations
```

### 4. 静态文件 404

**问题**: 开发环境静态文件无法访问

**解决**:

```bash
# 收集静态文件
python manage.py collectstatic --noinput
```

---

## 开发工具推荐

### IDE

- **PyCharm Professional** - 强大的 Django 支持
- **VS Code** + Python 插件

### VS Code 扩展

- Python
- Pylance
- Django
- GitLens
- Better Comments

### 浏览器插件

- **Postman** - API 测试
- **JSON Viewer** - JSON 格式化

---

**文档版本**: v1.0  
**创建日期**: 2025-10-27  
**最后更新**: 2025-10-27
