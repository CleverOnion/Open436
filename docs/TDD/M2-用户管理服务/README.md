# M2 - ç”¨æˆ·ç®¡ç†æœåŠ¡æŠ€æœ¯è®¾è®¡æ–‡æ¡£

## æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡ä»¶å¤¹åŒ…å« **M2 ç”¨æˆ·ç®¡ç†æœåŠ¡ (user-service)** çš„è¯¦ç»†æŠ€æœ¯è®¾è®¡æ–‡æ¡£ã€‚

**æœåŠ¡èŒè´£**: ç”¨æˆ·ä¸šåŠ¡ä¿¡æ¯ç®¡ç†ã€ä¸ªäººèµ„æ–™ã€ç”¨æˆ·ç»Ÿè®¡æ•°æ®ã€æ´»åŠ¨å†å²

**æŠ€æœ¯æ ˆ**: Python 3.11+ + Django 4.2+ + Django REST Framework + PostgreSQL

---

## ğŸ“š æ–‡æ¡£åˆ—è¡¨

| æ–‡æ¡£                                         | è¯´æ˜                                 | çŠ¶æ€      |
| -------------------------------------------- | ------------------------------------ | --------- |
| [00-å¼€å‘æŒ‡å—](./00-å¼€å‘æŒ‡å—.md)              | å¼€å‘ç¯å¢ƒæ­å»ºã€é¡¹ç›®ç»“æ„ã€å¼€å‘è§„èŒƒ     | âœ… å·²å®Œæˆ |
| [01-æ•°æ®åº“è®¾è®¡](./01-æ•°æ®åº“è®¾è®¡.md)          | æ•°æ®åº“è¡¨ç»“æ„ã€ç´¢å¼•ã€å…³ç³»è®¾è®¡         | âœ… å·²å®Œæˆ |
| [02-API æ¥å£è®¾è®¡](./02-APIæ¥å£è®¾è®¡.md)       | RESTful API è¯¦ç»†è®¾è®¡                 | âœ… å·²å®Œæˆ |
| [03-Django æ¨¡å‹è®¾è®¡](./03-Djangoæ¨¡å‹è®¾è®¡.md) | Django Modelsã€Serializersã€ViewSets | âœ… å·²å®Œæˆ |
| [04-ä¸ M1 æœåŠ¡é›†æˆ](./04-ä¸M1æœåŠ¡é›†æˆ.md)    | ç”¨æˆ·è´¦å·åˆ›å»ºæµç¨‹ã€æœåŠ¡é—´é€šä¿¡         | âœ… å·²å®Œæˆ |

---

## ğŸ¯ å¿«é€Ÿå¯¼èˆª

### æ–°å¼€å‘è€…å…¥é—¨

1. **é˜…è¯»å¼€å‘æŒ‡å—** - æ­å»ºå¼€å‘ç¯å¢ƒ
2. **é˜…è¯»æ•°æ®åº“è®¾è®¡** - äº†è§£æ•°æ®æ¨¡å‹
3. **é˜…è¯» Django æ¨¡å‹è®¾è®¡** - ç†è§£ ORM è®¾è®¡
4. **é˜…è¯» API æ¥å£è®¾è®¡** - äº†è§£å¯¹å¤–æ¥å£
5. **é˜…è¯»ä¸ M1 é›†æˆæ–¹æ¡ˆ** - ç†è§£æœåŠ¡åä½œ

### æ ¸å¿ƒæŠ€æœ¯æ ˆ

- **è¯­è¨€**: Python 3.11+
- **æ¡†æ¶**: Django 4.2+ (Django REST Framework 3.14+)
- **æ•°æ®åº“**: PostgreSQL 14+
- **ORM**: Django ORM
- **API æ–‡æ¡£**: drf-spectacular (OpenAPI 3.0)

---

## ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½

### ç”¨æˆ·èµ„æ–™ç®¡ç†

- âœ… æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯ï¼ˆèµ„æ–™ + ç»Ÿè®¡æ•°æ®ï¼‰
- âœ… ç¼–è¾‘ä¸ªäººèµ„æ–™ï¼ˆæ˜µç§°ã€å¤´åƒã€ç®€ä»‹ï¼‰
- âœ… æ˜µç§°ä¿®æ”¹é¢‘ç‡é™åˆ¶ï¼ˆ30 å¤©ä¸€æ¬¡ï¼‰
- âœ… å¤´åƒä¸Šä¼ ï¼ˆé›†æˆ M7 æ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼‰

### ç”¨æˆ·æ´»åŠ¨å†å²

- âœ… æŸ¥çœ‹ç”¨æˆ·å‘å¸–å†å²
- âœ… æŸ¥çœ‹ç”¨æˆ·å›å¤å†å²
- âœ… åˆ†é¡µæŸ¥è¯¢å’Œæ’åº

### ç”¨æˆ·ç»Ÿè®¡æ•°æ®

- âœ… å‘å¸–æ•°ç»Ÿè®¡
- âœ… å›å¤æ•°ç»Ÿè®¡
- âœ… è·èµæ•°ç»Ÿè®¡
- âœ… è·æ”¶è—æ•°ç»Ÿè®¡
- âœ… å®æ—¶æ›´æ–°ç»Ÿè®¡æ•°æ®

### ç®¡ç†å‘˜åŠŸèƒ½

- âœ… åˆ›å»ºç”¨æˆ·ï¼ˆé…åˆ M1 åˆ›å»ºè®¤è¯è´¦å·ï¼‰
- âœ… ç¼–è¾‘ç”¨æˆ·èµ„æ–™
- âœ… æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
- âœ… æœç´¢å’Œç­›é€‰ç”¨æˆ·

---

## ğŸ“Š æ•°æ®æ¨¡å‹æ¦‚è§ˆ

```
users_profile (ç”¨æˆ·èµ„æ–™è¡¨)
â”œâ”€â”€ user_id (ä¸»é”®ï¼Œå…³è” M1 çš„ users_auth.id)
â”œâ”€â”€ nickname (æ˜µç§°)
â”œâ”€â”€ avatar_url (å¤´åƒ URL)
â”œâ”€â”€ bio (ä¸ªäººç®€ä»‹)
â”œâ”€â”€ nickname_updated_at (æ˜µç§°æœ€åä¿®æ”¹æ—¶é—´)
â””â”€â”€ created_at, updated_at

user_statistics (ç”¨æˆ·ç»Ÿè®¡è¡¨)
â”œâ”€â”€ user_id (ä¸»é”®ï¼Œå¤–é”®)
â”œâ”€â”€ posts_count (å‘å¸–æ•°)
â”œâ”€â”€ replies_count (å›å¤æ•°)
â”œâ”€â”€ likes_received (è·èµæ•°)
â”œâ”€â”€ favorites_received (è·æ”¶è—æ•°)
â””â”€â”€ updated_at
```

---

## ğŸ”— æ¨¡å—ä¾èµ–å…³ç³»

### ä¾èµ–çš„æœåŠ¡

- **M1 è®¤è¯æˆæƒæœåŠ¡**: åˆ›å»ºç”¨æˆ·è´¦å·ã€éªŒè¯ç”¨æˆ·èº«ä»½
- **M7 æ–‡ä»¶å­˜å‚¨æœåŠ¡**: ä¸Šä¼ ç”¨æˆ·å¤´åƒ

### è¢«ä¾èµ–çš„æœåŠ¡

- **M3 å†…å®¹ç®¡ç†æœåŠ¡**: è°ƒç”¨è·å–ç”¨æˆ·ä¿¡æ¯
- **M4 äº’åŠ¨è¯„è®ºæœåŠ¡**: è°ƒç”¨è·å–ç”¨æˆ·ä¿¡æ¯ã€æ›´æ–°ç»Ÿè®¡æ•°æ®

---

## ğŸ“¡ æœåŠ¡é—´é€šä¿¡

### è°ƒç”¨ M1 æœåŠ¡

```python
# åˆ›å»ºç”¨æˆ·æ—¶ï¼Œå…ˆè°ƒç”¨ M1 åˆ›å»ºè®¤è¯è´¦å·
POST http://auth-service:8001/api/auth/users
{
    "username": "alice",
    "password": "password123",
    "role": "user"
}
```

### æä¾›ç»™å…¶ä»–æœåŠ¡çš„æ¥å£

```python
# M3ã€M4 è°ƒç”¨è·å–ç”¨æˆ·ä¿¡æ¯
GET http://user-service:8002/api/users/{user_id}

# M4 è°ƒç”¨æ›´æ–°ç»Ÿè®¡æ•°æ®
POST http://user-service:8002/internal/users/{user_id}/stats/increment
{
    "field": "posts_count",
    "value": 1
}
```

---

## ğŸ—‚ï¸ é¡¹ç›®ç»“æ„

```
user-service/
â”œâ”€â”€ manage.py                    # Django ç®¡ç†è„šæœ¬
â”œâ”€â”€ requirements.txt             # Python ä¾èµ–
â”œâ”€â”€ config/                      # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ settings.py             # Django è®¾ç½®
â”‚   â”œâ”€â”€ urls.py                 # å…¨å±€è·¯ç”±
â”‚   â””â”€â”€ wsgi.py
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ users/                  # ç”¨æˆ·ç®¡ç†åº”ç”¨
â”‚   â”‚   â”œâ”€â”€ models.py           # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ serializers.py      # DRF åºåˆ—åŒ–å™¨
â”‚   â”‚   â”œâ”€â”€ views.py            # è§†å›¾é›†
â”‚   â”‚   â”œâ”€â”€ urls.py             # è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ permissions.py      # æƒé™æ§åˆ¶
â”‚   â”‚   â”œâ”€â”€ services.py         # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ tasks.py            # å¼‚æ­¥ä»»åŠ¡
â”‚   â””â”€â”€ core/                   # æ ¸å¿ƒå·¥å…·
â”‚       â”œâ”€â”€ middleware.py       # ä¸­é—´ä»¶
â”‚       â”œâ”€â”€ exceptions.py       # å¼‚å¸¸å¤„ç†
â”‚       â””â”€â”€ utils.py            # å·¥å…·å‡½æ•°
â”œâ”€â”€ tests/                      # æµ‹è¯•
â”‚   â”œâ”€â”€ test_models.py
â”‚   â”œâ”€â”€ test_views.py
â”‚   â””â”€â”€ test_services.py
â””â”€â”€ docs/                       # API æ–‡æ¡£
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. é…ç½®æ•°æ®åº“

```bash
# ç¼–è¾‘ config/settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'user_db',
        'USER': 'open436',
        'PASSWORD': 'your_password',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}
```

### 3. æ‰§è¡Œè¿ç§»

```bash
python manage.py makemigrations
python manage.py migrate
```

### 4. åˆ›å»ºè¶…çº§ç”¨æˆ·

```bash
python manage.py createsuperuser
```

### 5. è¿è¡Œå¼€å‘æœåŠ¡å™¨

```bash
python manage.py runserver 8002
```

---

## ğŸ“– API æ–‡æ¡£

### è®¿é—® Swagger UI

```
http://localhost:8002/api/docs/
```

### è®¿é—® ReDoc

```
http://localhost:8002/api/redoc/
```

---

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
python manage.py test
```

### è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
python manage.py test apps.users.tests.test_models
```

### æµ‹è¯•è¦†ç›–ç‡

```bash
coverage run --source='.' manage.py test
coverage report
coverage html  # ç”Ÿæˆ HTML æŠ¥å‘Š
```

---

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

- ä½¿ç”¨ `select_related()` å’Œ `prefetch_related()` å‡å°‘æŸ¥è¯¢æ¬¡æ•°
- æ·»åŠ åˆé€‚çš„æ•°æ®åº“ç´¢å¼•
- ä½¿ç”¨ `only()` å’Œ `defer()` æ§åˆ¶æŸ¥è¯¢å­—æ®µ

---

## ğŸ“¦ éƒ¨ç½²

### Docker éƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t user-service:latest .

# è¿è¡Œå®¹å™¨
docker run -d \
  -p 8002:8002 \
  -e DATABASE_URL=postgresql://user:pass@db:5432/user_db \
  user-service:latest
```

### ä½¿ç”¨ docker-compose

```bash
docker-compose up -d
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [PRD - M2 ç”¨æˆ·ç®¡ç†æ¨¡å—](../../PRD/M2-ç”¨æˆ·ç®¡ç†æ¨¡å—.md)
- [å…¨å±€æ¶æ„è®¾è®¡](../00-å…¨å±€æ¶æ„/01-å…¨å±€æ¶æ„è®¾è®¡.md)
- [æœåŠ¡é—´é€šä¿¡è§„èŒƒ](../00-å…¨å±€æ¶æ„/03-æœåŠ¡é—´é€šä¿¡è§„èŒƒ.md)
- [Django å®˜æ–¹æ–‡æ¡£](https://docs.djangoproject.com/)
- [Django REST Framework æ–‡æ¡£](https://www.django-rest-framework.org/)

---

**æœåŠ¡ç«¯å£**: 8002  
**æŠ€æœ¯æ ˆ**: Python + Django + Django REST Framework + PostgreSQL  
**ä¼˜å…ˆçº§**: P0ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
