version: '3.8'

# ========================================
# Open436 Kong Gateway 完整部署
# ========================================
# 包含: Kong Gateway + PostgreSQL + Konga 管理界面
# ========================================

networks:
  kong-net:
    driver: bridge
  open436-net:
    driver: bridge

volumes:
  kong-db-data:
  kong-data:

services:
  # ========================================
  # Kong 数据库
  # ========================================
  kong-database:
    image: postgres:14-alpine
    container_name: kong-database
    environment:
      POSTGRES_USER: kong
      POSTGRES_DB: kong
      POSTGRES_PASSWORD: kong_password
    volumes:
      - kong-db-data:/var/lib/postgresql/data
    networks:
      - kong-net
    ports:
      - "5433:5432"  # 避免与主 PostgreSQL 冲突
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "kong"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ========================================
  # Kong 数据库迁移
  # ========================================
  kong-migration:
    image: kong:3.4
    container_name: kong-migration
    command: kong migrations bootstrap
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong_password
      KONG_PG_DATABASE: kong
    networks:
      - kong-net
    depends_on:
      kong-database:
        condition: service_healthy
    restart: on-failure

  # ========================================
  # Kong Gateway
  # ========================================
  kong:
    image: kong:3.4
    container_name: kong
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong_password
      KONG_PG_DATABASE: kong
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_URL: http://localhost:8002
      # 允许跨域访问 Admin API
      KONG_ADMIN_GUI_CORS_ORIGINS: "*"
    ports:
      - "8000:8000"   # HTTP 代理端口（客户端请求入口）
      - "8443:8443"   # HTTPS 代理端口
      - "8001:8001"   # Admin API（管理接口）
      - "8444:8444"   # Admin API HTTPS
    networks:
      - kong-net
      - open436-net
    depends_on:
      kong-database:
        condition: service_healthy
      kong-migration:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    volumes:
      - kong-data:/usr/local/kong/logs

  # ========================================
  # Konga - Kong 管理界面（可选）
  # ========================================
  konga:
    image: pantsel/konga:latest
    container_name: konga
    environment:
      NODE_ENV: production
      TOKEN_SECRET: konga_secret_token_12345
    ports:
      - "1337:1337"
    networks:
      - kong-net
    depends_on:
      - kong
    restart: unless-stopped

# ========================================
# 使用说明
# ========================================
# 1. 启动所有服务:
#    docker-compose up -d
#
# 2. 等待服务启动:
#    docker-compose ps
#
# 3. 访问 Kong Admin API:
#    curl http://localhost:8001
#
# 4. 访问 Konga 管理界面:
#    http://localhost:1337
#    首次访问需要创建管理员账号
#
# 5. 应用配置:
#    ./kong-config.sh
#    或
#    deck sync -s kong.yml
#
# 6. 查看日志:
#    docker-compose logs -f kong

